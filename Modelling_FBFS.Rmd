---
title: "Modelling Risk and Uncertainty in Flood-based Farming Systems using a Knowledge-based Approach."
author:
- name: Issoufou, Liman Harou
  email: 
    issoufoul@gmail.com;
    L.issoufou@cgiar.org
  affiliation: KU,ICRAF
  footnote: Corresponding Author
- name: Cory Whitney
  email: cory.whitney@uni-bonn.de
  affiliation: INRES
- name: James Kungu
  email: kungu.james@ku.ac.ke
  affiliation: KU
- name: Eike Luedeling
  email: luedeling@uni-bonn.de
  affiliation: INRES
address:
- address: Kenyatta University, Department of Environmental Sciences, P.O. Box 43844 00100 Nairobi, Kenya
  code: KU
- address: World Agroforestry Centre (ICRAF), United Nations Avenue, Gigiri, P.O. Box 30677-00100, Nairobi, Kenya
  code: ICRAF
- address: University of Bonn, Department of Horticultural Sciences, Auf dem Hügel 6, D-53121, Bonn, Germany
  code: INRES
- address: Center for Development research (ZEF), University of Bonn, Genscherallee 3, D-53113, Bonn, Germany
  code: ZEF
header-includes:
    - \usepackage{setspace}\setstretch{1.5}
bibliography: ./referencing_files/bibliographie.bib
csl: ./referencing_files/environmental-modelling-and-software.csl
note: Replication files are available on the author's Github account (http://github.com/Issoufou-Liman).
abstract: Crop models support agricultural decisions under various agricultural conditions. However, problems related to the scope of application, data availability, system complexity, or system-specific settings make many models applicable only with far-reaching and often questionable assumptions. In this paper, we used Decision Theory and participatory methods to address these challenges in a complex system where data and resources are limited. The resulting generic models is customizable and solution-oriented, and it accounts for all important variables and their interactions, as determined by local and foreign experts as well as relevant literature. We describe how such a probabilistic model can be developed and customized to specific situations based on case studies related to flood-based farming systems in Ethiopia and Kenya. Bayesian networks, describing stochastic system components, are used to generate inputs for a Monte Carlo model that simulates plausible ranges of expected grain and biomass yields at various stages of crop development.
Keywords: Flood-based farming systems, crop modelling, customized decision support tools, uncertainty, Bayesian Networks, Monte Carlo Simulation.
output:
  bookdown::pdf_book:
    base_format: rticles::elsevier_article
---

```{r, include=FALSE}
options(tinytex.engine = 'xelatex')
```

<!-- ```{r setup, include=FALSE} -->
<!-- knitr::opts_chunk$set(echo = TRUE,out.extra = '',fig.align='center',fig.pos='!htbp',cache=TRUE) -->
<!-- ``` -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,out.extra = '',fig.align='center',fig.pos='!h',cache=TRUE)
```

```{r Setting-the-Scene,include=FALSE,echo=FALSE,cache=FALSE}

set.seed(123)
###
install.packages('https://cran.r-project.org/src/contrib/Archive/gRain/gRain_1.3-0.tar.gz',repo=NULL,type = 'source')

### Installing devtools package to get decisionSupportExtra from github ####
if (!require("devtools")) {
  install.packages("devtools")
}

## Installing decisionSupportExtra and ggnomics packages from github ####
if (!require("decisionSupportExtra")) {
  devtools::install_github("Issoufou-Liman/decisionSupportExtra", build = TRUE, force = TRUE,
                           upgrade = "never", build_opts = c("--no-resave-data", "--no-manual"))

}

if (!require("ggnomics")) {
  devtools::install_github("teunbrand/ggnomics", build = TRUE, force = TRUE,
                           upgrade = "never", build_opts = c("--no-resave-data", "--no-manual"))
}


## loading required packages ####
if (!require("pacman")) install.packages("pacman")
pacman::p_load(bnlearn,
               Rgraphviz,
               ggplot2,
               grid,
               gridExtra,
               decisionSupport,
               fitdistrplus,
               rriskDistributions,
               scales,
               rgdal,
               raster,
               magick
)

## Loading decisionSupportExtra package ####
library(decisionSupportExtra)

## Loading the Bayesian network ####
source("source_files/BNs.R")

## removing objects that are no longer needed ####
rm(list=setdiff(ls(), "network_bn_fit"))

## A function responsable plotting the locol BNs
source("source_files/graphviz_chart_bn.R")

## some common plots specifications
legend_bg <- adjustcolor( "yellow", alpha.f = 0.15)
plots_lwd <- 0.5
min_plots_width_in <- 2.63
max_plots_width_in <- 7.5
max_plots_height_in <- 8.75
min_plots_res <- 300
plots_compression <- "lzw"
plots_font_family <- 'serif' # 'sans'
plots_font <- 1 # 2
plot_font_size <- 10

## exporting the plot to file.####
export_fun <- function(export, output_dir = "figures"){
  paste0(output_dir, '/', export, ".png")
}

my_theme <- theme_bw(base_size = plot_font_size, 
                     base_family = plots_font_family) +
  theme(
    # panel.grid.minor = element_blank(),
        # strip.background = element_blank(),
        legend.title = element_blank(),
        # remove facet spacing on x-direction
        panel.spacing = unit(0,"line"),
        
        panel.border = element_rect(fill=NA, size = 0.05),
        panel.grid.major = element_line(size = 0.05),
        panel.grid.minor = element_line(size = 0.02),
        axis.text.y = element_text(hjust = 0),
        axis.ticks = element_line(colour = 'black', size = 0.05),
        legend.position="top",
        legend.justification = 'right',
        strip.background = element_rect(fill='lightgoldenrodyellow', color = "gray", size = 0.075),
        strip.text = element_text(colour = 'black', face = 'bold'),
        strip.text.x = element_text(margin = margin(t=10, b = 10)),
        plot.title=element_text(size=10, face="bold", color="black", 
                                   margin=unit(c(0, 0, 0, 0), "pt")),
        plot.margin=unit(c(0, 0, 0, 0), "pt"),
        plot.subtitle=element_text(size=10, face="italic", color="black", 
                                   margin=unit(c(0, 0, 0, 0), "pt")))
ksource <- function(x, ...) {
  source(purl(x, output = tempfile()), ...)
}
```

# Software and data availability {-}

Data analysis was conducted using the R programming language  and contributed software packages of R [@R_Core_Team_2019]. R is freely available and can be obtained via https://cran.r-project.org/index.html. The installation of the contributed packages of R used should be automatic via the replication files accompanying the manuscript. Replication files, including code and data, are available on GitHub in two repositories. The core code is provided as R package describing the major functions developed during the preparation of the manuscript (https://github.com/Issoufou-Liman/decisionSupportExtra). The data along with additional code are provided as R markdown folder (see https://github.com/Issoufou-Liman/Modelling_FBFS).

#	Introduction {#ref1}

Crop models have proven useful for various science and policy applications [@Boote_et_al_1996; @Uusitalo_et_al_2015; @VanIttersum_et_al_2013], and quite a few crop models are now available for simulating agricultural production [@Murthy_2004]. While many of these models are fairly sophisticated, a few complications limit their broad applicability in supporting agricultural decisions. These complications mainly arise from a certain conflict between two distinct objectives of modelling: (1) summarize existing knowledge to formulate new research questions and (2) contribute actionable information to support real-life decisions aiming to produce desirable impacts [@Boote_et_al_1996; @Luedeling_and_Shepherd_2016; @Uusitalo_et_al_2015]. A model serving the purpose of knowledge generation does not necessarily have to fully capture the complexity of a system, but this is critically important for models aiming to provide realistic management advice [@Boote_et_al_1996; @Uusitalo_et_al_2015]. For models that strongly simplify complex systems, application beyond the originally intended scope can result in unrealistic projections [@Uusitalo_et_al_2015]. In agricultural settings where factors that are not represented in the model are important, this can easily result in unrealistic yield estimates [@Murthy_2004; @VanIttersum_et_al_2013].

A second limitation to the application of available crop modelling frameworks for decision support is their inability to work with imprecise or incomplete datasets [@Luedeling_and_Shepherd_2016]. Crop models usually operate in a deterministic manner, meaning that for each model variable or parameter they use a single precise input value [@Baroni_and_Tarantola_2014; @Uusitalo_et_al_2015]. This makes it difficult to adequately account for uncertainty [@Refsgaard_et_al_2007], which surrounds virtually all variables used in crop simulations. More importantly, the need for precise input data confronts agricultural modellers aiming to run simulations in new settings with the major challenge of acquiring such precise data [@Luedeling_et_al_2015]. In order to specify precise numbers with reasonable confidence, any crop simulation would ideally be preceded by an extensive data gathering exercise, including crop growth experiments [@Baroni_and_Tarantola_2014]. Since this is often unrealistic, especially where simulations are run with a regional or even global scope, crop modellers often make extensive assumptions about their input values [@Baroni_and_Tarantola_2014]. While the precise input values that are generated through these assumptions allow simulations to be run, they may have substantial impacts on the accuracy of model outputs [@Uusitalo_et_al_2015]. Model errors that result from such assumptions are virtually impossible to quantify, leading to considerable doubt that model outputs provide reliable guidance for agricultural decisions [@Luedeling_et_al_2015; @Luedeling_and_Shepherd_2016; @Uusitalo_et_al_2015; @Yet_et_al_2016].

The two challenges of complexity and data limitations highlight the need for new modelling approaches that accommodate system complexity and do not require perfect information. We argue that crop models should consider data uncertainty and find ways to include various types of data from a variety of sources. We propose a framework for meeting this challenge and demonstrate its usefulness by developing a flexible crop model for Flood-based Farming Systems.

##	Modelling flood-based farming systems	{#ref11}

Flood-based Farming Systems (FBFS) are rainfed agricultural systems found mostly in relatively low-lying areas that frequently experience flooding. While such floods are difficult to predict, they occur often enough – and are reliable enough – to allow farming systems that use this floodwater for irrigation, which substantially extends the productive scope of the respective areas. Due to the critical importance of floodwater, which often constitutes a vital resource for substantial numbers of small farms, water acquisition and sharing among farmers are generally governed by complex socio-institutional arrangements at various scales [@Haile_2010; @VanSteenbergen_et_al_2010]. In this context, floods are not considered natural hazards but simply manifestations of natural water fluctuation (e.g. periods of high rainfall or flood pulse in reservoirs), as described in the concept of flood pulse [@Junk_et_al_1989], or in the concept of Crue/Décrue [@Harlan_and_Pasquereau_1969]. Water management in FBFS takes advantage of water surplus related to flood events, which is then stored to allow extension of the natural growing period. 

Many authors [@Erkossa_et_al_2014; @FBLN_2018; @Harlan_and_Pasquereau_1969; @VanSteenbergen_et_al_2011a; @Van_den_Ham_2008] have stressed the importance of FBFS for rural livelihoods but also their inherent risks and uncertainty, which are mainly related to knowledge limitations regarding the timing, frequency and size of the flood pulse. These limitations make evidence-based management difficult [@VanSteenbergen_et_al_2010; @Van_den_Ham_2008]. The lack of information is partly due to the limited attention that FBFS receive in agricultural research and policy, which has restricted the build-up of expertise and comprehensive information on adequate management practices [@VanSteenbergen_et_al_2010; @VanSteenbergen_et_al_2011a]. So far, many engineering headworks tested under conventional irrigation with good results have failed when transferred to FBFS settings, as evidenced by multiple examples in the Oromia and Tigray regions of Ethiopia [@Erkossa_et_al_2014]. Furthermore, adequate procedures for risk assessment are largely unavailable for farmers, investors and donors, so that many shy away from investing in FBFS [@VanSteenbergen_et_al_2011a; @VanSteenbergen_et_al_2010]. This lack of investment has likely resulted in substantial loss of opportunities in many contexts. Still, FBFS can support rural livelihoods as evidenced in Dodota (Ethiopia) and Wadi  Laba  (Eritrea) spate irrigation (a variant of FBFS) systems, where harvests of twice as much as grain yield per unit area compared to rainfed agriculture have been reported [@Haile_2010; @Van_den_Ham_2008]. Such positive outcomes can, however, only materialize when the additional water is well distributed to cover shortages in rainfall. Inadequate flood management can result in waterlogging of soils or submergence of crops, with negative impacts on production [@Haile_2010; @VanSteenbergen_et_al_2010].

The many limitations of traditional modelling approaches applied to FBFS are exacerbated by socio-economic and management aspects that are crucial for system functioning. Models aiming to make predictions about FBFS must consider sediment management, hydraulic infrastructure and the various social rules set by the farmers. These aspects are absent from current crop models. Consequently, there is, to our knowledge, no crop model that is suitable for FBFS. The objective of this paper is to demonstrate how to develop a crop model for such complex agricultural systems with limited information and high uncertainty.

We applied methods from Decision Theory to simulate crop performance under FBFS with full consideration of production risks and inclusion of all available information and knowledge on important drivers of system behaviour. We used a mixed methods approach, incorporating both Bayesian Networks (BNs) and Monte Carlo (MC) models to develop a crop model that captures farmers’ realities and accounts for qualitative as well as quantitative information. The BNs were used to describe important qualitative processes, mostly related to farming constraints, such as the cropping systems and management options adopted by farmers. The MC models were used to describe the quantitative processes, such as biomass accumulation across crop development stages.

FBFS are used to showcase the methodology, but the concept is customizable to any other complex system. It is particularly suitable for solution-oriented research. Two study areas in Ethiopia and Kenya were selected as reference locations to produce a generic model that could be applied to many situations and contexts with minimal modifications. The two areas are assumed to cover much of the complexity (e.g. type of the biophysical system, agricultural management, social and institutional arrangements) found in FBFS. Data analysis was conducted using the R programming language [@R_Core_Team_2019] and software packages mentioned in the text are contributed packages of R. 

#	Study Area	{#ref2}

The study areas, Kisumu County in Kenya and the Tigray region in Ethiopia, are located within relatively low-lying regions (Figure \@ref(fig:fig1) a, b), making them prone to various types of floods. These regions differ substantially regarding system hydrology, management of agronomic flooding and other agricultural practices (Figure \@ref(fig:fig1) c, d, e). While FBFS in Kisumu are mainly fed by permanent reservoirs via inundation canals, those in Tigray mostly obtain water from ephemeral rivers, where farmers are required to divert important amounts of spate flow within a relatively short period of time (Figure \@ref(fig:fig1) e). Important differences in FBFS were captured in eight sample areas across Kisumu and Tigray (Figure \@ref(fig:fig1)):

* East and West Kano (Kisumu): two conventional irrigation schemes managed by the Kenyan National Irrigation Board, where water is obtained from River Nyando and Lake Victoria using large pumps. These locations were considered because they share many properties with FBFS while representing a special case of water acquisition.

```{r ggmaps-acquisition,echo=FALSE,eval=FALSE,include=FALSE}
# This chunk is not evaluated because google requires google api credentials see ?ggmap::register_google. Once a valid apikey is set, set eval to TRUE in this chunk to reproduce it. Otherwise we provide the ggmaps as rds files
source("source_files/ggmaps.R")
```

```{r fig1-plot,echo=FALSE,eval=TRUE,include=FALSE}
source("source_files/study_area_map.R")
```

```{r fig1, echo=FALSE,out.width='100%',fig.cap="Description of the sampling frame used to develop a mixed model of various flood-based farming practices in the Tigray region of Ethiopia and Kisumu County in Kenya. Agricultural practices are mainly homogeneous within study regions. The term 'out-growers' refers to farmers outside the scope of the Kenyan national irrigation board. Traditional flood water diversions are physical infrastructure, such as deflecting spurs or soil bunds that are constructed by farmers across flood channels using locally available materials. Modern diversion structures, such as diversion weirs, are usually designed by engineers and made of concrete. The improved diversion type constitutes an integration of farmer and engineer knowledge."}
knitr::include_graphics("figures/Modelling_FBFS_study_area.pdf")
```

* Ahero and Awach out-growers (Kisumu): here water is acquired via simple gravity from the Nyando and Awach Rivers. The main difference between these locations is that the Ahero out-growers scheme serves as safe disposal for excess water in East Kano.

* East Nyankach (Kisumu): in this location, water is collected via runoff and roof water harvesting. Typically, the collected water is stored in various household ponds and water tanks to later be used for irrigation. 

* Tsige’a, Harosha, and Dayu (Tigray): in these locations, farmers use improved, traditional, and modern floodwater diversions, respectively, to harness spate flow from various dry wadis.

The differences captured in these eight areas (Figure \@ref(fig:fig1) c, d, e) have implications for water supply, social organization, and crop development. For example, risks related to water supply may be more prominent in the out-growers’ schemes, which are exposed to water excess and shortages, compared to the schemes managed by the Kenyan national irrigation board, where the water supply is more regulated. While the water sources and acquisition procedures vary among rice-based systems in Kisumu (i.e. out-growers, East and West Kano), cultural practices are similar. In these areas, rice is sown (after tillage and flooding) in monoculture during floods, followed by various types of flood recession crops that are intercropped depending on farmers’ preferences and water availability (Figure \@ref(fig:fig1) c). In Tigray, in contrast, crops (mainly maize, sorghum and teff) are sown based on rainfall and are later irrigated using flood water (Figure \@ref(fig:fig1) d).

#	Methods	{#ref3}

##	Participatory model development {#ref31}

To describe crop performance within FBFS settings, we developed a mixed Bayesian Network / Monte Carlo model describing causal relationships deemed important for crop production in FBFS. We parameterized the model using various sources of information, including literature, online databases, expert knowledge elicitation, farmer and expert interviews and remote sensing [@Krueger_et_al_2012; @Refsgaard_et_al_2007]. To ensure quality in their estimations, experts were introduced to the principles of decision analysis and subjected to calibration training [@Hubbard_2014; @Luedeling_et_al_2015; @Whitney_Lanzanova_et_al_2018; @Whitney_Shepherd_et_al_2018].

```{tikz fig2-plot,echo=FALSE,include=FALSE,fig.path='figures/',fig.ext='pdf',cache=FALSE,engine.opts=list(engine='xetex', template="latex/tikz2pdf.tex")}

%% Beginning of Approach Overview %%%%

\begin{tikzpicture}[node distance=1mm and 10mm]

%%% Beginning of nodes layout %%%%

\node [ModelsStyle, ultra thick,  draw = RedBnsBulletsColor, fill = white] (BnsStar) {\textbf{Bayesian}\\ \textbf{Networks}\\ \textbf{engine}};

\node [ModelsStyle, ultra thick, draw = BlueMcBulletsColor, fill = white] (McsStar) [right=0.005cm of BnsStar] {\textbf{Monte}\\ \textbf{Carlo}\\ \textbf{engine}};

\begin{scope}[on background layer]
\node (ModelStartsBoxFrame) [BnsStyle, yscale=2, fit=(McsStar)(BnsStar)] {};
\end{scope}

\node [ApproachNodesStyle, align = center] (ImportantIssues)[left= of ModelStartsBoxFrame]{Identification of important issues and causality};

\node [ApproachNodesStyle] (ResearchQuestionsFirst)[below= of ImportantIssues]{Updates of research questions and objectives};

\node [ApproachNodesStyle] (ImportantIssuesRefinitionFirst)[below= of ResearchQuestionsFirst]{Refined list of important issues and causality};

\node [ApproachNodesStyle] (MetricsEstimationFirst)[below= of ImportantIssuesRefinitionFirst]{Estimation of metrics};

\node [ApproachNodesStyle] (ImportantIssuesRefinitionSecond)[below= of MetricsEstimationFirst]{Refined list of important issues and causality};

\node [ApproachNodesStyle] (MetricsEstimationSecond)[below= of ImportantIssuesRefinitionSecond]{Estimation of metrics};

\node [ApproachNodesStyle] (ResearchQuestionsSecond)[above= of ImportantIssues]{Updates of research questions and objectives};

\node [ApproachNodesStyle] (HighLevelConcepts)[above= of ResearchQuestionsSecond]{High level concepts of FBFS};

\node [ApproachNodesStyle] (PrimaryExperts)[above= of HighLevelConcepts]{Identification of primary experts};

\node [ApproachNodesStyle] (ResearchDrafting) [above= of PrimaryExperts] {Drafting of research questions and objectives};

\node [ApproachNodesStyle] (ConceptsDefinition)[above= of ResearchDrafting]{Concept definition};

\node [fill = McDomainColor, draw=McDomainColor] (ModelDevelopmentSequenceTopCheckPoint)[above= 0pt of ConceptsDefinition]{};

\node [fill = McDomainColor, draw=McDomainColor] (ModelDevelopmentSequenceBottomCheckPoint) [below= 0pt of MetricsEstimationSecond]{};

 \begin{scope}[on background layer]
\node (ModelDevelopmentSequence)[McBox, fit=(ModelDevelopmentSequenceTopCheckPoint)(ImportantIssues)(ResearchQuestionsFirst)(ImportantIssuesRefinitionFirst)(MetricsEstimationFirst)(ImportantIssuesRefinitionSecond)(MetricsEstimationSecond)(ResearchQuestionsSecond)(HighLevelConcepts)(PrimaryExperts)(ResearchDrafting)(ConceptsDefinition)(McsStar)(BnsStar)(ModelStartsBoxFrame)(ModelDevelopmentSequenceBottomCheckPoint)] {};
\end{scope}

\begin{scope}[on background layer]
\node (ModelStartsBoxFrame)[ellipse, draw=white, fill = white, inner sep = 0pt, fit=(McsStar)(BnsStar)] {};
\end{scope}

\tcbsetmacrotowidthofnode{\mywidth}{ModelDevelopmentSequence}

\node [ApproachTitlesStyle, text width=2*\NodeTextWidth] (ModelDevelopmentApproach)[above= of ModelDevelopmentSequence|-ModelDevelopmentSequenceTopCheckPoint, minimum width = \mywidth, text height = 1cm]{\textbf{Model development approach}};

\node [ApproachNodesStyle] (LiteratureReview)[left= of ResearchDrafting]{Literature review};

\node [draw=none] (FakeNode) at ($(ResearchQuestionsSecond)!0.5!(HighLevelConcepts)$) {};

\node [ApproachNodesStyle] (HighLevelDiscussions) at(FakeNode-|LiteratureReview) {High level discussions with experts};

\node [TransitionalNodesStyle] (LeadingQuestions2Experts) at ($(LiteratureReview)!0.5!(HighLevelDiscussions)$) {\itshape\uline{Leading questions to primary experts}};

\node [draw=none] (FakeNode) at ($(ResearchQuestionsFirst)!0.5!(ImportantIssues)$) {};

\node [ApproachNodesStyle] (FarmersFGD) at (FakeNode-|LiteratureReview) {Focus group discussions with farmers};

\node [TransitionalNodesStyle] (LeadingQuestions2Farmers) at ($(HighLevelDiscussions)!0.5!(FarmersFGD)$) {\itshape\uline{Leading questions to farmers}};

\node [draw=none] (FakeNode) at ($(ImportantIssuesRefinitionFirst)!0.5!(MetricsEstimationFirst)$) {};

\node [ApproachNodesStyle] (LocalExpertsMeetings) at (FakeNode-|LiteratureReview) {Local expert meetings};

\node [TransitionalNodesStyle] (Guidance2Expert) at ($(FarmersFGD)!0.5!(LocalExpertsMeetings)$) {\itshape\uline{Guidance and checklist for expert meetings}};

\node [draw=none] (FakeNode) at ($(ImportantIssuesRefinitionSecond)!0.5!(MetricsEstimationSecond)$) {};

\node [ApproachNodesStyle] (IndividualFarmerInterviews) at (FakeNode-|LiteratureReview) {Individual farmer interviews};

\node [TransitionalNodesStyle] (Guidance2Farmers) at ($(LocalExpertsMeetings)!0.5!(IndividualFarmerInterviews)$) {\itshape\uline{Guidance and checklist for farmer interviews}}; 

\node [fill = BnsDomainColor, draw=BnsDomainColor] (DataCollectionSequenceTopCheckPoint) at (ModelDevelopmentSequenceTopCheckPoint-|LiteratureReview){};

\node [fill = BnsDomainColor, draw=BnsDomainColor](DataCollectionSequenceBottomCheckPoint) at (ModelDevelopmentSequenceBottomCheckPoint-|LiteratureReview){};

\tcbsetmacrotoheightofnode{\myheight}{ModelDevelopmentSequence}

\begin{scope}[on background layer]
\node (DataCollectionSequence)[BnsBox, minimum height = \myheight, fit=(DataCollectionSequenceTopCheckPoint)(LiteratureReview)(HighLevelDiscussions)(LeadingQuestions2Experts)(FarmersFGD)(LeadingQuestions2Farmers)(LocalExpertsMeetings)(Guidance2Expert)(Guidance2Farmers)(IndividualFarmerInterviews)(DataCollectionSequenceBottomCheckPoint)] {};
\end{scope}

\tcbsetmacrotowidthofnode{\mywidth}{DataCollectionSequence}

\node [ApproachTitlesStyle, text width=2*\NodeTextWidth] (DataCollectionApproach)[above= of DataCollectionSequence|-DataCollectionSequenceTopCheckPoint, minimum width = \mywidth, text height = 1cm]{\textbf{Data collection approach}};

% \node [draw = black, fill=black] (ClipCheckFirst) at (DataCollectionSequenceBottomCheckPoint-|DataCollectionApproach.west) {};

% \node [draw = black, fill=black] (ClipCheckSecond) at (ModelDevelopmentApproach.east){};

% \clip (ClipCheckFirst) rectangle (ClipCheckSecond){};

% \draw (DataCollectionSequence.south west) rectangle (ModelDevelopmentSequence.north east);

% \draw (ClipCheckFirst) rectangle (ClipCheckSecond){};



% \draw (ClipCheckFirst.south east) rectangle (ClipCheckSecond.north west);

%%% End of nodes layout %%%%

%%% Beginning of arrows layout %%%%

\draw[thickarrow] (ImportantIssues.east) -- (ModelStartsBoxFrame);
\draw[thickarrow] (ResearchQuestionsFirst.east) -- (ModelStartsBoxFrame);
\draw[thickarrow] (ImportantIssuesRefinitionFirst.east) -- (ModelStartsBoxFrame);
\draw[thickarrow] (MetricsEstimationFirst.east) -- (ModelStartsBoxFrame);
\draw[thickarrow] (ImportantIssuesRefinitionSecond.east) -- (ModelStartsBoxFrame);
\draw[thickarrow] (MetricsEstimationSecond.east) -- (ModelStartsBoxFrame);
\draw[thickarrow] (ResearchQuestionsSecond.east) -- (ModelStartsBoxFrame);
\draw[thickarrow] (HighLevelConcepts.east) -- (ModelStartsBoxFrame);
\draw[thickarrow] (PrimaryExperts.east) -- (ModelStartsBoxFrame);
\draw[thickarrow] (ResearchDrafting.east) -- (ModelStartsBoxFrame);
\draw[thickarrow] (ConceptsDefinition.east) -- (ModelStartsBoxFrame);

\draw[thickarrow] (IndividualFarmerInterviews.east) -- (ImportantIssuesRefinitionSecond.west);
\draw[thickarrow] (IndividualFarmerInterviews.east) -- (MetricsEstimationSecond.west);
\draw[thickarrow] (HighLevelDiscussions.east) -- (ResearchQuestionsSecond.west);
\draw[thickarrow] (HighLevelDiscussions.east)-- (HighLevelConcepts.west);
\draw[thickarrow] (FarmersFGD.east) -- (ResearchQuestionsFirst.west);
\draw[thickarrow] (FarmersFGD.east) -- (ImportantIssues.west);
\draw[thickarrow] (LocalExpertsMeetings.east) -- (ImportantIssuesRefinitionFirst.west);
\draw[thickarrow] (LocalExpertsMeetings.east) -- (MetricsEstimationFirst.west);

\draw[thickarrow] (LiteratureReview.east) -- (ConceptsDefinition.west);
\draw[thickarrow] (LiteratureReview.east) -- (ResearchDrafting.west);
\draw[thickarrow] (LiteratureReview.east) -- (PrimaryExperts.west);

\draw[thickarrow] ([xshift=3mm]LiteratureReview.south west) -- ([xshift=3mm]HighLevelDiscussions.north west);
\draw[thickarrow] ([xshift=3mm]HighLevelDiscussions.south west) -- ([xshift=3mm]FarmersFGD.north west);
\draw[thickarrow] ([xshift=3mm]FarmersFGD.south west) -- ([xshift=3mm]LocalExpertsMeetings.north west);
\draw[thickarrow] ([xshift=3mm]LocalExpertsMeetings.south west) -- ([xshift=3mm]IndividualFarmerInterviews.north west);

%%% End of nodes layout %%%%

\draw [ultra thick, lightgray](current bounding box.north west) rectangle (current bounding box.south east);

\end{tikzpicture}

%% End of Approach Overview %%%%

```

```{r fig2,echo=FALSE,out.width='100%',fig.cap="Overview of the approach used to develop a crop model for flood-based farming systems in the Tigray region of Ethiopia and Kisumu County in Kenya."}
knitr::include_graphics("figures/fig2-plot-1.pdf")
```

The model development process consisted of five sequential steps with specific milestones (Figure \@ref(fig:fig2)) aiming to develop theories that match farmers’ realities:


1. Literature review to understand the issue and design broad leading questions to primary experts (experts from various academic and research institutions working with FBFS and related fields).

2.	High-level discussions with 11 primary experts aiming to develop a general understanding of important FBFS concepts.

3.	Discussions with 20 focus groups in Ahero and Kisumu towns (Kenya) in December 2016 and June 2017 and in Mekelle and Alamata towns (Ethiopia) in December 2016 and January 2017.

4.	Consultation with local experts to formalize the model. The pool of local experts, initially represented by local farmers and extension civil servants, was extended to include the participants of a leadership course in flood-based farming and water harvesting in Kenya and the participants of the International Training Course on Integrated Watershed Management and FBFS in Ethiopia [@FBLN_2018].

5.	Interviews with 159 farmers to capture farmers’ realities in the model.

The experts were selected based on their relevant and extensive experience regarding the practice of FBFS [@Krueger_et_al_2012]. The information acquired in the first four steps was made available to the local experts to formalize the model. Qualitative variables were interlinked using BNs, whereas the quantitative ones were connected using MC models (Figure \@ref(fig:fig2); Figure \@ref(fig:fig3)). The BNs and MC models were connected to form generic models that account for the variability of the FBFS schemes in each study region. These models were further merged into a single generic model that captures the variability in the study regions. Our goal was to develop a detailed description of the system by breaking down the system complexity into all important processes (see section \@ref(ref34)) while highlighting risk factors that influence crop production and fully accounting for data uncertainty [@Refsgaard_et_al_2007; @Van_den_Ham_2008].

##	Models for quantitative variables {#ref32}

An MC simulation is a quantitative procedure used to estimate the values of continuous variables. Its centrepiece is a deterministic mathematical equation that contains one or more input variables, whose values are expressed as probability distributions. Outputs are generated by drawing many sets of random values from these distributions and using these to parameterize the central equation. The population of outputs across the whole set of calculations expresses a reasonable estimate of uncertainty around the value of the target output variable [@Luedeling_et_al_2015; @Refsgaard_et_al_2007; @Rosenstock_et_al_2014].

MC models were used to describe quantitative biomass accumulation during crop development and the conversion of this biomass into grain. The MC expert system is based on the concept of yield potential, which is the theoretical yield limit of a variety grown under optimal conditions [@VanIttersum_et_al_2013]. Since achieving the full yield potential is unrealistic, the MC models considered the exploitable yield potential as the fraction of yield potential (70 – 80%) that could potentially be achieved by farmers under ideal conditions. Since such ideal conditions are not encountered in most places, the models considered the attainable yield potential to account for the systemic constraints encountered on farms. Finally, the expected actual yield was determined as the yield expectation given a farmer’s management conditions [@VanIttersum_et_al_2013]. The models involving deterministic relationships between these yield metrics were used for MC simulations. 

##	Models for qualitative variables {#ref33}

 BNs are multivariate cause-effect models suitable for conditional reasoning across variables with multiple qualitative states. They can be used to specify the probabilities of the states of unknown discrete variables, conditional on the probabilities of the states of other variables. These conditional probabilities express causal relationships between the discrete variables [@Jensen_1996; @Pearl_1988]. BNs are composed of logical connections (directed edges) between variables (nodes), which are arranged in probabilistic graphical models. Dependencies are represented by arrows (arcs) encoding the direction and nature (i.e. direct or indirect) of the causal relationships [@Pearl_1988]. A node describes the states of a variable (node states), with a variable at the arrowhead (child node) being influenced by the variable at the arrow tail (parent node). The strength of the influence is portrayed by the conditional probabilities typically specified as stochastic matrices known as conditional probability tables (CPTs), which are the central elements of BNs [@Fenton_and_Neil_2013; @Jensen_1996; @Pearl_1988]. They portray the strength of the association between all states of a child node and the various states of its parents [@Hansson_and_Sjokvist_2013; @Scutari_and_Denis_2015].

The BNs developed by the local experts detailed complex causalities defining one important variable: the ‘farming constraints’ factor, which accounts for the combined effects of all limiting factors. The BN expert systems are based on the idea that system functions are driven by various biotic and abiotic factors that depend on management practices [@Jax_and_Setala_2005]. These profile a given farmland in terms of farming constraints and performance. The effects of farming constraints were defined at plot level with implications for farming systems. The ‘farming constraints’  variable was produced with the help of BNs to summarize qualitative expert knowledge for use in quantitative MC simulations.

##	Modularity and system complexity {#ref34}

The generic model encapsulates the complexity of the farming system in four levels of abstractions embedded in the BN and MC models:

1. Recognition of individual processes defining system performance: This was done in plenary sessions during workshops, where the important processes were identified and formulated as separate modules based on the assumption that farming constraints affect crop development on any given plot. The farming constraints variable was estimated via the BNs using three modules: the soil water, the cropping system and the management modules. These processes were described through causal chains describing resource allocation (e.g. available soil water or available soil nutrients) within the system. Crop development, in turn, was assessed via the MC model using a single module, the crop growth module. In most cases, these complex processes were described in terms of their corresponding sub-processes (as sub-modules) to facilitate the description of the main process.

2. Disaggregation of the processes into individual variables (e.g. rainfall occurrence or manure application): This was done in working groups with the aim of identifying important variables and interfaces for shared connections between the processes.

3.	Description of the variables: This was also done in working groups with the aim of defining the relationships between variables and estimating their values. Quantitative variables were estimated as continuous probability distributions. Qualitative variables were disaggregated into their respective states (e.g. it rains or it does not, manure is either applied or it is not), for which state probabilities were estimated as CPTs (see section \@ref(ref35)). The variability among system processes across farmlands is considered to imply differences in the states of variables modulating them. The full BN and MC models describing these are provided in the technical and supplementary materials.

4. Separation of crop development into critical stages: Crop development stages were defined from the onset of the cropping season to 10% ground cover as initial stage, from 10% ground cover to effective full cover as the development stage, from effective full cover to the start of maturity as the mid stage, and from the start of maturity to harvest or full senescence as the late stage  [@Allen_et_al_1998]. A biomass expansion factor, measuring crop growth, was considered to control the crop growth at each of these stages. This way, crops would not arbitrarily grow beyond the actual yield expectations. Crop yield was assumed to follow a negatively skewed gamma distribution [@Gallagher_1987; @Ramirez_et_al_2003], meaning that there is a high chance of low yield and relatively low chance of high yield. Four crops – rice, maize, sorghum and teff – were considered due to their importance in the study areas.

##	Modelling interface {#ref35}

The make_CPT function from the decisionSupport package in R was used to facilitate the estimation of the CPTs [@Luedeling_Goehring_et_al_2019]. To create the full CPT, the function requires the prior probability distribution of the child node, the child node’s sensitivity relative to the parents, the parents’ effects, and the weight of influence of each parent [@Luedeling_Goehring_et_al_2019]. These parameters were estimated by the experts [@Hansson_and_Sjokvist_2013; @Whitney_Shepherd_et_al_2018]. The make_CPT routines were automated and interfaced with the cptable function from the gRain package [@Hojsgaard_2012] to formalise the BNs in computer-readable graphical models following the experts’ causal reasoning.  

While BNs are ideal for specifying complex levels of hierarchy and categorization as cause-effect relationships, they provide a convenient interface for studying simple aspects based on the states of different variables and their causal linkages. Based on the different combinations of the states of its parents, the probabilities of the ‘farming constraint’ node were generated by sampling from the posterior distributions of the BNs. This is equivalent to generating all possible farming constraint scenarios based on the BN models. Technically, we used MC particle filters [@Kitagawa_1996; @Koller_and_Friedman_2009; @Scutari_2010] to generate the probabilities of farming constraints conditional on different combinations of the states of variables involved in the BNs. The effects of the different states of the variable were assumed to range between 0 and 1, where 0 denotes ideal conditions (exploitable yield potential) and 1 the worst-case scenario (total loss). The variable was used as special node in the MC model as expected loss ratio, accounting for both the effects of the variable states and their probability of occurrence (Figure \@ref(fig:fig3)).

```{tikz fig3-plot,echo=FALSE,include=FALSE,eval=TRUE,fig.path='figures/',fig.ext='pdf',cache=FALSE,eval=TRUE,engine.opts=list(engine='xetex',template="latex/tikz2pdf.tex")}
%% Beginning of Conceptual framework %%%%

\begin{tikzpicture}[node distance=0.5cm]

%%% Beginning of nodes layout %%%%

\begin{scope}[FitnodesStyle]

\node [McStyleSub, text width=5.5cm] (QuantitativeFarmlandProfileSub) {
  \begin{varwidth}{\textwidth}
  \begin {BlackBnsBullets}
  \item  available flood
  \item  available soil water
  \item  available soil nutrients
  \item  farming efficiency
  \item  pest / disease impact
  \item  etc.
  \end {BlackBnsBullets}
  \end{varwidth}
};

\node [McStyle] (QuantitativeFarmlandProfileSup)[ above=of QuantitativeFarmlandProfileSub] {
  \begin{varwidth}{\textwidth}
  \begin{center}
  Quantitative farmland profile
  \end{center}
  \begin {BlackMcBullets}
  \item  farming constraints
  \end {BlackMcBullets}
  \end{varwidth}
};

\node (QuantitativeFarmlandProfile) [draw,fit=(QuantitativeFarmlandProfileSup) (QuantitativeFarmlandProfileSub)] {};

\tcbsetmacrotowidthofnode{\mywidth}{QuantitativeFarmlandProfileSub}
% \tcbsetmacrotoheightofnode{\myheight}{QuantitativeFarmlandProfileSub}

% \draw [BraceStyle]
%        ($(QuantitativeFarmlandProfileSub.north west)+(\mywidth pt, 0pt)$) -- ($(QuantitativeFarmlandProfileSub.north east)+(-\mywidth pt, 0pt)$);

\draw[BraceStyle] (QuantitativeFarmlandProfileSub.north west) -- (QuantitativeFarmlandProfileSub.north east);


\end{scope}

\node (McDomainSubNodes)[above=of QuantitativeFarmlandProfile, text centered,
                         align=center, fill=white, draw=white] {MC modelling domain};

\node [draw=none, fill=none] (PlaceModelOutput) at (QuantitativeFarmlandProfileSub.east){};

\node [McStyle, text width=6.7cm] (ModelOutput) [below right= of PlaceModelOutput] {
  \begin{varwidth}{\textwidth}
  \begin{center}
  Quantitative model output for qualitative states
  \end{center}
  \begin {BlackMcBullets}
  \item  actual yield (biomass, grain)
  \item exploitable yield gap
  \item expected actual yield
  \item etc.
  \end {BlackMcBullets}
  \end{varwidth}
};

\tcbsetmacrotowidthofnode{\mywidth}{ModelOutput}
% \tcbsetmacrotoheightofnode{\myheight}{QuantitativeFarmlandProfile}

\node [McStyle, minimum width = \mywidth, text width=6.7cm] (HistoricalYield) at (QuantitativeFarmlandProfileSup.east-|ModelOutput) {
  \begin{varwidth}{\textwidth}
  \begin{center}
  Historical quantitative yield metrics
  \end{center}
  \begin {BlackMcBullets}
  \item  yield potential
  \item attainable yield potential
  \item average actual yield
  \item etc.
  \end {BlackMcBullets}
  \end{varwidth}
};

\node [McStyle, minimum width=6cm, text width = 3cm, draw=none, fill=none] (SamplingEngine) [left=of QuantitativeFarmlandProfile, text centered]{};

\node [text centered,
       align=center, fill=white, draw=white] (ModellingInterfaceDomainSubNodes) at (SamplingEngine|-McDomainSubNodes) {Modelling interface};

\begin{scope}[FitnodesStyle]

\node [McStyle, text width=5.5cm] (QualitativeFarmlandProfileSub)[left=of SamplingEngine, align = left] {
  \begin{varwidth}{\textwidth}
  \begin{center}
  Qualitative farmland profile
  \end{center}
  \begin {BlackMcBullets}
  \item  water supply adequacy
  \item management efficiency
  \item cropping system
  \end {BlackMcBullets}
  \end{varwidth}
};

\tcbsetmacrotowidthofnode{\mywidth}{QualitativeFarmlandProfileSub}
% \tcbsetmacrotoheightofnode{\myheight}{QualitativeFarmlandProfileSub}

% \draw [BraceStyle]
%        ($(QualitativeFarmlandProfileSub.south east)+(\mywidth pt, 0pt)$) -- ($(QualitativeFarmlandProfileSub.south west)+(-\mywidth pt, 0pt)$);

\draw[BraceStyle] (QualitativeFarmlandProfileSub.south east) -- (QualitativeFarmlandProfileSub.south west);

\node [McStyleSub] (ConstraintChance) [below=of QualitativeFarmlandProfileSub]{
  \begin{center}
  Chance of farming constraints
  \end{center}
};

\node (QualitativeFarmlandProfile)[draw,fit=(QualitativeFarmlandProfileSub) (ConstraintChance)] {};

\end{scope}

\node [BnsStyle, text width=5.28cm] (FarmManagement)[left=of QualitativeFarmlandProfile] {
  \begin{varwidth}{\textwidth}
  \begin{center}
  Farm management
  \end{center}
  \begin {BlackBnsBullets}
  \item water management BN
  \item management BN
  \item etc.
  \end {BlackBnsBullets}
  \end{varwidth}
};


\node [BnsStyle, text width=4.4cm] (BioticFactors) [above=of FarmManagement] {
  \begin{varwidth}{\textwidth}
  \begin{center}
  Biotic factors
  \end{center}
  \begin {BlackBnsBullets}
  \item pest / disease BN
  \item crop BN
  \item etc.
  \end {BlackBnsBullets}
  \end{varwidth}
};

\tcbsetmacrotowidthofnode{\mywidth}{BioticFactors}
\tcbsetmacrotoheightofnode{\myheight}{BioticFactors}

\node [BnsStyle, text width=4.4cm, minimum height = \myheight] (AbioticFactors)[below=of FarmManagement] {
  \begin{varwidth}{\textwidth}
  \begin{center}
  Abiotic Factors
  \end{center}
  \begin {BlackBnsBullets}
  \item climate BN
  \item soil BN
  \item etc.
  \end {BlackBnsBullets}
  \end{varwidth}
};



\node [text centered,
       align=center, fill=white, draw=white] (BnsDomainSubNodes) at (QualitativeFarmlandProfile|-ModellingInterfaceDomainSubNodes) {BN modelling domain};

\node [fill=none, draw=none] (BnsDomainTopCheckPoint) at (BioticFactors.north) {};

\node [fill=none, draw=none] (BnsDomainBottomCheckPoint) at (AbioticFactors.south) {};

\node [fill=none, draw=none] (BnsDomainLeftCheckPoint) [left=0pt of FarmManagement] {};

\node [fill=ModellingInterfaceDomainColor, draw=ModellingInterfaceDomainColor] (ModellingInterfaceDomainTopCheckPoint) at (BnsDomainTopCheckPoint-|ModellingInterfaceDomainSubNodes) {};

\node [fill=ModellingInterfaceDomainColor, draw=ModellingInterfaceDomainColor] (ModellingInterfaceDomainBottomCheckPoint) at (BnsDomainBottomCheckPoint-|ModellingInterfaceDomainSubNodes) {};

\node [fill=McDomainColor, draw=McDomainColor] (MCDomainTopCheckPoint) at (ModellingInterfaceDomainTopCheckPoint-|McDomainSubNodes) {};

\node [fill=McDomainColor, draw=McDomainColor] (MCDomainBottomCheckPoint) at (ModellingInterfaceDomainBottomCheckPoint-|McDomainSubNodes) {};

\begin{scope}[on background layer]
\node (McBoxFrame)[McBox,fit=(MCDomainTopCheckPoint)(McDomainSubNodes)(QuantitativeFarmlandProfile)(HistoricalYield) (ModelOutput)(MCDomainBottomCheckPoint)] {};
\end{scope}

\begin{scope}[on background layer]
\node (ModellingInterfaceBoxFrame)[ModellingInterfaceBox, fit=(ModellingInterfaceDomainTopCheckPoint)(ModellingInterfaceDomainSubNodes)(SamplingEngine)(ModellingInterfaceDomainBottomCheckPoint)][left=0cm of McBoxFrame] {};
\end{scope}

\begin{scope}[on background layer]
\node (BnsInterfaceBoxFrame)[BnsBox,fit=(BnsDomainTopCheckPoint)(BnsDomainSubNodes)(BioticFactors)(FarmManagement)(AbioticFactors)(QualitativeFarmlandProfile) (ConstraintChance)(BnsDomainBottomCheckPoint)(BnsDomainLeftCheckPoint)] [left=0cm of ModellingInterfaceBoxFrame] {};
\end{scope}


%%% End of nodes layout %%%%
%%% Beginning of arrows layout %%%%

\draw[dashes] (BnsDomainSubNodes) -- (ModellingInterfaceDomainSubNodes);
\draw[dashedarrow] (ModellingInterfaceDomainSubNodes) -- (McDomainSubNodes);
\draw[thickarrow] (BioticFactors) -- (QualitativeFarmlandProfile);
\draw[thickarrow] (AbioticFactors) -- (QualitativeFarmlandProfile);
\draw[thickarrow] (FarmManagement) -- (QualitativeFarmlandProfile);
\draw[dashedarrow] (QualitativeFarmlandProfileSub) -- (QuantitativeFarmlandProfile);
%\draw[dashedarrow] (SamplingEngine) -- (QuantitativeFarmlandProfile);
\draw[thickes] (QuantitativeFarmlandProfile.south) -- ([yshift=1cm]QuantitativeFarmlandProfile|-ModelOutput.south);

% This is a hack which may not work with scaling
\shadedraw [decoration=Koch snowflake, top color=BnsDomainColor, bottom color=McDomainColor, draw=white] decorate{decorate{ decorate{ decorate{ decorate{ decorate{
  ([yshift=-1mm]QualitativeFarmlandProfile-|ModellingInterfaceDomainSubNodes.west) -- ++(60:4.2)  -- ++(300:4.2) -- ++(180:4.2)}}}}}};

\node [McStyle, minimum width=6cm, text width = 3cm, text=black, draw=none, fill=none] (SamplingEngine) [left=of QuantitativeFarmlandProfile, text centered]{\huge Random sampling engine};

\draw[thickarrow] ([yshift=1cm]QuantitativeFarmlandProfile|-ModelOutput.south) -- ([yshift=1cm]ModelOutput.south west);
\draw[thickarrow] (HistoricalYield) -- (ModelOutput);
\draw [ultra thick, lightgray](current bounding box.north west) rectangle (current bounding box.south east);
%%% End of arrows layout %%%%

\end{tikzpicture}

%% End of Conceptual framework %%%%

```

```{r fig3, echo=FALSE,out.width='100%',fig.cap="Conceptual framework of important processes considered in the development of a crop model for flood-based farming systems in the Tigray region of Ethiopia and Kisumu County in Kenya."}
knitr::include_graphics("figures/fig3-plot-1.pdf")
```

A combination of MC and BN models is ideal for specifying complex deterministic and cause-effect relationships while enabling the use of data and information that are not necessarily precise. These modelling approaches can produce reliable advice that makes full use of the current state of information and adequately expresses all uncertainties in such a way that outcomes and risks of a given decision can be appreciated. While the MC expert system was set to simulate the various yield metrics (Figure \@ref(fig:fig3)) ranging from the maximum possible yield to what farmers actually achieve [@VanIttersum_et_al_2013], the BNs were programmed to provide the shape of the probability distributions of the variable ‘farming constraint’ (Figure \@ref(fig:fig3)), as well as its 90% confidence interval and median values. This was done at each of the four crop development stages to account for the variability of farming constraints over the growing season and the biomass accumulation over time.

Note that the probability distributions of the node ‘farming constraints’ were determined based on reasonable bounds for skewness and kurtosis defined via visual observations supported by bootstrapping [@Delignette-Muller_and_Dutang_2015]. We fitted several candidate distributions using the fitdist function from the fitdistrplus package [@Delignette-Muller_and_Dutang_2015], from which we chose the best-fitting distribution. In the supplementary materials, we show examples of Cullen and Frey graphs, quantile and probability plots along with the theoretical and empirical density and cumulative distribution functions used to facilitate the choice of the distributions. Note also that the remaining parameters required by decisionSupport’s mcSimulation function [@Luedeling_Goehring_et_al_2019], which was used to conduct the MC simulation, were computed from the fitted distribution using the fitdist function and other facilities provided by the rriskDistributions package [@Belgorodski_et_al_2017].

##	Inputs, outputs and special models {#ref36}

The generic model was used to demonstrate the flexibility of the approach and the importance of modularity in customizing model behaviour for specific situations. The results of the specific models were used to present the different modules and their throughputs using three case studies of varying complexity:

1.	The assessment of soil water using the soil water module looks at the challenge of maximizing water storage in soils, while limiting waterlogging and restricting water losses through evaporation, run-off or percolation in FBFS. We show how the model can be customized to prescribe optimum pre-season cultural practices for improved soil water on specific soil types.

2.	The probabilistic assessment of crop biomass uses the crop growth module to show the model’s suitability as monitoring tool for biomass accumulation over the growing season.

3.	The study of the impact of soil water and biotic stresses (e.g. pest, diseases and weeds) shows the effects of these on the grain yield of rice and sorghum, integrating use of all four model modules.

Inputs consisted of scenarios that were formulated based on child-parent state relationships. Outputs are the probability of adequate soil water, biomass and grain yield, respectively. The rationale and methodology of each of these case studies are provided in the supplementary materials.

#	Results	{#ref4}

## Overview of the Conceptual Model {#ref41}

The generic model (overview in Figure \@ref(fig:fig4)) interlinking the four modules that describe the important processes at plot level is composed of 121 nodes in the BNs and 21 nodes in the MC model. The full model is provided as reproducible code in the technical materials. Customized instances showing the usefulness and usability of the approach are presented in the following sections to demonstrate the functioning of the model. The four modules represent individual processes describing the soil water, the cropping system, farm management, and the crop growth, which are linked by various connectors (Figure \@ref(fig:fig4)). 

```{tikz fig4-plot,echo=FALSE,eval=TRUE,include=FALSE,fig.path='figures/',fig.ext='pdf',cache=FALSE,eval=TRUE,engine.opts=list(engine='xetex',template="latex/tikz2pdf.tex")}

%% Beginning of Overview Detailed Model %%%%

\begin{tikzpicture}[node distance = 0.5cm]

\node[BnsMultipartStyle] (UpStreamInfluence){
\nodepart{one}
On and off-site influence
\nodepart{two}
\begin{varwidth}{\textwidth}
  \begin {BlackBnsBullets}
  \item upstream abstraction
  \item rainfall occurrence
  \end {BlackBnsBullets}
  \end{varwidth}
};

\node[BnsMultipartStyle] (FarmerNegotiations)[right= of UpStreamInfluence]{
\nodepart{one}
Farmer negotiations
\nodepart{two}
\begin{varwidth}{\textwidth}
  \begin {BlackBnsBullets}
  \item institutional arrangements
  \item infrastructure maintenance
  \end {BlackBnsBullets}
  \end{varwidth}
};

\node[BnsMultipartStyle] (FloodingSystem)[right= of FarmerNegotiations]{
\nodepart{one}
Flooding system
\nodepart{two}
\begin{varwidth}{\textwidth}
  \begin {BlackBnsBullets}
  \item type of water diversion
  \item sediment load
  \end {BlackBnsBullets}
  \end{varwidth}
};

\node[CloudyBnsStyle, draw=white, fill=white, text width=5cm] (FloodReachingPlot)[below = of FarmerNegotiations]{
Amount of flood reaching the plot
};

\node[BnsMultipartStyle] (OtherWaterFactors)[left= of FloodReachingPlot]{
\nodepart{one}
Other factors
\nodepart{two}
\begin{varwidth}{\textwidth}
  \begin {BlackBnsBullets}
  \item additional rainfall
  \item evaporation
  \item soil water holding capacity
  \end {BlackBnsBullets}
  \end{varwidth}
};

\node[CloudyBnsStyle, draw=white, fill=white, text width=3cm] (AvailableSoilWater) [below right= of OtherWaterFactors]{
Available soil water
};

\node[CloudyBnsStyle, draw=white, fill=white, text width=3cm] (WaterSupplyAdequacy) [right= of FloodReachingPlot]{
Water supply adequacy
};

\node[draw=none, fill=none] (CropAndCroppingSystems) [below=5.39cm of UpStreamInfluence] {};

\node[BnsMultipartStyle] (CropAndCroppingSystems) [below=5.39cm of UpStreamInfluence] {
\nodepart{one}
Crop and cropping systems
\nodepart{two}
\begin{varwidth}{\textwidth}
  \begin {BlackBnsBullets}
  \item crop type
  \item crop variety
  \item intercropping
  \end {BlackBnsBullets}
  \end{varwidth}
};

\node[CloudyBnsStyle, draw=white, fill=white, text width=3cm] (EffectivenessOfCroppingOptions) [below right =of CropAndCroppingSystems]{
Effectiveness of cropping options
};

\node[BnsMultipartStyle] (OtherAgricPractice) [below left=of EffectivenessOfCroppingOptions]{
\nodepart{one}
Other agricultural practices
\nodepart{two}
\begin{varwidth}{\textwidth}
  \begin {BlackBnsBullets}
  \item planting date
  \item previous crop
  \end {BlackBnsBullets}
  \end{varwidth}
};

\node[BnsMultipartStyle] (SoilManagement)[below= 0.85cm of OtherAgricPractice]{
\nodepart{one}
Soil fertility management
\nodepart{two}
\begin{varwidth}{\textwidth}
  \begin {BlackBnsBullets}
  \item soil amendments
  \item rich sediment addition
  \end {BlackBnsBullets}
  \end{varwidth}
};

\tcbsetmacrotowidthofnode{\mywidth}{SoilManagement}
\tcbsetmacrotoheightofnode{\myheight}{SoilManagement}

\node[BnsMultipartStyle, fit=(SoilManagement.north west) (SoilManagement.south east), inner sep=0pt] (SoilNutrient)[right= of SoilManagement]{
\nodepart{one}
Soil fertility
};

\tcbsetmacrotowidthofnode{\mywidth}{SoilManagement}

\node[BnsMultipartStyle,minimum width=\mywidth] (SocioEconomicContext)[below= of SoilManagement]{
\nodepart{one}
Socio-economic context
\nodepart{two}
\begin{varwidth}{\textwidth}
  \begin {BlackBnsBullets}
  \item wealth status
  \item mutual assistance
  \item access to inputs
  \end {BlackBnsBullets}
  \end{varwidth}
};

\node[BnsMultipartStyle] (FarmerProfile) at (SoilNutrient|-SocioEconomicContext){
\nodepart{one}
Farmer profile
\nodepart{two}
\begin{varwidth}{\textwidth}
  \begin {BlackBnsBullets}
  \item skills of the farmer
  \item effectiveness of crop protection
  \item available labour force
  \end {BlackBnsBullets}
  \end{varwidth}
};

\node[BnsMultipartStyle, align=left] (PreviousBioticStress) [below=of SocioEconomicContext]{
\nodepart{one}
Previous biotic stress
\nodepart{two}
\begin{varwidth}{\textwidth}
  \begin {BlackBnsBullets}
  \item residual effect of pests \& diseases
  \item residual effect of weeds
  \end {BlackBnsBullets}
  \end{varwidth}
};

\node[BnsMultipartStyle] (CurrentBioticStress) at (FarmerProfile|-PreviousBioticStress) {
\nodepart{one}
Current biotic stress
\nodepart{two}
\begin{varwidth}{\textwidth}
  \begin {BlackBnsBullets}
  \item pests \& diseases
  \item weeds
  \end {BlackBnsBullets}
  \end{varwidth}
};

\node[CloudyBnsStyle, draw=white, fill=white, text width=3cm] (AgricManagementEfficiency) at (FarmerProfile-|WaterSupplyAdequacy){
Agricultural management efficiency
};

\node[CloudyBnsStyle, draw=white, fill=white, text width=3.5cm] (FarmingConstraints) at (EffectivenessOfCroppingOptions-|AgricManagementEfficiency){
Farming constraints (FC)
};
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\node[BnsMultipartStyle, text width = 8cm, align=left] (YieldPotential)[right= 3cm of FloodingSystem]{
\nodepart{one}
{\centering
   Yield potential\par
}
\nodepart{two}
maximum yield potential without farming constraints
};

\node[BnsMultipartStyle, text width = 8cm, align=left] (AttainbleYield) [below= of YieldPotential]{
\nodepart{one}
{\centering
    Attainable yield\par

}
\nodepart{two}
{achievable fraction of yield potential under ideal conditions}
};

\node[BnsMultipartStyle, text width = 8cm, align=left] (ExploitableYieldGapLoss) at (AttainbleYield|-FarmingConstraints){
\nodepart{one}
{\centering
    Exploitable yield gap loss due to farming constraints\par

}
\nodepart{two}
{yield improvement opportunity loss due to avoidable farming constraints}
};

\node[BnsMultipartStyle, text width = 8cm, align=left] (ExploitableYieldGap) [below= of ExploitableYieldGapLoss] {
\nodepart{one}
{\centering
    Exploitable yield gap\par
}
\nodepart{two}
yield improvement opportunities for a farmer
};

\node[BnsMultipartStyle, text width = 8cm, align=left] (AverageActualYield) at (AgricManagementEfficiency-|ExploitableYieldGap){
\nodepart{one}
{\centering
    Average actual yield\par
}
\nodepart{two}
historical and realistic yield actually achieved by farmers
};

\node[BnsMultipartStyle, text width = 8cm, align=left] (BiomassExpansion)[below=of AverageActualYield]{
\nodepart{one}
{\centering
Biomass expansion factor\par
}
\nodepart{two}
account for biomass accumulation over time
};

%\node[draw=none, fill=none] (fakeNode1) at ([xshift=-1cm]SoilManagement.west|-OtherWaterFactors.west){};

%\node[draw=none, fill=none] (fakeNode2) at (SoilManagement.west-|OtherWaterFactors.west){};

%\node[draw=none, fill=none] (fakeNode2) at (SoilManagement.west-|OtherWaterFactors.west){};

\node[draw=none, fill=none](fake1) at ([xshift=-1cm]SoilManagement.west-|OtherWaterFactors.west) {};
\node[draw=none, fill=none](fake2) at (OtherWaterFactors.west-|fake1){};
\node[draw=none, fill=none](fake3) at ($(fake1)!0.5!(fake2)$){};
\node[draw=none, fill=none](fake4) [above=0.05cm of UpStreamInfluence]{};
\node[draw=none, fill=none](fake5) [below=0.5cm of PreviousBioticStress]{};
\node[draw=none, fill=none](fake21)[right=0.5cm of fake2]{};
\node[draw=none, fill=none](fake11)[right=0.5cm of fake1]{};
\node[draw=none, fill=none](fake31)[right=0.5cm of fake3]{};

\node[draw=none, fill=none](fake6) [right=0.05cm of FloodingSystem]{};
\node[draw=none, fill=none](fake7) at (fake6|-AgricManagementEfficiency){};
\node[draw=none, fill=none, rotate=-90, align=center, text=red](fake71) at ([xshift=0.75cm, yshift=-6.5cm]fake6|-FloodingSystem){\Huge Bayesian Networks};
\node[draw=none, fill=none](fake8) at (fake4-|YieldPotential){};
\node[draw=none, fill=none](fake9) at (fake5-|BiomassExpansion){};
\node[draw=none, fill=none](fake10)[right=1cm of ExploitableYieldGapLoss]{};
\node[draw=none, fill=none, rotate=-90, align=center, text=blue](fake101) at ([xshift=-0.9cm, yshift=-6.5cm]ExploitableYieldGapLoss.west|-YieldPotential.west){\Huge Monte Carlo model};

\begin{scope}[on background layer]
\node (BnsBox)[BnsBox, fit=(UpStreamInfluence)(FloodReachingPlot)(FloodingSystem)(FarmerNegotiations)(AvailableSoilWater)(WaterSupplyAdequacy)(OtherWaterFactors)(fake2.west)(SoilManagement)(SoilNutrient)(AgricManagementEfficiency)(CurrentBioticStress)(PreviousBioticStress)(FarmerProfile)(SocioEconomicContext)(fake1.west)(CropAndCroppingSystems)(EffectivenessOfCroppingOptions)(OtherAgricPractice)(fake3.west)(fake4.north)(fake5.south)(fake6)(fake71)] {};
\end{scope}

\begin{scope}[on background layer]
\node (BnsWaterBox)[BnsBox, draw=blue, fill=blue, opacity=0.1, fit=(UpStreamInfluence)(FloodReachingPlot)(FloodingSystem)(FarmerNegotiations)(AvailableSoilWater)(WaterSupplyAdequacy)(OtherWaterFactors)(fake4.south)(fake21)(fake6.west)] {};
\end{scope}

% \tcbsetmacrotowidthofnode{\mywidth}{BnsWaterBox}

\begin{scope}[on background layer]
\node (BnsManagementBox)[BnsBox,draw=red,fill=red, opacity=0.1, fit=(SoilManagement)(SoilNutrient)(AgricManagementEfficiency)(CurrentBioticStress)(PreviousBioticStress)(FarmerProfile)(SocioEconomicContext)(fake11)(fake7.west)] {};
\end{scope}

\begin{scope}[on background layer]
\node (BnsCropBox)[BnsBox,draw=green,fill=green,opacity=0.1, fit=(CropAndCroppingSystems)(EffectivenessOfCroppingOptions)(OtherAgricPractice)(fake31)] {};
\end{scope}

\begin{scope}[on background layer]
\node (BnsWaterBox)[McBox, fit=(YieldPotential)(AttainbleYield)(ExploitableYieldGapLoss)(ExploitableYieldGap)(AverageActualYield)(BiomassExpansion)(fake8)(fake9)(fake10)(fake101)] {};
\end{scope}

\draw[thickarrow] (UpStreamInfluence) -- (FloodReachingPlot);
\draw[thickarrow] (FarmerNegotiations) -- (FloodReachingPlot);
\draw[thickarrow] (FloodingSystem) -- (FloodReachingPlot);
\draw[thickarrow] (FloodReachingPlot) -- (AvailableSoilWater);

\draw[thickes] (AvailableSoilWater) -- ([xshift=-1cm]WaterSupplyAdequacy|-AvailableSoilWater);
\draw[thickarrow] ([xshift=-1cm]WaterSupplyAdequacy|-AvailableSoilWater) -- ([xshift=-1cm]WaterSupplyAdequacy.south);

\draw[thickarrow] (WaterSupplyAdequacy) -- (FarmingConstraints);

\draw[thickes] (CropAndCroppingSystems) -- ([xshift=-0.5cm]WaterSupplyAdequacy|-CropAndCroppingSystems);
\draw[thickarrow] ([xshift=-0.5cm]WaterSupplyAdequacy|-CropAndCroppingSystems) -- ([xshift=-0.5cm]WaterSupplyAdequacy.south);

\draw[thickarrow] (CropAndCroppingSystems) -- (EffectivenessOfCroppingOptions);
\draw[thickarrow] (EffectivenessOfCroppingOptions) -- (FarmingConstraints);
\draw[thickarrow] (OtherWaterFactors) -- (AvailableSoilWater);

\draw[thickes] (SoilManagement.west) -- (fake1.west);

\draw[thickes] (fake1.west) -- (fake2.west);

\draw[thickarrow] (fake2.west) -- (OtherWaterFactors.west);


\draw[thickarrow] (SoilManagement) -- (SoilNutrient);
\draw[thickarrow] (OtherAgricPractice) -- (EffectivenessOfCroppingOptions);
\draw[thickarrow] (AgricManagementEfficiency) -- (FarmingConstraints);
\draw[thickarrow] (CurrentBioticStress) -- (AgricManagementEfficiency);
\draw[thickarrow] (PreviousBioticStress) -- (CurrentBioticStress);
\draw[thickarrow] (FarmerProfile) -- (CurrentBioticStress);
\draw[thickarrow] (SocioEconomicContext) -- (FarmerProfile);

\draw[thickarrow] (YieldPotential) -- (AttainbleYield);
% \draw[thickarrow] (AttainbleYield) -- (ExploitableYieldGap);
\draw[thickes] ([yshift=-0.5cm]AttainbleYield.east) -- ([xshift=1cm, yshift=-0.5cm]AttainbleYield.east);

\draw[thickes] ([xshift=1cm, yshift=-0.5cm]AttainbleYield.east) -- ([xshift=1cm, yshift=0.5cm]ExploitableYieldGap.east);

\draw[thickarrow] ([xshift=1cm, yshift=0.5cm]ExploitableYieldGap.east) -- ([yshift=0.5cm]ExploitableYieldGap.east);

\draw[thickarrow] (SoilNutrient) -- (AgricManagementEfficiency);

\draw[thickarrow] (AverageActualYield) -- (ExploitableYieldGap);
% \draw[thickarrow] (BiomassExpansion) -- (AverageActualYield);
\draw[thickes] ([yshift=0.5cm]BiomassExpansion.east) -- ([xshift=1cm, yshift=0.5cm]BiomassExpansion.east);

\draw[thickes] ([xshift=1cm, yshift=0.5cm]BiomassExpansion.east) -- ([xshift=1cm, yshift=-0.5cm]ExploitableYieldGap.east);

\draw[thickarrow] ([xshift=1cm, yshift=-0.5cm]ExploitableYieldGap.east) -- ([yshift=-0.5cm]ExploitableYieldGap.east);

\draw[thickarrow] (ExploitableYieldGap) -- (ExploitableYieldGapLoss);
\draw[thickarrow] (FarmingConstraints) -- (ExploitableYieldGapLoss);

\draw [ultra thick, lightgray](current bounding box.north west) rectangle (current bounding box.south east);

\node[draw=none, fill=none, text=darkgray, text width=4.5cm, align=center] at ($(OtherAgricPractice)!0.5!(CropAndCroppingSystems)$){\huge Cropping \underline {system (b)}};
\node[draw=none, fill=none, text=darkgray, text width=4cm, align=center] at (OtherWaterFactors|-AvailableSoilWater) {\huge\underline {Soil water (a)}};
\node[draw=none, fill=none, text=darkgray, text width=5cm, align=center] [right=2mm of CurrentBioticStress] {\huge\underline{Management (c)}};

\node[draw=none, fill=none, text=darkgray] [below=2mm of BiomassExpansion] {\huge\underline{Crop growth (d)}};

%\node [McStyle, text width =30cm] (note1)[below=1cm of %PreviousBioticStress.south east-|AgricManagementEfficiency] {
%\begin{varwidth}{\textwidth}
%\begin{center}
%\textbf Note:
%\end{center}
%\end{varwidth}
%\begin {BlackMcBullets}
% \item This graph provides a simplified overview of the generic model. %Nodes represent groupings of similar aspects.
%\end {BlackMcBullets}
%\begin {BlackMcBullets}
% \item Bullet lists only provide examples of variables that can be expected %in the model described in fine detail in the technical material.
%\end {BlackMcBullets}
%\begin {BlackMcBullets}
% \item Bubble shapes are Bayesian networks formed by variables (rectangular %shapes) pointing to them.
%\end {BlackMcBullets}
%};

\draw [ultra thick, lightgray](current bounding box.north west) rectangle (current bounding box.south east);
\end{tikzpicture}
%% End of Overview Detailed Model %%%%
```

```{r fig4, echo=FALSE,out.width='100%',fig.cap="Overview of the mixed Bayesian Network/Monte Carlo crop model for flood-based farming systems in the Tigray region of Ethiopia and Kisumu County in Kenya. a) factors determining the available soil water, b) cropping system characteristics, c) management practices adopted by the farmer, and d) crop development over time. This graph provides a simplified overview of the generic model. Nodes represent groupings of similar aspects. Bullet lists only provides example of variables that can be expected in the model described in fine detail in the technical material. Bubble shapes are Bayesian networks formed by variables (rectangular shapes) pointing to them."}
knitr::include_graphics("figures/fig4-plot-1.pdf")
```

## Soil water module {#ref42}

The soil water module (Figure \@ref(fig:fig4) a) aims to estimate the adequacy of water supply to the crop, which was judged a convenient determinant of crop performance (in the sense of water-limited yield). Adequacy is related to available soil water, which is positively influenced by other factors such as rainfall, soil water holding capacity and the amount of flood reaching the plot, and negatively affected by evaporation (Figure \@ref(fig:fig5)). Two sub-modules were used to describe this module: the amount of flood reaching the plot, and the available soil water (see supplementary material). The former describes external influences, infrastructure, and social arrangements determining flood water acquisition and sharing in FBFS. The latter describes the factor ‘soil water’, as it would be described under rainfed conditions (Figure \@ref(fig:fig5)).

The amount of flood obtained by a farmer depends on agreements for water sharing and system maintenance between stakeholders. These can reduce sediment loads (depending on the type of water diversion), with positive implications for the adequacy of water supply to crops. External effects such as upstream abstraction can reduce the amount of flood reaching the plot directly or indirectly (via the amount of shared flood water). Off-site rainfall occurrence can have a positive effect by increasing water supply. Soil water availability, however, is not only defined by these aspects; it also relies on intrinsic soil characteristics, farmer management, and other climatic factors (Figure \@ref(fig:fig5)).

```{r case-study-1-methods-rds-1,eval=TRUE,include=FALSE,echo=FALSE,cache=FALSE}

## Available soil water BNs  ####

net <- bnlearn::model2network("[SoilType][ManureApp][SoilHoldWater|SoilType:ManureApp][EvapoTranspirat][InitWaterCont][RainAmount][FloodReachsPlot][AvailSoilWater|SoilHoldWater:EvapoTranspirat:RainAmount:InitWaterCont:FloodReachsPlot]")

abbr_node_names <- bnlearn::nodes(net)

net <- bnlearn::model2network("[Soil_type][Manure_application][Soil_water_holding_capacity|Soil_type:Manure_application][Evapotranspiration_at_initial_stage][Initial_soil_water_content][Rainfall_amount_at_initial_stage][Amount_of_flood_reaching_the_plot_at_initial_stage][Available_soil_water_at_initial_stage|Soil_water_holding_capacity:Evapotranspiration_at_initial_stage:Rainfall_amount_at_initial_stage:Initial_soil_water_content:Amount_of_flood_reaching_the_plot_at_initial_stage]")

legende <- bnlearn::nodes(net)
```

```{r case-study-1-methods-rds-2, eval=TRUE,include=FALSE,echo=FALSE,cache=FALSE}
net <- decisionSupportExtra::extract_bn(bn = network_bn_fit, string_model = net)
if (!dir.exists("output_files")) {dir.create("output_files")}
saveRDS(net, paste0("output_files", "/", "Modelling_FBFS_BNs_Case_study_1.rds"))
```

```{r case-study-1-methods-rds-3,eval=TRUE,include=FALSE,echo=FALSE,cache=FALSE}
net <- readRDS("output_files/Modelling_FBFS_BNs_Case_study_1.rds")
```

```{r case-study-1-methods-plots,eval=TRUE,include=FALSE,echo=FALSE,cache=FALSE}

bnlearn::nodes(net) <- abbr_node_names[c(3, 1, 2, 4, 5, 6, 8, 7)]
abbr_node_names <- abbr_node_names[c(3, 1, 2, 4, 5, 6, 8, 7)]

legende <- mapply(paste, abbr_node_names, sprintf('\u2192'), legende)
legende <- gsub("_", " ",  legende)
legende <- gsub(" at initial stage", "",  legende)

leg_breaks <- list(1:3, 4:5, 6:length(legende))
legende <- lapply(leg_breaks, function(i) legende[i])
legend_pos <- c('topleft', "bottomleft", 'bottomright')
legend_title <- c("Legend (1 of 3)", "Legend (2 of 3)", "Legend (3 of 3)")

inset <- list(c(0.04, 0.08), c(0.04, 0.08), c(0.04, 0.08))
text_width_ext <- c(0.85, 0.85, 0.85)

png(export_fun(export = "Modelling_FBFS_Avail_soil_water"),
     res = min_plots_res,
     units = 'in',
     # compression = plots_compression,
     width = max_plots_width_in, 
     height = max_plots_height_in/2.75,
     pointsize = 10.5)

par(font = plots_font, family = plots_font_family, lwd=plots_lwd)

graphviz_chart_bn (x = net, type = "barprob", layout = "dot", draw.levels = TRUE,abbreviate=FALSE,
                   grid = TRUE, scale = c(max_plots_height_in/2, max_plots_width_in), col = "black", bg = "transparent",
                   text.col = "black", bar.col = "green", strip.bg = "lightyellow")

lapply(1:length(legende), function(i) {
  legend(legend_pos[i], legend = legende[[i]], text.width = text_width_ext[i]*strwidth(legende[[i]][which.max(nchar(legende[[i]]))]), 
         cex=text_width_ext[i], ncol = 1,
         bty="o", box.lwd=1, box.col='lightyellow', xjust=1, yjust=1, bg=legend_bg,
         title = legend_title[i], title.col = 'blue', inset=inset[[i]])
})

box(col = 'lightgray')
dev.off()
```
```{tikz fig5-plot,echo=FALSE,include=FALSE,eval=TRUE,fig.cap="Causal linkages defining the factor ‘available soil water content’ in flood-based farming systems in the Tigray region of Ethiopia and Kisumu County in Kenya (simplified illustration).",fig.ext='png',cache=FALSE,eval=TRUE,engine.opts=list(engine='xetex',template="latex/tikz2pdf.tex")}
%% Beginning of Available soil water BNs %%%%

\begin{tikzpicture}[node distance = 2cm]

\node[BnsBarplotStyle] (FloodReachsPlot2)  {
\nodepart{two}
\begin{tikzpicture}[use background]
\begin{axis}[AxisStyle,
                    symbolic y coords = {Low,Medium, High}
                  ]

\addplot [AddPlotStyle]  coordinates { (0.228,Low)(0.317,Medium)     (0.455,High)};

\end{axis}
\end{tikzpicture}
};

\tcbsetmacrotowidthofnode{\mywidth}{FloodReachsPlot2}

\node[BnsBarplotTitleStyle, minimum width=\mywidth](FloodReachsPlot1)[above=0pt of FloodReachsPlot2]{Amount of flood reaching the plot};

%%%%

%%%%

\node[BnsBarplotStyle] (AvailSoilWater2)[below=of FloodReachsPlot2]  {
\nodepart{two}
\begin{tikzpicture}[use background]
\begin{axis}[AxisStyle,
                    symbolic y coords = {Drought risk,Normal, Waterlogging risk}
                  ]

\addplot [AddPlotStyle]  coordinates { (0.034,Drought risk)(0.207,Normal)     (0.759,Waterlogging risk)};

\end{axis}
\end{tikzpicture}
};
\tcbsetmacrotowidthofnode{\mywidth}{AvailSoilWater2}
\node[BnsBarplotTitleStyle, minimum width=\mywidth](AvailSoilWater1)[above=0pt of AvailSoilWater2]{Available soil water};
%%%%

%%%%

\node[BnsBarplotStyle] (EvapoTranspirat2)[below=of AvailSoilWater2]  {
\nodepart{two}
\begin{tikzpicture}[use background]
\begin{axis}[AxisStyle,
                    symbolic y coords = {Low,Medium, High}
                  ]

\addplot [AddPlotStyle]  coordinates { (0.100,Low)(0.200,Medium)     (0.700,High)};

\end{axis}
\end{tikzpicture}
};
\tcbsetmacrotowidthofnode{\mywidth}{EvapoTranspirat2}
\node[BnsBarplotTitleStyle, minimum width=\mywidth](EvapoTranspirat1)[above=0pt of EvapoTranspirat2]{Evapotranspiration};
%%%%


%%%%

\node[BnsBarplotStyle] (InitWaterCont2)[below left=of AvailSoilWater2]  {
\nodepart{two}
\begin{tikzpicture}[use background]
\begin{axis}[AxisStyle,
                    symbolic y coords = {Very low,Low, Medium, High}
                  ]

\addplot [AddPlotStyle]  coordinates { (0.400,Very low)(0.300,Low)(0.150,Medium)     (0.150,High)};

\end{axis}
\end{tikzpicture}
};
\tcbsetmacrotowidthofnode{\mywidth}{InitWaterCont2}
\node[BnsBarplotTitleStyle, minimum width=\mywidth](InitWaterCont1)[above=0pt of InitWaterCont2]{Initial soil water content};
%%%%


%%%%

\node[BnsBarplotStyle] (RainAmount2)[above left=of AvailSoilWater2]  {
\nodepart{two}
\begin{tikzpicture}[use background]
\begin{axis}[AxisStyle,
                    symbolic y coords = {Below normal,Normal, Above normal}
                  ]

\addplot [AddPlotStyle]  coordinates { (0.250,Below normal)(0.600,Normal)(0.150,Above normal) };

\end{axis}
\end{tikzpicture}
};
\tcbsetmacrotowidthofnode{\mywidth}{RainAmount2}
\node[BnsBarplotTitleStyle, minimum width=\mywidth](RainAmount1)[above=0pt of RainAmount2]{Rainfall amount};
%%%%

%%%%

\node[BnsBarplotStyle] (SoilHoldWater2)[right=of AvailSoilWater2]  {
\nodepart{two}
\begin{tikzpicture}[use background]
\begin{axis}[AxisStyle,
                    symbolic y coords = {Low,Medium, High}
                  ]

\addplot [AddPlotStyle]  coordinates { (0.059,Low)(0.194,Medium)     (0.747,High)};

\end{axis}
\end{tikzpicture}
};
\tcbsetmacrotowidthofnode{\mywidth}{SoilHoldWater2}
\node[BnsBarplotTitleStyle, minimum width=\mywidth](SoilHoldWater1)[above=0pt of SoilHoldWater2]{Soil water holding capacity};
%%%%

%%%%

\node[BnsBarplotStyle] (ManureApp2)[above=of SoilHoldWater2]  {
\nodepart{two}
\begin{tikzpicture}[use background]
\begin{axis}[AxisStyle,
                    symbolic y coords = {False, True}
                  ]

\addplot [AddPlotStyle]  coordinates { (0.3,False)(0.7,True) };

\end{axis}
\end{tikzpicture}
};
\tcbsetmacrotowidthofnode{\mywidth}{ManureApp2}
\node[BnsBarplotTitleStyle, minimum width=\mywidth](ManureApp1)[above=0pt of ManureApp2]{Manure application};
%%%%

%%%%

\node[BnsBarplotStyle] (SoilType2)[below=of SoilHoldWater2]  {
\nodepart{two}
\begin{tikzpicture}[use background]
\begin{axis}[AxisStyle,
                    symbolic y coords = {Sandy, Loamy, Clayey},
]

\addplot [AddPlotStyle]  coordinates { (0.050,Sandy)(0.550,Loamy)(0.400,Clayey)};

\end{axis}
\end{tikzpicture}
};
\tcbsetmacrotowidthofnode{\mywidth}{SoilType2}
\node[BnsBarplotTitleStyle, minimum width=\mywidth](SoilType1)[above=0pt of SoilType2]{Soil Type};
%%%%

\draw[thickarrow] (FloodReachsPlot2) -- (AvailSoilWater1);
\draw[thickarrow] (EvapoTranspirat1) -- (AvailSoilWater2);

\draw[thickes] (InitWaterCont1.north) -- ([yshift=-5mm]InitWaterCont1|-AvailSoilWater2);
\draw[thickarrow] ([yshift=-5mm]InitWaterCont1|-AvailSoilWater2) -- ([yshift=-5mm]AvailSoilWater2.west);

\draw[thickes] (InitWaterCont1|-RainAmount2.south) -- ([yshift=5mm]InitWaterCont1|-AvailSoilWater2);
\draw[thickarrow] ([yshift=5mm]InitWaterCont1|-AvailSoilWater2) -- ([yshift=5mm]AvailSoilWater2.west);

\draw[thickarrow] (SoilHoldWater2) -- (AvailSoilWater2);
\draw[thickarrow] (SoilType1) -- (SoilHoldWater2);
\draw[thickarrow] (ManureApp2) -- (SoilHoldWater1);

\draw [ultra thick, lightgray](current bounding box.north west) rectangle (current bounding box.south east);
\end{tikzpicture}
%% End of Available soil water BNs %%%%
```

```{r fig5,echo=FALSE,out.width='100%',fig.cap="Causal linkages defining the factor ‘available soil water content’ in flood-based farming systems in the Tigray region of Ethiopia and Kisumu County in Kenya (simplified illustration)."}
knitr::include_graphics("Modelling_FBFS_files/figure-latex/fig5-plot-1.pdf")
```

The assessment of soil water using the soil water module (Figure \@ref(fig:fig6)) shows that on clayey soils without manure application, drought is unlikely to occur, while waterlogging is very likely when at least the desired amount of floodwater is obtained (Figure \@ref(fig:fig6)). Uncertainty is greater when little floodwater is available. Supplementary manure application slightly increases the chance of waterlogging, which also increases when too much floodwater is obtained. 

Loamy soils generally behave similarly to clayey ones, with a slightly lower chance of waterlogging and greater probability of normal soil water conditions. Sandy soils (the dominant soil type in FBFS) appear to be the riskiest and most uncertain soil type for soil water. Drought is likely in years with little floodwater and manure application.

```{r case-study-1-results-rds-1,eval=TRUE,include=FALSE,echo=FALSE,cache=FALSE}
## constructing the evidence list ####
evidence <- c('Soil_type', 'Manure_application', 'Amount_of_flood_reaching_the_plot_at_initial_stage')

bloks = 1:10
ssp <- sapply(bloks, function (nothing){
    out <- sample_cpdist(bn = network_bn_fit, node = "Available_soil_water_at_initial_stage",
                         op = "proba", evidence = evidence, include_relatives = FALSE,n_run = 1)
    cbind(out$prior, out$posterior)
    
}, simplify = F, USE.NAMES = TRUE)

ssp  <- reshape2::melt(ssp)
ssp$Soil_type <- factor(ssp$Soil_type, levels = unique(ssp$Soil_type))
ssp$Manure_application <- factor(ssp$Manure_application, levels = unique(ssp$Manure_application))
ssp$Amount_of_flood_reaching_the_plot_at_initial_stage <- factor(ssp$Amount_of_flood_reaching_the_plot_at_initial_stage, levels = unique(ssp$Amount_of_flood_reaching_the_plot_at_initial_stage))
ssp$variable <- factor(ssp$variable, levels = unique(ssp$variable))
```

```{r case-study-1-results-rds-2,eval=TRUE,include=FALSE,echo=FALSE,cache=FALSE}
saveRDS(ssp, paste0("output_files", "/", "Modelling_FBFS_ssp_Case_study_1.rds"))
```

```{r fig6-plot,echo=FALSE,include=FALSE,fig.width=max_plots_width_in,fig.height=max_plots_height_in/4,dpi=min_plots_res}

titres <- structure(list(Soil_type = structure(1L, .Label = "Soil type", class = "factor"), 
               Manure_application = structure(1L, .Label = "Manure", class = "factor"), 
               Amount_of_flood_reaching_the_plot_at_initial_stage = structure(1L, .Label = "Floodwater", class = "factor"), 
               variable = structure(1L, .Label = "Probability of\n available soil water", class = "factor"), 
               value = structure(1L, .Label = "value", class = "factor"), 
               L1 = structure(1L, .Label = "L1", class = "factor")), class = "data.frame", row.names = c(NA, 
                                                                                                         -1L))
p1 <- ggplot(data = ssp, aes(x=L1, y = value, fill = variable))+
  # geom_boxplot(lwd = 0.05, outlier.size = 0.05)+
  geom_bar(stat="identity", position="stack")+
  ggnomics::facet_nested(.~Soil_type+Amount_of_flood_reaching_the_plot_at_initial_stage+Manure_application, 
                         space = 'free_x', scales = 'free_x')+
  scale_fill_discrete(labels = function(x) gsub("[.]", " ", x))+
  # labs(x = "Factors of available soil water", y = "Probability of soil water")+
  scale_x_discrete(breaks=1:10, expand = c(0, 0))+
  scale_y_continuous(expand = c(0, 0), breaks = seq(.25, 1, by=.25),
                     labels = function(x) sprintf("%.2f", x))+
  # scale_fill_manual(values=c("oldlace", "honeydew", "lavender"))+
  guides(color=FALSE)+
  # labs(tag = "Soil type\n Floodwater\n Manure")
  my_theme +
  # switch the facet strip label to outside 
  # remove background color
  theme(
    # strip.placement = 'outside',
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title = element_blank(),
    # axis.title = element_text(size = plot_font_size+4),
    legend.text = element_text(size = plot_font_size+2),
    legend.position = 'top',
    legend.spacing.x = unit(1.0, 'cm'),
    legend.margin=margin(0,0,0,0),
    legend.box.margin=margin(0,0,-5, 0),
    legend.key.size = unit(1,"line"),
    # panel.border = element_rect(fill=NA, size = 0.05),
    # panel.grid.major = element_line(size = 0.05),
    # panel.grid.minor = element_line(size = 0.02),
    strip.text = element_text(size = plot_font_size),
    strip.text.x = element_text(margin = margin(t=3, b = 3)),
    # strip.text.x = element_text(margin = margin(0,0,0,0, "cm")),
    # plot.tag.position = c(1, 0.9),
    # plot.tag = element_text(hjust=0),
    axis.text = element_text(size = plot_font_size+2)
  )

p2 = ggplot(data = titres, aes(x=1, y = 1, label = variable, fill=variable))+ 
  geom_text(angle = -90, size=plot_font_size-6, family=plots_font_family,lineheight = 0.9)+
  ggnomics::facet_nested(.~Soil_type+Amount_of_flood_reaching_the_plot_at_initial_stage+Manure_application,
                         space = 'free_x', scales = 'free_x')+
  theme_void(base_family = plots_font_family)+
  theme(
    
    plot.margin =margin(19.5,0,0, 0),
    # strip.background = element_rect(color = 'black', fill='white'),
        strip.text = element_text(size = plot_font_size),
    strip.text.x = element_text(margin = margin(t=3, b = 3)))

p1 <- list(p1, p2)
p1$ncol=2
p1$widths=c(12.8,1.2)

grid.newpage()
ga = do.call("grid.arrange", p1)
gb = grid.rect(.5,.5,width=unit(1,"npc"), height=unit(1,"npc"), 
               gp=gpar(lwd=1, fill=NA, col="lightgray"))
g <- gTree(children = gList(ga, gb))

```

```{r fig6-export,echo=FALSE,eval=TRUE}
ggsave(plot=g, device = 'png', filename = "figures/Modelling_FBFS_factor_of_soil_water.png", width = max_plots_width_in, 
       height =max_plots_height_in/3, units = "in", dpi = min_plots_res
)
ggsave(plot=g, device = 'pdf', filename = "figures/Modelling_FBFS_factor_of_soil_water.pdf", width = max_plots_width_in, 
       height =max_plots_height_in/3, units = "in", dpi = min_plots_res
)
```

```{r fig6, echo=FALSE,out.width='100%',fig.cap="Effect of soil type, manure, and flood water on available soil water in flood-based farming systems in the Tigray region of Ethiopia and Kisumu County in Kenya. Each block represents 10 possible outcomes of the corresponding query. Each query was run 1000 times."}
knitr::include_graphics("figures/Modelling_FBFS_factor_of_soil_water.pdf")
```

## Cropping system module {#ref43}

The cropping system module (Figure \@ref(fig:fig4) b) aims to assess the effectiveness of the cropping options, evaluating the performance of the cropping system adopted by the farmer instead of the cropping system itself. Crop types were ranked in decreasing order of yield (rice, teff, maize and sorghum) with improved crop varieties assumed to perform better than local ones. However, the effectiveness of the cropping system depends on an array of agricultural practices such as the choice of planting date, the crops previously grown on the same land, and the presence and density of intercropping. The most effective cropping is generally achieved when an improved variety is planted early on land that had a different crop in the previous season. This can depend on the crop type. For example, rice and teff are quite tolerant of repeated cultivation and monoculture, whereas maize and sorghum perform better in crop rotations and intercropping.

## Crop growth module {#ref44}

The crop growth module (Figure \@ref(fig:fig4) d; Figure \@ref(fig:fig7)) monitors biomass accumulation over time to provide estimates of yield metrics (e.g. biomass yield gap, exploited biomass yield) at different stages of crop development. Figure \@ref(fig:fig7) summarises the MC model including the relationships between the quantitative variables and the mathematical calculations involved at the initial and development stages. Crops are initially regarded in terms of their boundary conditions represented by their yield potential, which was differentiated into attainable yield potential, yield gaps, and actual yield via the actual farm conditions represented by farming constraints (see section \@ref(ref32); Figure \@ref(fig:fig7)). The simulation produced 324 outcomes corresponding to the different scenarios described in section \@ref(ref36). Only a few of these results are presented here to showcase the model. We selected the initial and the late stages of crop development along with the worst, medium, and best-case scenarios to show the biomass accumulation over time, and to illustrate the effect of varying farming constraints on crop development (Figure \@ref(fig:fig8)). 

```{tikz fig7-plot,echo=FALSE,include=FALSE,eval=TRUE,fig.cap="Overview of a Monte Carlo model assessing biomass accumulation during crop development in flood-based farming systems in the Tigray region of Ethiopia and Kisumu County in Kenya. Gray-bordered nodes are taken at initial stage. Blue-bordered nodes are taken at development stage. Dashed and plain lines nodes, respectively, are elicited and computed.",fig.ext='png',cache=FALSE,eval=TRUE,engine.opts=list(engine='xetex',template="latex/tikz2pdf.tex")}

%% Beginning of Simplified Monte Carlo Model %%%%

\begin{tikzpicture}

\arrayrulecolor{white}

\node[FlexMcStyle, draw=BlueMcBulletsColor, fill=white] (ExpectedActualYieldDev) {
\begin{tabular}{c}
 \hline
 \rowcolor{graphicbackground}
 {\LARGE\bf Expected actual yield $(ExpectYaDev)$}\\ \hline \hline
  \rowcolor{McDomainColor}
$ActualExplYgDev + (ExpectYaInit \times ExpDev)$ \\ \hline
\end{tabular}
};

\node[FlexMcStyle, draw=ModellingInterfaceDomainColor, fill=white] (ExpectedActualYieldInit)[right=of ExpectedActualYieldDev] {
\begin{tabular}{c}
\hline
\rowcolor{graphicbackground}
{\LARGE\bf Expected actual yield $(ExpectYaInit)$}\\ \hline \hline
\rowcolor{McDomainColor}
 $ActualExplYgInit + AvgYaInit$\\ \hline
\end{tabular}
};

\node[FlexMcStyle, dashed, draw=ModellingInterfaceDomainColor, fill=white] (AverageActualYieldInit)[above left=of ExpectedActualYieldInit] {
\begin{tabular}{c | c}
% \begin{minipage}{2.5cm}
\hline
\rowcolor{graphicbackground}
\multicolumn{2}{c}{\LARGE\bf Average actual yield $(AvgYaInit)$}\\ \hline \hline
\rowcolor{McDomainColor}
{Minimum} & {0.04} \\
\rowcolor{McDomainColor}
{Median} & {0.26} \\
\rowcolor{McDomainColor}
{Maximum} & {0.76} \\
\rowcolor{McDomainColor}
{Probability distribution} & {gamma}\\ \hline
% \end{minipage}
\end{tabular}
};

\draw[thickarrow] (AverageActualYieldInit.south east) to [bend right = 20](ExpectedActualYieldInit.north west);

\draw[thickarrow] (ExpectedActualYieldInit.west) -- (ExpectedActualYieldDev.east);

\node[FlexMcStyle, draw=ModellingInterfaceDomainColor, fill=white] (ActualExploitedYieldgapInit)[right= of ExpectedActualYieldInit.north east|-AverageActualYieldInit] {
\begin{tabular}{c}
\hline
\rowcolor{graphicbackground}
{\LARGE\bf Actually exploited yield gap $(ActualExplYgInit)$}\\ \hline \hline
\rowcolor{McDomainColor}
 $ExplYgInit - YgLossInit$\\ \hline
\end{tabular}
};


\node[FlexMcStyle, draw=ModellingInterfaceDomainColor, fill=white] (ExploitableYieldGapInit) [above right=of AverageActualYieldInit] {
\begin{tabular}{c}
\hline
\rowcolor{graphicbackground}
{\LARGE\bf Exploitable yield gap $(ExplYgInit)$}\\ \hline \hline
\rowcolor{McDomainColor}
 $AttainYpInit - AvgYaInit$\\ \hline
\end{tabular}
};

\node[FlexMcStyle, draw=BlueMcBulletsColor, fill=white] (ExploitableYieldGapDev) at ($(ExploitableYieldGapInit)!0.5!(ExpectedActualYieldInit)$) {
\begin{tabular}{c}
\hline
\rowcolor{graphicbackground}
{\LARGE\bf Exploitable yield gap $(ExplYgDev)$}\\ \hline \hline
\rowcolor{McDomainColor}
 $ExplYgInit + (ExplYgInit \times ExpDev)$\\ \hline
\end{tabular}
};

\node[FlexMcStyle, draw=BlueMcBulletsColor, fill=white] (ExploitableYieldGapLossDue2ConstraintsDev)[below right= 1.5cm and 4cm of ExpectedActualYieldDev] {
\begin{tabular}{c}
\hline
\rowcolor{graphicbackground}
{\LARGE\bf Exploitable yield gap loss due to constraints $(YgLossDev)$}\\ \hline \hline
\rowcolor{McDomainColor}
 $ExplYgDev \times FcDev$\\ \hline
\end{tabular}
};

\node[FlexMcStyle, draw=BlueMcBulletsColor, fill=white] (ActualExploitedYieldgapDev)[left=of ExploitableYieldGapInit] {
\begin{tabular}{c}
\hline
\rowcolor{graphicbackground}
{\LARGE\bf Actually exploited yield gap $(ActualExplYgDev)$}\\ \hline \hline
\rowcolor{McDomainColor}
 $ExplYgInit - ExplLossDev$\\ \hline
\end{tabular}
};

\draw[thickarrow] ([xshift = -4cm]ActualExploitedYieldgapDev.south-|ExpectedActualYieldDev) to ([xshift = -4cm]ExpectedActualYieldDev.north);

\node[FlexMcStyle, draw=ModellingInterfaceDomainColor, fill=white] (ExploitableYieldGapLossDue2ConstraintsInit)[right= of ExploitableYieldGapInit] {
\begin{tabular}{c}
\hline
\rowcolor{graphicbackground}
{\LARGE\bf Exploitable yield gap loss due to constraints $(YgLossInit)$}\\ \hline \hline
\rowcolor{McDomainColor}
 $ExplYgInit \times FcInit$\\ \hline
\end{tabular}
};

\node[FlexMcStyle,  dashed, draw=ModellingInterfaceDomainColor, fill=white] (YieldPotential)[above= of ExploitableYieldGapLossDue2ConstraintsInit] {
\begin{tabular}{c | c}
\hline
\rowcolor{graphicbackground}
\multicolumn{2}{c}{\LARGE\bf Yield potential $(YpInit)$}\\ \hline \hline
\rowcolor{McDomainColor}
{Minimum} & {0.08} \\
\rowcolor{McDomainColor}
{Median} & {0.96} \\
\rowcolor{McDomainColor}
{Maximum} & {3.85} \\
\rowcolor{McDomainColor}
{Probability distribution} & {gamma}\\ \hline
\end{tabular}
};

\node[FlexMcStyle, dashed, draw=ModellingInterfaceDomainColor, fill=white] (ExploitableYieldPotentialInit)[above= of ActualExploitedYieldgapDev] {
\begin{tabular}{c | c}
\hline
\rowcolor{graphicbackground}
\multicolumn{2}{c}{\LARGE\bf Exploitable yield potential $(ExplYpInit)$}\\ \hline \hline
\rowcolor{McDomainColor}
{Minimum} & {0.85} \\
\rowcolor{McDomainColor}
{Median} & {0.89} \\
\rowcolor{McDomainColor}
{Maximum} & {0.90} \\
\rowcolor{McDomainColor}
{Probability distribution} & {unif}\\ \hline
\end{tabular}
};

\node[FlexMcStyle, draw=ModellingInterfaceDomainColor, fill=white] (AttainableYieldPotential) at ($(YieldPotential)!0.5!(ExploitableYieldPotentialInit)$) {
\begin{tabular}{c}
\hline
\rowcolor{graphicbackground}
{\LARGE\bf Attainable yield potential $(AttainYpInit)$}\\ \hline \hline
\rowcolor{McDomainColor}
{$YpInit \times ExplYpInit$}\\ \hline
\end{tabular}
};

\node[FlexMcStyle,  dashed, draw=BlueMcBulletsColor, fill=white] (BiomassExpansionDev)[right= of ExpectedActualYieldInit] {
\begin{tabular}{c | c}
\hline
\rowcolor{graphicbackground}
\multicolumn{2}{c}{\LARGE\bf Biomass expansion factor $(ExpDev)$}\\ \hline \hline
\rowcolor{McDomainColor}
{Minimum} & {0.27} \\
\rowcolor{McDomainColor}
{Median} & { } \\
\rowcolor{McDomainColor}
{Maximum} & {0.68} \\
\rowcolor{McDomainColor}
{Probability distribution} & {gamma}\\ \hline
\end{tabular}
};

\node[CloudyBnsStyle, draw=ModellingInterfaceDomainColor, fill=white] (FarmingConstraintsInit) [right= of YieldPotential] {\LARGE\bf Farming\\\LARGE\bf constraints\\$(FcInit)$};

\node[draw=none, fill=none] (corner1) at ($(ExploitableYieldGapLossDue2ConstraintsDev.north west)!0.5!(ExpectedActualYieldInit.south)$) {};

\node[draw=none, fill=none] (corner2) at (corner1-|ExpectedActualYieldDev.south west) {};

\node[draw=none, fill=none] (corner3) at (corner2|-ActualExploitedYieldgapDev.west) {};

\node[CloudyBnsStyle, draw=BlueMcBulletsColor, fill=white] (FarmingConstraintsDev) at (ExploitableYieldGapLossDue2ConstraintsDev-|FarmingConstraintsInit) {\LARGE\bf Farming\\\LARGE\bf constraints\\$(FcDev)$};

%\node [McStyle, text width =15cm] (note1)[left=of %ExploitableYieldGapLossDue2ConstraintsDev] {
%\begin{varwidth}{\textwidth}
%\begin{center}
%Note:
%\end{center}
%\end{varwidth}
%\begin {GrayModellingInterfaceBullets}
% \item Gray-bordered nodes are taken at initial stage.
%\end {GrayModellingInterfaceBullets}
%\begin {BlueMcBullets}
% \item Blue-bordered nodes are taken at development stage.
%\end {BlueMcBullets}
%\begin {BlackMcBullets}
% \item Dashed and plain lines nodes, respectively, are elicited and %computed.
%\end {BlackMcBullets}
%};


%\draw[thickarrow] ([xshift=1cm]ExploitableYieldGapLossDue2ConstraintsDev.north west) -- (corner1.south) -- (corner2.south west) -- (corner3.west) -- (ActualExploitedYieldgapDev.west);

\draw[thickarrow] ([xshift=1cm]ExploitableYieldGapLossDue2ConstraintsDev.north west) -- (corner1.south) -- (corner2.south west) -- (ActualExploitedYieldgapDev.south-|corner2.south west);

\draw[thickarrow, name path=BiomassExpansionDev--ExpectedActualYieldDev] (BiomassExpansionDev.west|-corner1.west) -- (corner1.west) -- (corner2.west-|ExpectedActualYieldDev) -- (ExpectedActualYieldDev);

\draw[thickarrow, name path=BiomassExpansionDev--ExploitableYieldGapDev] (BiomassExpansionDev.north west) to [bend right=10](ExploitableYieldGapDev.east);

%\draw[thickes] (FarmingConstraintsInit.east) -- (ExploitableYieldGapLossDue2ConstraintsInit.south|-FarmingConstraintsInit.east);

%\draw[thickarrow] (ExploitableYieldGapLossDue2ConstraintsInit.south|-FarmingConstraintsInit.east) -- (ExploitableYieldGapLossDue2ConstraintsInit.south);

\draw[thickarrow] (FarmingConstraintsInit.south) -- (ExploitableYieldGapLossDue2ConstraintsInit.north-|FarmingConstraintsInit.south);

\draw[thickarrow] (ExploitableYieldGapLossDue2ConstraintsInit.south) -- (ActualExploitedYieldgapInit.north-|ExploitableYieldGapLossDue2ConstraintsInit.south);

\draw[thickarrow] (ExploitableYieldGapInit.east) -- (ExploitableYieldGapLossDue2ConstraintsInit.west);

\draw[thickarrow] (ExploitableYieldGapInit.south east) to [bend left=20](ActualExploitedYieldgapInit.north west);

\draw[thickarrow] (AverageActualYieldInit.north east) to [bend left=20] (ExploitableYieldGapInit.south west);

\draw[thickarrow] (YieldPotential) -- (AttainableYieldPotential);

\draw[thickarrow] (ExploitableYieldPotentialInit) -- (AttainableYieldPotential);

\draw[thickarrow] (AttainableYieldPotential.south-|ExploitableYieldGapInit) -- (ExploitableYieldGapInit);

\draw[thickarrow] (ExploitableYieldGapInit.south-|AttainableYieldPotential.south-|ExploitableYieldGapInit) -- (ExploitableYieldGapDev.north-|AttainableYieldPotential.south-|ExploitableYieldGapInit);

\draw[thickarrow] (ExploitableYieldGapInit) -- (ActualExploitedYieldgapDev);

%\draw[thickarrow, name path=ExploitableYieldGapDev--ExploitableYieldGapLossDue2ConstraintsDev] (ExploitableYieldGapDev.south east) to [bend left=10]([xshift=-0.5cm]ExploitableYieldGapLossDue2ConstraintsDev.north);
\draw[thickarrow, name path=ExploitableYieldGapDev--ExploitableYieldGapLossDue2ConstraintsDev] (ExploitableYieldGapDev.south east) to [bend left=30]([xshift=0cm]ExploitableYieldGapLossDue2ConstraintsDev.north);
\draw[thickarrow, name path=ActualExploitedYieldgapInit--ExpectedActualYieldInit] (ActualExploitedYieldgapInit.south west) to [bend left = 20](ExpectedActualYieldInit.north east);

\path [name intersections={of=BiomassExpansionDev--ExploitableYieldGapDev and ActualExploitedYieldgapInit--ExpectedActualYieldInit, by={A}}];
\path [name intersections={of=ExploitableYieldGapDev--ExploitableYieldGapLossDue2ConstraintsDev and ActualExploitedYieldgapInit--ExpectedActualYieldInit, by={B}}];
\path [name intersections={of=BiomassExpansionDev--ExpectedActualYieldDev and ExploitableYieldGapDev--ExploitableYieldGapLossDue2ConstraintsDev, by={C}}];

\node[rectangle, draw=white, fill=white] at (A) { };
\node[rectangle, draw=white, fill=white] at (B) { };
\node[rectangle, draw=white, fill=white] at (C) { };

\draw[thickarrow, name path=ActualExploitedYieldgapInit--ExpectedActualYieldInit] (ActualExploitedYieldgapInit.south west) to [bend left = 20](ExpectedActualYieldInit.north east);

\draw[thickarrow, name path=BiomassExpansionDev--ExpectedActualYieldDev] (BiomassExpansionDev.west|-corner1.west) -- (corner1.west) -- (corner2.west-|ExpectedActualYieldDev) -- (ExpectedActualYieldDev);


%BiomassExpansionDev--ExploitableYieldGapDev
%ExploitableYieldGapDev--ExploitableYieldGapLossDue2ConstraintsDev
%ActualExploitedYieldgapInit--ExpectedActualYieldInit


%\draw[thickes] (FarmingConstraintsDev.west) -- ([xshift=1cm]ExploitableYieldGapLossDue2ConstraintsDev.south west|-FarmingConstraintsDev.west);

%\draw[thickarrow] ([xshift=1cm]ExploitableYieldGapLossDue2ConstraintsDev.south west|-FarmingConstraintsDev.west) -- ([xshift=1cm]ExploitableYieldGapLossDue2ConstraintsDev.south west);

\draw[thickarrow] (FarmingConstraintsDev) -- (ExploitableYieldGapLossDue2ConstraintsDev);

\draw [ultra thick, lightgray](current bounding box.north west) rectangle (current bounding box.south east);

\end{tikzpicture}
%% End of Simplified Monte Carlo Model %%%%
```

```{r fig7,echo=FALSE,out.width='100%',fig.cap="Overview of a Monte Carlo model assessing biomass accumulation during crop development in flood-based farming systems in the Tigray region of Ethiopia and Kisumu County in Kenya. Gray-bordered nodes are taken at initial stage. Blue-bordered nodes are taken at development stage. Dashed and plain lines nodes, respectively, are elicited and computed."}
knitr::include_graphics("Modelling_FBFS_files/figure-latex/fig7-plot-1.pdf")
```

The probabilistic assessment of crop biomass shows that simulated actual biomass yield, as well as the other yield metrics, were affected by several risk factors (Figure \@ref(fig:fig8)), some of which are specific to FBFS. Farms generally have a high probability of relatively low yield, which varies substantially over time and in response to differing levels of farming constraints.

Based on computed 90% confidence intervals, the exploitable yield gap, the actually exploited yield gap, and the expected yield can differ by a factor of two between situations with high and low farming constraints. The exploitable yield gap and loss due to farming constraints are substantial, indicating great potential for yield improvement. Exploitable yield loss is positively correlated with farming constraints, with a high chance of zero loss under minimal farming constraints. Simulation results show right-skewed gamma distributions (Figure \@ref(fig:fig8)) indicating that crop yields in the study area are characterized by a relatively high frequency of low values. This highlights important uncertainty regarding yield expectations in the study areas. In general, chances of grain yield above 5 t/ha are negligible.


```{r case-study-2-Results-rds,eval=TRUE,include=FALSE,echo=FALSE,cache=FALSE}

## Obversed and potential grain yield for various rainfed crops near kisumu county and tigray region ####
source("data_files/yield.R")

## relative biomass accumulation accross development stages
stage_ratio = c(initial_stage = 0.10,  development_stage = 0.80, mid_stage = 0.95, late_stage = 1)

## proportion of grain yield relative to biomass yield #####
harvest_index = c(0.1, 0.3)

## A function for making an informed guess of biomass yield at each stage ####
## This can also be used as checklist for the final prediction
guess_biomass_yield <- function(grain_yield_pot, 
                               # harvest_index = c(0.1, 0.3),
                               stage_ratio = c(initial_stage = 0.10,  development_stage = 0.80, mid_stage = 0.95, late_stage = 1)){
  # harvest_index <- runif(1000, harvest_index[1], harvest_index[2]) #
  # total_biomass_pot <- sapply(harvest_index, function(i){
  #   grain_yield_pot/i
  # })
  
  total_biomass_pot <- sapply(stage_ratio, function (i){
    # total_biomass_pot*i
    grain_yield_pot*i
  }, simplify = TRUE, USE.NAMES = TRUE)
  as.data.frame(na.omit(total_biomass_pot))
}


# bn nodes estimates ####

# bn nodes estimates ####

Local_constraints_at_initial_stage_estimates <- make_node_states_estimates(bn=network_bn_fit, node='Local_constraints_at_initial_stage', op = 'proba', distr = c('beta', 'unif', 'unif'), state_effects = c(0.9, 0.6, 0.1)) # , state_effects = c(0.9, 0.6, 0.1) # c(0.6, 0.3, 0.1)
Local_constraints_at_development_stage_estimates <- make_node_states_estimates(bn=network_bn_fit, node='Local_constraints_at_development_stage', op = 'proba', distr = c('beta', 'unif', 'unif'), state_effects = c(0.9, 0.6, 0.1))

Local_constraints_at_mid_stage_estimates <- make_node_states_estimates(bn=network_bn_fit, node='Local_constraints_at_mid_stage', op = 'proba', distr = 'beta', state_effects = c(0.9, 0.6, 0.1))
Local_constraints_at_late_stage_estimates <- make_node_states_estimates(bn=network_bn_fit, node='Local_constraints_at_late_stage', op = 'proba', distr = 'beta', state_effects = c(0.9, 0.6, 0.1))

## yield potential estimate #####
mc_nodes_estimates_biomass_yield_pot <- guess_decisionSupport_estimates (data = list(potential_grain_yield, 
                                                                                     # harvest_index = harvest_index, 
                                                                                     stage_ratio = stage_ratio), 
                                                                         fun = guess_biomass_yield,
                                                                         distr = rep('gamma', 4), 
                                                                         percentiles = c(0.025, 0.5, 0.975), 
                                                                         plot = FALSE, show.output = FALSE)
rownames(mc_nodes_estimates_biomass_yield_pot$marginal) <- paste0('biomass_Yield_Pot_', rownames(mc_nodes_estimates_biomass_yield_pot$marginal))

## Attainable yield estimates : Median, Lowest and Highest ####

mc_nodes_lower_exploitable_biomass_yield_pot <- data.frame(lower = c(initial_stage = 0.85-0.35, mid_stage = 0.80-0.35, development_stage = 0.75-0.35, late_stage = 0.70-0.35),
                                                           median = c(initial_stage = 0.89-0.35, mid_stage = 0.87-0.35, development_stage = 0.80-0.35, late_stage = 0.71-0.35),
                                                           upper = c(initial_stage = 0.90-0.35, mid_stage = 0.90-0.35, development_stage = 0.90-0.35, late_stage = 0.90-0.35),
                                                           distribution = c(initial_stage = 'unif', mid_stage = 'unif', development_stage = 'unif', late_stage = 'unif'),
                                                           method = c(initial_stage = 'fit', mid_stage = 'fit', development_stage = 'fit', late_stage = 'fit'),
                                                           stringsAsFactors = FALSE)

rownames(mc_nodes_lower_exploitable_biomass_yield_pot) <- paste0('lower_exploitable_biomass_yield_pot_', rownames(mc_nodes_lower_exploitable_biomass_yield_pot))
mc_nodes_lower_exploitable_biomass_yield_pot <- as.estimate(mc_nodes_lower_exploitable_biomass_yield_pot)

mc_nodes_mid_exploitable_biomass_yield_pot <-  data.frame(lower = c(initial_stage = 0.85-0.15, mid_stage = 0.80-0.15, development_stage = 0.75-0.15, late_stage = 0.70-0.15),
                                                          median = c(initial_stage = 0.89-0.15, mid_stage = 0.87-0.15, development_stage = 0.80-0.15, late_stage = 0.71-0.15),
                                                          upper = c(initial_stage = 0.90-0.15, mid_stage = 0.90-0.15, development_stage = 0.90-0.15, late_stage = 0.90-0.15),
                                                          distribution = c(initial_stage = 'unif', mid_stage = 'unif', development_stage = 'unif', late_stage = 'unif'),
                                                          method = c(initial_stage = 'fit', mid_stage = 'fit', development_stage = 'fit', late_stage = 'fit'),
                                                          stringsAsFactors = FALSE)

rownames(mc_nodes_mid_exploitable_biomass_yield_pot) <- paste0('mid_exploitable_biomass_yield_pot_', rownames(mc_nodes_mid_exploitable_biomass_yield_pot))
mc_nodes_mid_exploitable_biomass_yield_pot <- as.estimate(mc_nodes_mid_exploitable_biomass_yield_pot)


mc_nodes_upper_exploitable_biomass_yield_pot <- data.frame(lower = c(initial_stage = 0.85, mid_stage = 0.80, development_stage = 0.75, late_stage = 0.70),
                                                           median = c(initial_stage = 0.89, mid_stage = 0.87, development_stage = 0.80, late_stage = 0.71),
                                                           upper = c(initial_stage = 0.90, mid_stage = 0.90, development_stage = 0.90, late_stage = 0.90),
                                                           distribution = c(initial_stage = 'unif', mid_stage = 'unif', development_stage = 'unif', late_stage = 'unif'),
                                                           method = c(initial_stage = 'fit', mid_stage = 'fit', development_stage = 'fit', late_stage = 'fit'),
                                                           stringsAsFactors = FALSE)
rownames(mc_nodes_upper_exploitable_biomass_yield_pot) <- paste0('upper_exploitable_biomass_yield_pot_', rownames(mc_nodes_upper_exploitable_biomass_yield_pot))
mc_nodes_upper_exploitable_biomass_yield_pot <- as.estimate(mc_nodes_upper_exploitable_biomass_yield_pot)

mc_nodes_exploitable_biomass_yield_pot <- list(mc_nodes_lower_exploitable_biomass_yield_pot, mc_nodes_mid_exploitable_biomass_yield_pot, mc_nodes_upper_exploitable_biomass_yield_pot)

## Average yield estimates: Median, Lowest and Highest ####

cond <- get_boxplot_range_1d (observed_actual_grain_yield)
mc_nodes_lower_average_actu_biomass_yield <- observed_actual_grain_yield[observed_actual_grain_yield >= cond[1] & observed_actual_grain_yield < cond[3]]
mc_nodes_mid_average_actu_biomass_yield <- observed_actual_grain_yield[observed_actual_grain_yield >= cond[3] & observed_actual_grain_yield < cond[5]]
mc_nodes_upper_average_actu_biomass_yield <- observed_actual_grain_yield[observed_actual_grain_yield >= cond[5] & observed_actual_grain_yield < cond[7]]

mc_nodes_lower_average_actu_biomass_yield <- guess_decisionSupport_estimates (data = list(mc_nodes_lower_average_actu_biomass_yield, 
                                                                                          # harvest_index = harvest_index,
                                                                                          stage_ratio = stage_ratio), fun=guess_biomass_yield, distr = rep('gamma', 4),
                                                                              percentiles = c(0.025, 0.5, 0.975), plot = FALSE, show.output = FALSE)
rownames(mc_nodes_lower_average_actu_biomass_yield$marginal) <- paste0('lower_average_Actual_yield_', rownames(mc_nodes_lower_average_actu_biomass_yield$marginal))


mc_nodes_mid_average_actu_biomass_yield <- guess_decisionSupport_estimates (data = list(mc_nodes_mid_average_actu_biomass_yield, 
                                                                                        # harvest_index = harvest_index,
                                                                                        stage_ratio = stage_ratio), fun=guess_biomass_yield, distr = rep('gamma', 4),
                                                                            percentiles = c(0.025, 0.5, 0.975), plot = FALSE, show.output = FALSE)
rownames(mc_nodes_mid_average_actu_biomass_yield$marginal) <- paste0('mid_average_Actual_yield_', rownames(mc_nodes_mid_average_actu_biomass_yield$marginal))


mc_nodes_upper_average_actu_biomass_yield <- guess_decisionSupport_estimates (data = list(mc_nodes_upper_average_actu_biomass_yield, 
                                                                                          # harvest_index = harvest_index,
                                                                                          stage_ratio = stage_ratio), fun=guess_biomass_yield, distr = rep('gamma', 4),
                                                                              percentiles = c(0.025, 0.5, 0.975), plot = FALSE, show.output = FALSE)
rownames(mc_nodes_upper_average_actu_biomass_yield$marginal) <- paste0('upper_average_Actual_yield_', rownames(mc_nodes_upper_average_actu_biomass_yield$marginal))
mc_nodes_average_actu_biomass_yield <- list(mc_nodes_lower_average_actu_biomass_yield, mc_nodes_mid_average_actu_biomass_yield, mc_nodes_upper_average_actu_biomass_yield)


## associate average yield and the exploitable yield potential to their corresponding BNs nodes ####

tmp <- 1:length(Local_constraints_at_initial_stage_estimates)
names(tmp) <- names(Local_constraints_at_initial_stage_estimates)
est_int <- sapply(X=tmp, function(i){
  rbind (Local_constraints_at_initial_stage_estimates [[i]],
         mc_nodes_estimates_biomass_yield_pot, 
         mc_nodes_exploitable_biomass_yield_pot[[i]],
         mc_nodes_average_actu_biomass_yield[[i]]
  )
}, simplify = FALSE, USE.NAMES = TRUE)

## Biomass yield at dev stage #####

mc_nodes_biomass_exp_factor_dev <- estimate(distribution = 'gamma', lower = 0, median = 0.725, upper = 0.850, variable= 'biomass_exp_factor_dev', method = 'fit')

est_dev <- lapply(X=Local_constraints_at_development_stage_estimates, FUN = function(i){
  lapply(est_int, FUN = rbind,
         i,
         mc_nodes_biomass_exp_factor_dev)
})

## Biomass yield at mid stage #####

mc_nodes_biomass_exp_factor_mid <- estimate(distribution = 'gamma', lower = 0, median = 0.900, upper = 0.950, variable= 'biomass_exp_factor_mid', method = 'fit')

est_mid <- lapply(X=Local_constraints_at_mid_stage_estimates, FUN = function(i){
  lapply(est_dev, function(j) {
    lapply(j, function (k){
      rbind(k, i, mc_nodes_biomass_exp_factor_mid)
    })
  })
})

## Biomass yield at late stage #####

mc_nodes_biomass_exp_factor_late <- estimate(distribution = 'gamma', lower = 0, median = 0.975, upper = 1, variable= 'biomass_exp_factor_late', method = 'fit')
mc_nodes_harvest_index <- estimate(distribution = 'unif', lower = 0.1, median=0.2, upper = 0.3, variable= 'harvest_index', method = 'fit')
mc_nodes_biomass_exp_factor_init <- estimate(distribution = 'gamma', lower = 0, median = 0.090, upper = 0.100, variable= 'biomass_exp_factor_init', method = 'fit')

est_late <- lapply(X=Local_constraints_at_late_stage_estimates, FUN = function(i){
  lapply(est_mid, function(j) {
    lapply(j, function(k){
      lapply(k, function (l){
        rbind(l, i, 
              mc_nodes_biomass_exp_factor_late, 
              mc_nodes_harvest_index, 
              mc_nodes_biomass_exp_factor_init)
      })
    })
  })
})


## Running the MC similation ####

model_function <- function(x){
  # initial stage 
  attainable_yield_at_initial_stage <- x[,2] * x[, 6] 
  exploitable_yield_gap_at_initial_stage <- attainable_yield_at_initial_stage - x[,10]
  ##############################################################################################
  exploitable_yield_gap_at_initial_stage <- ifelse(exploitable_yield_gap_at_initial_stage < 0, 0, exploitable_yield_gap_at_initial_stage) # because average yield cannot go beyond attainable. 
  ##############################################################################################
  exploitable_yield_gap_loss_due_to_constraints_at_initial_stage <- exploitable_yield_gap_at_initial_stage * x[, 1]
    ##############################################################################################
  exploitable_yield_gap_loss_due_to_constraints_at_initial_stage <- ifelse(exploitable_yield_gap_loss_due_to_constraints_at_initial_stage <= exploitable_yield_gap_at_initial_stage, exploitable_yield_gap_loss_due_to_constraints_at_initial_stage, exploitable_yield_gap_at_initial_stage) # because exploitable_yield_gap_loss_due_to_constraints_at_initial_stage cannot exceed the exploitable_yield_gap_at_initial_stage itself.
    ##############################################################################################
  actually_exploited_yield_gap_at_initial_stage <- exploitable_yield_gap_at_initial_stage - exploitable_yield_gap_loss_due_to_constraints_at_initial_stage
  expected_actual_yield_at_initial_stage <- actually_exploited_yield_gap_at_initial_stage + x[, 10]
  
  ##############################################################################################
  expected_actual_yield_at_initial_stage <- ifelse(expected_actual_yield_at_initial_stage > attainable_yield_at_initial_stage, attainable_yield_at_initial_stage, expected_actual_yield_at_initial_stage) # becuase yield expectation cannot go beyond the attainable limit.
  ##############################################################################################
  
  initial_stage = list(
    # attainable_yield_at_initial_stage = attainable_yield_at_initial_stage,
    exploitable_yield_gap_at_initial_stage = exploitable_yield_gap_at_initial_stage,
    exploitable_yield_gap_loss_due_to_constraints_at_initial_stage = exploitable_yield_gap_loss_due_to_constraints_at_initial_stage,
    actually_exploited_yield_gap_at_initial_stage = actually_exploited_yield_gap_at_initial_stage,
    expected_actual_yield_at_initial_stage=expected_actual_yield_at_initial_stage)
  
  # dev stage
  exploitable_yield_gap_at_development_stage <- exploitable_yield_gap_at_initial_stage + (exploitable_yield_gap_at_initial_stage * x[,15])
  # exploitable_yield_gap_at_development_stage <- (exploitable_yield_gap_at_initial_stage * x[,15])/x[, 21]
  exploitable_yield_gap_loss_due_to_constraints_at_development_stage <- exploitable_yield_gap_at_development_stage * x[, 14]
      ##############################################################################################
  exploitable_yield_gap_loss_due_to_constraints_at_development_stage <- ifelse(exploitable_yield_gap_loss_due_to_constraints_at_development_stage <= exploitable_yield_gap_at_development_stage, exploitable_yield_gap_loss_due_to_constraints_at_development_stage, exploitable_yield_gap_at_development_stage) # because exploitable_yield_gap_loss_due_to_constraints_at_development_stage cannot exceed the exploitable_yield_gap_at_development_stage itself.
    ##############################################################################################
  actually_exploited_yield_gap_at_development_stage <- exploitable_yield_gap_at_development_stage - exploitable_yield_gap_loss_due_to_constraints_at_development_stage
  # expected_actual_yield_at_development_stage <- actually_exploited_yield_gap_at_development_stage + (expected_actual_yield_at_initial_stage * x[, 15])
    expected_actual_yield_at_development_stage <- actually_exploited_yield_gap_at_development_stage + (expected_actual_yield_at_initial_stage * x[, 15])

  dev_stage = list(exploitable_yield_gap_at_development_stage = exploitable_yield_gap_at_development_stage,
                   exploitable_yield_gap_loss_due_to_constraints_at_development_stage = exploitable_yield_gap_loss_due_to_constraints_at_development_stage,
                   actually_exploited_yield_gap_at_development_stage = actually_exploited_yield_gap_at_development_stage,
                   expected_actual_yield_at_development_stage = expected_actual_yield_at_development_stage)
  
  # mid stage
  exploitable_yield_gap_at_mid_stage <- exploitable_yield_gap_at_development_stage + exploitable_yield_gap_at_development_stage * x[,17]
  exploitable_yield_gap_loss_due_to_constraints_at_mid_stage <- exploitable_yield_gap_at_mid_stage * x[, 16]
  ##############################################################################################
  exploitable_yield_gap_loss_due_to_constraints_at_mid_stage <- ifelse(exploitable_yield_gap_loss_due_to_constraints_at_mid_stage <= exploitable_yield_gap_at_mid_stage, exploitable_yield_gap_loss_due_to_constraints_at_mid_stage, exploitable_yield_gap_at_mid_stage) # because exploitable_yield_gap_loss_due_to_constraints_at_mid_stage cannot exceed the exploitable_yield_gap_at_mid_stage itself.
    ##############################################################################################
  actually_exploited_yield_gap_at_mid_stage <- exploitable_yield_gap_at_mid_stage - exploitable_yield_gap_loss_due_to_constraints_at_mid_stage
  expected_actual_yield_at_mid_stage <-  actually_exploited_yield_gap_at_mid_stage + (expected_actual_yield_at_development_stage * x[, 17])
  
  mid_stage = list(exploitable_yield_gap_at_mid_stage = exploitable_yield_gap_at_mid_stage,
                   exploitable_yield_gap_loss_due_to_constraints_at_mid_stage = exploitable_yield_gap_loss_due_to_constraints_at_mid_stage,
                   actually_exploited_yield_gap_at_mid_stage = actually_exploited_yield_gap_at_mid_stage,
                   expected_actual_yield_at_mid_stage = expected_actual_yield_at_mid_stage)
  
  # late stage
  exploitable_yield_gap_at_late_stage <- exploitable_yield_gap_at_mid_stage + exploitable_yield_gap_at_mid_stage * x[,19]
  exploitable_yield_gap_loss_due_to_constraints_at_late_stage <- exploitable_yield_gap_at_late_stage * x[, 18]
   ##############################################################################################
  exploitable_yield_gap_loss_due_to_constraints_at_late_stage <- ifelse(exploitable_yield_gap_loss_due_to_constraints_at_late_stage <= exploitable_yield_gap_at_late_stage, exploitable_yield_gap_loss_due_to_constraints_at_late_stage, exploitable_yield_gap_at_late_stage) # because exploitable_yield_gap_loss_due_to_constraints_at_late_stage cannot exceed the exploitable_yield_gap_at_late_stage itself.
    ##############################################################################################
  actually_exploited_yield_gap_at_late_stage <- exploitable_yield_gap_at_late_stage - exploitable_yield_gap_loss_due_to_constraints_at_late_stage
  expected_actual_yield_at_late_stage <-  actually_exploited_yield_gap_at_late_stage + (expected_actual_yield_at_mid_stage * x[,19])
  
  late_stage = list(exploitable_yield_gap_at_late_stage = exploitable_yield_gap_at_late_stage,
                    exploitable_yield_gap_loss_due_to_constraints_at_late_stage = exploitable_yield_gap_loss_due_to_constraints_at_late_stage,
                    actually_exploited_yield_gap_at_late_stage = actually_exploited_yield_gap_at_late_stage,
                    expected_actual_yield_at_late_stage = expected_actual_yield_at_late_stage)
  
  # grain yield
  actually_exploited_yield_gap = actually_exploited_yield_gap_at_late_stage * x[, 20]
  exploitable_yield_gap = exploitable_yield_gap_at_late_stage * x[, 20]
  expected_actual_yield = expected_actual_yield_at_late_stage * x[, 20]
  exploitable_yield_gap_loss_due_to_constraints = exploitable_yield_gap_loss_due_to_constraints_at_mid_stage * x[, 20]
  
  grain_yield = list(exploitable_yield_gap = exploitable_yield_gap, 
                     exploitable_yield_gap_loss_due_to_constraints = exploitable_yield_gap_loss_due_to_constraints,
                     actually_exploited_yield_gap = actually_exploited_yield_gap,
                     expected_actual_yield = expected_actual_yield)
  
  
  ## Outputs
  out <- list(initial_stage = initial_stage, dev_stage = dev_stage, mid_stage = mid_stage, 
              late_stage = late_stage, grain_yield = grain_yield)
  return(out)
}


state_ids = 1:length(est_late)
names(state_ids) <- names(est_late)

ssp <- sapply(X=state_ids, function (i) {
  sapply(est_late[[i]], function (j){
    sapply(j, function(k){
      sapply(k, function(l){
        # mcSimulation(estimate = l, model_function = model_function, state_effects = state_effects [i], numberOfModelRuns=10000, functionSyntax="matrixNames")
        mcSimulation(estimate = l, model_function = model_function, numberOfModelRuns=10000, functionSyntax="matrixNames")
        
      }, simplify = FALSE, USE.NAMES = TRUE)
    }, simplify = FALSE, USE.NAMES = TRUE)
  }, simplify = FALSE, USE.NAMES = TRUE)
}, simplify = FALSE, USE.NAMES = TRUE)

saveRDS(ssp, paste0("output_files", "/", "Modelling_FBFS_model_RAW_predictions_Case_study_2.rds"))
```

```{r case-study-2-Results:Biomass-yield-at-Initial-stage,include=FALSE,echo=FALSE,cache=FALSE}
ssp<- readRDS(paste0("output_files", "/", "Modelling_FBFS_model_RAW_predictions_Case_study_2.rds"))

## ggplotting the similations ####

## General settings for all plotting options ####

p = ggplot_mc_dens(ssp, 
                   colorQuantile = c("red", "green", "green", "green", "green", "green", "red1"),
                   
                   # colorQuantile = c("GRAY46", "lavender", "lavender", "lavender", "lavender", "lavender", "GRAY47"),
                   colorProbability = c(1.00,    0.95,     0.75,     0.55,         0.45,     0.25,     0.05))

gg_data <- p$data

saveRDS(gg_data, paste0("output_files", "/", "Modelling_FBFS_model_predictions_Case_study_2.rds"))

y_scaleFUN <- function(x) sprintf("%.2f", x)
x_scaleFUN <- function(x) sprintf("%.0f", x)

scale_fun <- function(gg_obj, new_data, split_column, facet_column) {
  if (!is.null(new_data)){
    p <- p %+% new_data
  } else {
    p <- gg_obj
  }
  sapply(unique(p$data[[split_column]]), function(i){
    # p$data[[facet_column]] <- factor(p$data[[facet_column]], levels = unique(p$data[[facet_column]]))
    p_data <- p$data[grepl(i, p$data[[split_column]]), ]
    data_list <- split(p_data, p_data[[facet_column]])
    my_fill <- lapply(data_list, function (x){
      scale_fill_identity(NULL, labels = x$color_equiv, breaks = x$color,
                          guide = 'none', drop = FALSE)
    })
    p_i = p %+% p_data +
      scale_x_continuous(
        labels = y_scaleFUN, 
        expand = c(0,0)
      )+
      scale_y_continuous(
        labels = x_scaleFUN, 
        expand = c(0,0)
      )+
      my_fill+
      my_theme + 
      theme(axis.title = element_blank(),
            plot.subtitle=element_text(color='darkgray'))+
      labs(subtitle = gsub("_", " ", gsub("initial_stage.|at_initial_stage|dev_stage.|at_development_stage|mid_stage.|at_mid_stage|late_stage.|at_late_stage|grain_yield.", "", i)))
    p_i +     scale_x_continuous(
      labels = x_scaleFUN, 
      expand = c(0,0)
    )+
      scale_y_continuous(
        labels = y_scaleFUN, 
        expand = c(0,0))
  }, simplify = FALSE, USE.NAMES = TRUE)
}

grid_fun <- function(gg_list) {
  tmp <- 1:length(gg_list)
  names(tmp) <- names(gg_list)
  sapply(tmp, function(i){
    if (i == 1){
      gg_list[[i]] +
        my_theme+
        theme(
          # strip.background = element_rect(fill='lightgoldenrodyellow'),
          plot.title = element_blank(),
          axis.title = element_blank(),
          plot.margin=unit(c(1, 1, 0, 0), "pt"),
          strip.text = element_text(colour = 'black', size = 7),
          axis.text = element_text(size = plot_font_size-1),
          strip.text.x = element_text(margin = margin(t=1, b = 1))
          
        )
    } else {
      gg_list[[i]]+ guides(fill = FALSE)+
        my_theme +
        theme(
          plot.title = element_blank(),
          strip.text = element_blank(),
          strip.background = element_blank(),
          plot.margin=unit(c(5, 1, 0, 0), "pt"),
          # panel.border = element_rect(fill=NA, size = 0.05),
          # panel.grid.major = element_line(size = 0.05),
          # panel.grid.minor = element_line(size = 0.02),
          axis.title = element_blank(),
          axis.text = element_text(size = plot_font_size-1),
          strip.text.x = element_text(margin = margin(t=1, b = 1))
        )
    }
  }, simplify = FALSE, USE.NAMES = TRUE)
}

limits_fun <- function(gg_list, facet_column){
  sapply(gg_list, function(i){
    gg_data <- i$data
    ids <- unique(gg_data[[facet_column]])
    names(ids) <- ids
    sapply(ids, function(j){
      tmp <- gg_data[gg_data[[facet_column]] == j, 'y']
      range(tmp)
    })
  }, simplify = F)
}
## Biomass yield at initial stage ####
dat <- gg_data[grepl("initial_stage.", gg_data$L5), ]
dat$L5 <- factor(dat$L5, levels = unique(dat$L5))
dat <- split(dat, dat$L5)
tmp <- 1:length(dat)
names(tmp) <- names(dat)
# min_y <- c(0.003, 0.04, 0.003, 0.003)
# dat <- sapply(tmp, function(i){
#   dat[[i]] [dat[[i]]$y > min_y[i], ]
# }, simplify = FALSE, USE.NAMES = TRUE)
dat <- do.call(rbind, dat)

# dat$L4 <- factor(dat$L4, levels = unique(dat$L4))
# p1 <- grid_fun(scale_fun(gg_obj = p, new_data = dat, split_column = 'L5', facet_column = 'L4'))

# labeller0 <- unique(gg_data$L4)
# labeller1 <- gsub(pattern = 'at_initial_stage', replacement = '', labeller0)
# labeller1 <- gsub(pattern = 'Local', replacement = 'Farming', labeller1)
# labeller1 <- gsub(pattern = '_', replacement = ' ', labeller1)
# labeller1 <- gsub(pattern = '=', replacement = ' = ', labeller1)
# names(labeller1) <- labeller0

dat$L4 <- gsub(pattern = 'Local_constraints_', replacement = "{bold('FC'", dat$L4)
dat$L4 <- gsub(pattern = 'at_late_stage', replacement = "[italic(iiii)]", dat$L4)

dat$L4 <- gsub(pattern = 'at_mid_stage', replacement = "[italic(iii)]", dat$L4)
dat$L4 <- gsub(pattern = 'at_development_stage', replacement = "[italic(ii)]", dat$L4)
dat$L4 <- gsub(pattern = 'at_initial_stage', replacement = "[italic(i)]", dat$L4)
dat$L4 <- gsub(pattern = '=', replacement = "==", dat$L4)
dat$L4 <- gsub(pattern = '/', replacement = ")} / ", dat$L4)
dat$L4 <- paste0(dat$L4, ")}")
dat$L4 <- gsub(pattern = 'Medium', replacement = 'Mid', dat$L4)

dat$L4 <- factor(dat$L4, levels = unique(dat$L4))
levels(dat$L4) <- c('High', 'Medium', 'Low')

dat$facet_twick <- rep("{bold('Farming constraints during the initial stage')}", nrow(dat))

p1 <- grid_fun(scale_fun(gg_obj = p, new_data = dat, split_column = 'L5', facet_column = 'L4'))

## facet_wrap with ribbon ####

x_limits <- list(c(-0.50, 4.00), 
                 c(-0.10, 10.00), 
                 c(-0.50, 4.00),
                 c(-0.75, 4.00))

x_breaks <- list(seq(0.00, 4.00, by=1.00),
                 seq(0.00, 10.00, by=5.00),
                 seq(0.00, 4.00, by=1.00),
                 seq(0.00, 4.00, by=1.00))

tmp <- 1:length(p1)
names(tmp) <- names(p1)
p1 <- sapply(X = tmp, function(i) {
  p_i <- p1[[i]] + 
    # geom_line(aes(y = y))+
    # geom_ribbon(aes(ymin = 0, ymax = y, fill = color), alpha = 0.5) +
    aes(x, y, fill = color, color = color)+
    # scale_y_continuous(position = "right")+
    scale_fill_identity(NULL, labels = p1[[1]]$data$color_equiv, 
                        breaks = p1[[1]]$data$color, guide = "legend", drop = FALSE)+
    scale_color_identity(NULL, labels = p1[[1]]$data$color_equiv, 
                         breaks = p1[[1]]$data$color, guide = "legend", drop = FALSE)+
    facet_wrap(.~facet_twick+L4, nrow= 1, labeller = label_parsed, scales = "free_x")+
     
    theme(legend.position = "none")
  p_i_subtitle <- ggplot_build(p_i)$plot$labels$subtitle
  p_i_subtitle <- strwrap(p_i_subtitle, width=18)
  p_i_subtitle <- paste0(p_i_subtitle, collapse = '\n')
  p_i_subtitle <- grid::textGrob(p_i_subtitle, rot = 0,
                           gp = gpar(fontfamily=plots_font_family,fontsize=plot_font_size, col="black"))
  
  if (i==2){
    p_i <- p_i +
      scale_x_continuous(breaks = x_breaks[[i]], limits = x_limits[[i]], labels = x_scaleFUN)+
      # scale_y_continuous(labels = x_scaleFUN) # use only 1 digit for this one to fit the figures on grid.
      scale_y_continuous(position = "right", labels = function(x) sprintf("%.1f", x)) # use only 1 digit for this one to fit the figures on grid.
    
    p_i
  } else {
    if (i == 1){
      p_i <- p_i +
        ggnomics::facet_nested(.~facet_twick+L4,
                               # nrow= 1,
                               labeller = label_parsed, scales = "free_x")+
        
        scale_x_continuous(breaks = x_breaks[[i]], limits = x_limits[[i]], labels = x_scaleFUN)+
        scale_y_continuous(position = "right", breaks = c(0, 0.5, 1), labels = y_scaleFUN)+ # making some space for this one as labels overlap.
                theme(strip.text = element_text(size = plot_font_size, face = "italic"))
    } else {
      p_i <- p_i +
        scale_x_continuous(breaks = x_breaks[[i]], limits = x_limits[[i]], labels = x_scaleFUN)+
        scale_y_continuous(position = "right", labels = y_scaleFUN)
    }
    p_i
  }
  return(grid.arrange(p_i_subtitle, p_i+
                        theme(plot.subtitle = element_blank(),
                              panel.spacing = unit(0.2,"line")
                        ), 
                      layout_matrix = cbind(1, 2, 2, 2, 2, 2)))
}, simplify = FALSE, USE.NAMES = T)


p1$ncol=1

p1$top = grid::textGrob("Initial crop development stage",
                        x=0, hjust=0, vjust=0.5,
                        gp = gpar(fontfamily=plots_font_family,fontsize=plot_font_size+4,fontface="bold", col="black"))

p1$right = grid::textGrob("Density", rot = 90,  
                         gp = gpar(fontfamily=plots_font_family,fontsize=plot_font_size, col="black"))

p1$bottom <-  grid::textGrob("Biomass stock (Mg/ha)", 
                             gp = gpar(fontfamily=plots_font_family,fontsize=plot_font_size,  col="black"))
p1$layout_matrix = rbind(1,1,1,1,2,2,2,3,3,3,4,4,4)

grid.newpage()
ga = do.call("grid.arrange", p1)
gb = grid.rect(.5,.5,width=unit(1,"npc"), height=unit(1,"npc"), 
               gp=gpar(lwd=1, fill=NA, col="lightgray"))
g1 <- gTree(children = gList(ga, gb))
ggsave(plot=g1, device = 'png', filename = "figures/Modelling_FBFS_biomass_yield_initial_stage.png", width = max_plots_width_in, 
       height =max_plots_height_in/2.25, units = "in", dpi = min_plots_res)

```

```{r case-study-2-Results:Biomass-yield-at-Late-stage,include=FALSE,echo=FALSE,cache=FALSE}


## Biomass yield at Late stage ####
dat <- gg_data[grepl("late_stage.", gg_data$L5), ]
dat$L5 <- factor(dat$L5, levels = unique(dat$L5))

dat$facet_query <- paste(dat$L1, dat$L2, dat$L3, dat$L4, sep = " / ")
dat$facet_query <- gsub(pattern = 'Local_constraints_', replacement = "{bold('FC'", dat$facet_query)
dat$facet_query <- gsub(pattern = 'at_late_stage', replacement = "[italic(iiii)]", dat$facet_query)

dat$facet_query <- gsub(pattern = 'at_mid_stage', replacement = "[italic(iii)]", dat$facet_query)
dat$facet_query <- gsub(pattern = 'at_development_stage', replacement = "[italic(ii)]", dat$facet_query)
dat$facet_query <- gsub(pattern = 'at_initial_stage', replacement = "[italic(i)]", dat$facet_query)
dat$facet_query <- gsub(pattern = '=', replacement = "==", dat$facet_query)
dat$facet_query <- gsub(pattern = '/', replacement = ")} / ", dat$facet_query)
dat$facet_query <- paste0(dat$facet_query, ")}")
cond <- (dat$L1 == "Local_constraints_at_late_stage=High" & dat$L2 == "Local_constraints_at_mid_stage=High" & dat$L3 == "Local_constraints_at_development_stage=High" & dat$L4 == "Local_constraints_at_initial_stage=High")|
  (dat$L1 == "Local_constraints_at_late_stage=Medium" & dat$L2 == "Local_constraints_at_mid_stage=Medium" & dat$L3 == "Local_constraints_at_development_stage=Medium" & dat$L4 == "Local_constraints_at_initial_stage=Medium")|
  (dat$L1 == "Local_constraints_at_late_stage=Low" & dat$L2 == "Local_constraints_at_mid_stage=Low" & dat$L3 == "Local_constraints_at_development_stage=Low" & dat$L4 == "Local_constraints_at_initial_stage=Low")

dat <- dat[cond, ]

dat$facet_query <- gsub(pattern = 'Medium', replacement = 'Mid', dat$facet_query)


dat$facet_query <- factor(dat$facet_query, levels = unique(dat$facet_query)[c(3, 1, 2)])
levels(dat$facet_query) <- c('High', 'Medium', 'Low')

dat <- split(dat, dat$L5)
tmp <- 1:length(dat)
names(tmp) <- names(dat)
# min_y <- c(0.00095, 0.015, 0.001, 0.0005)
# 
# # min_y <- c(0.001, 0.01, 0.001, 0.001)
# dat <- sapply(tmp, function(i){
#   dat[[i]] [dat[[i]]$y > min_y[i], ]
# }, simplify = FALSE, USE.NAMES = TRUE)
dat <- do.call(rbind, dat)

## facet_wrap with ribbon ####

x_limits <- list(c(-2.50, 20.00),
                 c(-0.50, 15.00),
                 c(-2.00, 20.00),
                 c(-3.00, 30.00))

x_breaks <- list(seq(0.00, 20.00, by=10.00),
                 seq(0.00, 15.00, by=5.00),
                 seq(0.00, 20.00, by=10.00),
                 seq(0.00, 30.00, by=10.00))

dat$facet_twick <- rep("{bold('Farming constraints during the initial, development, mid, and late stages')}", nrow(dat))
p1 <- grid_fun(scale_fun(gg_obj = p, new_data = dat, split_column = 'L5', facet_column = 'facet_query'))

tmp <- 1:length(p1)
names(tmp) <- names(p1)


p1 <- sapply(X = tmp, function(i) {
  p_i <- p1[[i]] + 
    # geom_line(aes(y = y))+
    # geom_ribbon(aes(ymin = 0, ymax = y, fill = color), alpha = 0.5) +
    aes(x, y, fill = color, color = color)+
    # scale_y_continuous(position = "right")+
    scale_fill_identity(NULL, labels = p1[[1]]$data$color_equiv, 
                        breaks = p1[[1]]$data$color, guide = "legend", drop = FALSE)+
    scale_color_identity(NULL, labels = p1[[1]]$data$color_equiv, 
                         breaks = p1[[1]]$data$color, guide = "legend", drop = FALSE)+
    facet_wrap(.~facet_twick+facet_query, nrow= 1, labeller = label_parsed, scales = "free_x")+
    
    theme(legend.position = "none")
  p_i_subtitle <- ggplot_build(p_i)$plot$labels$subtitle
  p_i_subtitle <- strwrap(p_i_subtitle, width=18)
  p_i_subtitle <- paste0(p_i_subtitle, collapse = '\n')
  p_i_subtitle <- grid::textGrob(p_i_subtitle, rot = 0,hjust = 0.5, vjust = 0.5,
                                 gp = gpar(fontfamily=plots_font_family,fontsize=plot_font_size, col="black"))
  
  if (i==2){
    p_i <- p_i +
      scale_x_continuous(breaks = x_breaks[[i]], limits = x_limits[[i]], labels = x_scaleFUN)+
      # scale_y_continuous(labels = x_scaleFUN) # use only 1 digit for this one to fit the figures on grid.
      scale_y_continuous(position = "right", labels = y_scaleFUN) # use only 1 digit for this one to fit the figures on grid.
    
    p_i
  } else {
    if (i == 1){
      p_i <- p_i +
        ggnomics::facet_nested(.~facet_twick+facet_query,
                               # nrow= 1,
                               labeller = label_parsed, scales = "free_x")+
        
        scale_x_continuous(breaks = x_breaks[[i]], limits = x_limits[[i]], labels = x_scaleFUN)+
        scale_y_continuous(breaks = c(0, 0.10, 0.20), position = "right", labels = y_scaleFUN)+ # making some space for this one as labels overlap.
        theme(strip.text = element_text(size = plot_font_size, face = "italic"))
    } else {
      p_i <- p_i +
        scale_x_continuous(breaks = x_breaks[[i]], limits = x_limits[[i]], labels = x_scaleFUN)+
        scale_y_continuous(position = "right", labels = y_scaleFUN)
    }
    p_i
  }
  return(grid.arrange(p_i_subtitle, p_i+
                        theme(plot.subtitle = element_blank(),
                              panel.spacing = unit(0.2,"line")
                        ), 
                      layout_matrix = cbind(1, 2, 2, 2, 2, 2)))
}, simplify = FALSE, USE.NAMES = T)



p1$ncol=1

p1$top = grid::textGrob("Late crop development stage",
                        x=0, hjust=0, vjust=0.5,
                        gp = gpar(fontfamily=plots_font_family, fontsize=plot_font_size+4, fontface = "bold", col="black"))

p1$right = grid::textGrob("Density", rot = 90,
                         gp = gpar(fontfamily=plots_font_family,fontsize=plot_font_size,  col="black"))

p1$bottom <-  grid::textGrob("Biomass stock (Mg/ha)",
                             gp = gpar(fontfamily=plots_font_family,fontsize=plot_font_size,  col="black"))
p1$layout_matrix = rbind(1,1,1,1,2,2,2,3,3,3,4,4,4)
grid.newpage()
ga = do.call("grid.arrange", p1)
gb = grid.rect(.5,.5,width=unit(1,"npc"), height=unit(1,"npc"), 
               gp=gpar(lwd=1, fill=NA, col="lightgray"))
g2 <- gTree(children = gList(ga, gb))

ggsave(plot=g2, device = 'png', filename = "figures/Modelling_FBFS_biomass_yield_late_stage.png", width = max_plots_width_in, 
       height =max_plots_height_in/2.25, units = "in", dpi = min_plots_res)

```

```{r case-study-2-Results:Biomass-yield,include=FALSE,echo=FALSE,cache=FALSE}

g <- list(g1, nullGrob(), g2)
g$heights = unit(c(1, 0.025, 1), 'null')
g$ncol=1

# g$top = grid::textGrob("The green and red colors, respectively, are values inside and outside the 90% confidence interval.",
#                         # x=1, y=0, hjust=0.5, vjust=0.5,
#                         # x=1, hjust=0, vjust = 0.5,
#                         # x=1, hjust=1, vjust = 1,
#                         # x=0.04, hjust=1, vjust = 0.5,
#                        x=1, hjust=1, vjust = 0.5,
# 
#                         gp = gpar(fontfamily=plots_font_family,fontsize=plot_font_size-1,fontface="italic", col="black"))

grid.newpage()
ga = do.call("grid.arrange", g)
gb = grid.rect(.5,.5,width=unit(1,"npc"), height=unit(1,"npc"), 
               gp=gpar(lwd=1, fill=NA, col="lightgray"))
g1 <- gTree(children = gList(ga, gb))

ggsave(plot=g1, device = 'png', filename = "figures/Modelling_FBFS_biomass_yield_Initial_and_late_stage.png", width = max_plots_width_in,
       height =2*max_plots_height_in/2.15, units = "in", dpi = min_plots_res
)
ggsave(plot=g1, device = 'pdf', filename = "figures/Modelling_FBFS_biomass_yield_Initial_and_late_stage.pdf", width = max_plots_width_in,
       height =2*max_plots_height_in/2.15, units = "in", dpi = min_plots_res
)
```

(ref:fig8) Simulated biomass yield metrics for flood-based farming systems in the Tigray region of Ethiopia and Kisumu County in Kenya. The green and red colors, respectively, are values inside and outside the 90% confidence interval.

```{r fig8, echo=FALSE,out.width='100%',fig.cap='(ref:fig8)'}
knitr::include_graphics("figures/Modelling_FBFS_biomass_yield_Initial_and_late_stage.pdf")
```

## Management module {#ref45}

The management module (Figure \@ref(fig:fig4) c) points out the agricultural management efficiency via four important sub-modules describing the general household situation, soil nutrients, pests & diseases, and weeds (Figure \@ref(fig:fig4) c; Figure \@ref(fig:fig9)). Pest & disease attacks can weaken the crop in subsequent development stages, aggravating other problems and ultimately lowering the agricultural management efficiency, particularly when the farmer lacks advanced skills in crop protection. The skill of the farmer, which is determined by the social and economic context (e.g. opportunity, willingness, and ability to purchase inputs), defines the management efficiency in terms of water and crop protection methods adopted by the farmer (Figure \@ref(fig:fig4) c).

```{r case-study-3-methods-rds-1,eval=TRUE,include=FALSE,echo=FALSE,cache=FALSE}

##Farming constraints partial  ####

net <- bnlearn::model2network("[Available_soil_nutrients_at_mid_stage][Available_soil_water_at_mid_stage][Effectiveness_of_weeding_at_mid_stage][Weed_impacts_at_development_stage][Crop_type][Effectiveness_of_pest_and_disease_reduction_practices_at_mid_stage][Pest_and_disease_impacts_at_development_stage][Weed_impacts_at_mid_stage|Effectiveness_of_weeding_at_mid_stage:Weed_impacts_at_development_stage:Crop_type][Pest_and_disease_impacts_at_mid_stage|Effectiveness_of_pest_and_disease_reduction_practices_at_mid_stage:Pest_and_disease_impacts_at_development_stage:Crop_type][Agricultural_management_efficiency_at_mid_stage|nutrient_supply_adequacy_at_mid_stage:Pest_and_disease_impacts_at_mid_stage:Weed_impacts_at_mid_stage][nutrient_supply_adequacy_at_mid_stage|Available_soil_nutrients_at_mid_stage:Crop_type][Water_supply_adequacy_at_mid_stage|Available_soil_water_at_mid_stage:Crop_type][Effectiveness_of_cropping_options|Crop_type][Local_constraints_at_mid_stage|Effectiveness_of_cropping_options:Water_supply_adequacy_at_mid_stage:Agricultural_management_efficiency_at_mid_stage][Local_constraints_at_late_stage|Effectiveness_of_cropping_options:Water_supply_adequacy_at_mid_stage:Agricultural_management_efficiency_at_mid_stage]")

net <- decisionSupportExtra::extract_bn(bn = network_bn_fit, string_model = net)
saveRDS(net, paste0("output_files", "/", "Modelling_FBFS_BNs_Case_study_3.rds"))
rm(network_bn_fit); gc(verbose=FALSE)
```

```{r case study 3 methods plot,eval=TRUE,include=FALSE,echo = FALSE, cache = FALSE}

net <- readRDS("output_files/Modelling_FBFS_BNs_Case_study_3.rds")

legende = c(AgricManagEff = "Agricultural_management_efficiency_at_mid_stage", 
            AvailSoilNut = "Available_soil_nutrients_at_mid_stage", 
            AvailSoilWater = "Available_soil_water_at_mid_stage",
            CropType = "Crop_type",
            EffCropOptions = "Effectiveness_of_cropping_options", 
            EffPestDiseaseReduc = "Effectiveness_of_pest_and_disease_reduction_practices_at_mid_stage", 
            EffWeeding = "Effectiveness_of_weeding_at_mid_stage", 
            FarmConstraintsLate = "Local_constraints_at_late_stage",
            FarmConstraints = "Local_constraints_at_mid_stage", 
            AdeqNutSupl = "nutrient_supply_adequacy_at_mid_stage",
            PestdiseaseImpactDev = "Pest_and_disease_impacts_at_development_stage",
            PestdiseaseImpact = "Pest_and_disease_impacts_at_mid_stage", 
            AdeqWatSupl = "Water_supply_adequacy_at_mid_stage", 
            WeedsImpactDev = "Weed_impacts_at_development_stage", 
            WeedsImpact = "Weed_impacts_at_mid_stage"
)

legende <- mapply(paste, names(legende), sprintf('\u2192'), legende)
legende <- gsub("_", " ",  legende)
legende <- gsub(" at mid stage", "",  legende)

bnlearn::nodes(net) <- names(legende)

png(export_fun(export = "Modelling_FBFS_Farming_Constraints"),
    res = min_plots_res,
    units = 'in',
    width = max_plots_width_in, 
    height = max_plots_height_in/2,
    pointsize = 10.5)
par(font=plots_font, family = plots_font_family, lwd=plots_lwd)

graphviz_chart_bn (x = net, type = "barprob", layout = "dot", draw.levels = TRUE,abbreviate=FALSE,
                   grid = TRUE, scale = c(max_plots_height_in/2, max_plots_width_in), col = "black", bg = "transparent",
                   text.col = "black", bar.col = "green", strip.bg = "lightyellow")
legend('bottomleft', legend = legende, text.width = 0.59*strwidth(legende[which.max(nchar(legende))]), 
       cex=0.59, ncol = 1,
       bty="o", box.lwd=1, box.col='lightyellow', xjust=1, yjust=1, bg=legend_bg,
       title = 'Legend', title.col = 'blue', inset=c(0.04, 0.08))
box(col = 'lightgray')
dev.off()
```

```{tikz fig9-plot,echo=FALSE,include=FALSE,eval=TRUE,fig.cap="Overview of causal relationships defining the farming constraints in flood-based farming systems in the Tigray region of Ethiopia and Kisumu County in Kenya.", fig.ext = 'png', cache=FALSE, eval=TRUE, engine.opts = list(engine='xetex', template = "latex/tikz2pdf.tex")}
%% Beginning of Farming Constraints BNs %%%%

\begin{tikzpicture} [node distance = 2cm]
%%%%

\node[BnsBarplotStyle] (EffPestDiseaseReduc2)  {
\nodepart{two}
\begin{tikzpicture}[use background]
\begin{axis}[AxisStyle,
                    symbolic y coords = {Poor,Good,Excellent}
                  ]

\addplot [AddPlotStyle]  coordinates { (0.162,Poor)(0.217,Good)     (0.621,Excellent)};

\end{axis}
\end{tikzpicture}
};
\tcbsetmacrotowidthofnode{\mywidth}{EffPestDiseaseReduc2}
\node[BnsBarplotTitleStyle, minimum width=\mywidth, align=center](EffPestDiseaseReduc1)[above=0pt of EffPestDiseaseReduc2]{Effectiveness of pest and disease\\ reduction practices};
%%%%


%%%%

\node[BnsBarplotStyle] (PestDiseaseImpact2) [below=of EffPestDiseaseReduc2]  {
\nodepart{two}
\begin{tikzpicture}[use background]
\begin{axis}[AxisStyle,
                    symbolic y coords = {Severe,Significant,Minor}
                  ]

\addplot [AddPlotStyle]  coordinates { (0.213,Severe)(0.190,Significant)(0.597,Minor)};

\end{axis}
\end{tikzpicture}
};
\tcbsetmacrotowidthofnode{\mywidth}{PestDiseaseImpact2}
\node[BnsBarplotTitleStyle, minimum width=\mywidth](PestDiseaseImpact1)[above=0pt of PestDiseaseImpact2]{Pest and disease impact};
%%%%


%%%%

\node[BnsBarplotStyle] (PestDiseaseImpactDev2) [below=of PestDiseaseImpact2] {
\nodepart{two}
\begin{tikzpicture}[use background]
\begin{axis}[AxisStyle,
                    symbolic y coords = {Severe,Significant,Minor}
                  ]

\addplot [AddPlotStyle]  coordinates { (0.213,Severe)(0.190,Significant)(0.597,Minor)};

\end{axis}
\end{tikzpicture}
};
\tcbsetmacrotowidthofnode{\mywidth}{PestDiseaseImpactDev2}
\node[BnsBarplotTitleStyle, minimum width=\mywidth, align=center](PestDiseaseImpactDev1)[above=0pt of PestDiseaseImpactDev2]{Pest and disease impact\\ at development stage};
%%%%

%%%%

\node[BnsBarplotStyle] (AgricManagEff2) [right=of PestDiseaseImpact2] {
\nodepart{two}
\begin{tikzpicture}[use background]
\begin{axis}[AxisStyle,
                    symbolic y coords = {Low,Medium,High}
                  ]

\addplot [AddPlotStyle]  coordinates { (0.276,Low)(0.268,Medium)(0.456,High)};

\end{axis}
\end{tikzpicture}
};
\tcbsetmacrotowidthofnode{\mywidth}{AgricManagEff2}
\node[BnsBarplotTitleStyle, minimum width=\mywidth, align=center](AgricManagEff1)[above=0pt of AgricManagEff2]{Agricultural management\\efficiency};
%%%%

%%%%

\node[BnsBarplotStyle] (AvailSoilNut2) [above=of AgricManagEff2] {
\nodepart{two}
\begin{tikzpicture}[use background]
\begin{axis}[AxisStyle,
                    symbolic y coords = {Deficient,Satisfactory,Plenty}
                  ]

\addplot [AddPlotStyle]  coordinates { (0.298,Deficient)(0.342,Satisfactory)(0.456,Plenty)};

\end{axis}
\end{tikzpicture}
};
\tcbsetmacrotowidthofnode{\mywidth}{AvailSoilNut2}
\node[BnsBarplotTitleStyle, minimum width=\mywidth](AvailSoilNut1)[above=0pt of AvailSoilNut2]{Available soil nutrients};
%%%%

%%%%

\node[BnsBarplotStyle] (WeedsImpact2)  [right=of AgricManagEff2]{
\nodepart{two}
\begin{tikzpicture}[use background]
\begin{axis}[AxisStyle,
                    symbolic y coords = {Consuming,Moderate,Negligible}
                  ]

\addplot [AddPlotStyle]  coordinates { (0.359,Consuming)(0.126,Moderate)(0.515,Negligible)};

\end{axis}
\end{tikzpicture}
};
\tcbsetmacrotowidthofnode{\mywidth}{WeedsImpact2}
\node[BnsBarplotTitleStyle, minimum width=\mywidth](WeedsImpact1)[above=0pt of WeedsImpact2]{Weed impact};
%%%%


%%%%

\node[BnsBarplotStyle] (WeedsImpactDev2)  [below=of WeedsImpact2]{
\nodepart{two}
\begin{tikzpicture}[use background]
\begin{axis}[AxisStyle,
                    symbolic y coords = {Consuming,Moderate,Negligible}
                  ]

\addplot [AddPlotStyle]  coordinates { (0.359,Consuming)(0.126,Moderate)(0.515,Negligible)};

\end{axis}
\end{tikzpicture}
};
\tcbsetmacrotowidthofnode{\mywidth}{WeedsImpactDev2}
\node[BnsBarplotTitleStyle, minimum width=\mywidth](WeedsImpactDev1)[above=0pt of WeedsImpactDev2]{Weed impact at development stage};
%%%%

%%%%

\node[BnsBarplotStyle] (EffWeeding2)  [above=of WeedsImpact1]{
\nodepart{two}
\begin{tikzpicture}[use background]
\begin{axis}[AxisStyle,
                    symbolic y coords = {Poor,Good,Excellent}
                  ]

\addplot [AddPlotStyle]  coordinates { (0.204,Poor)(0.298,Good)(0.498,Excellent)};

\end{axis}
\end{tikzpicture}
};
\tcbsetmacrotowidthofnode{\mywidth}{EffWeeding2}
\node[BnsBarplotTitleStyle, minimum width=\mywidth](EffWeeding1)[above=0pt of EffWeeding2]{Effectiveness of weeding};
%%%%

%%%%

\node[BnsBarplotStyle] (EffCropOptions2)  [below=of PestDiseaseImpactDev2]{
\nodepart{two}
\begin{tikzpicture}[use background]
\begin{axis}[AxisStyle,
                    symbolic y coords = {Inefficient,Efficient}
                  ]

\addplot [AddPlotStyle]  coordinates { (0.511,Inefficient)(0.489,Efficient)};

\end{axis}
\end{tikzpicture}
};
\tcbsetmacrotowidthofnode{\mywidth}{EffCropOptions2}
\node[BnsBarplotTitleStyle, minimum width=\mywidth](EffCropOptions1)[above=0pt of EffCropOptions2]{Effectiveness of cropping options};

%%%%

\node[BnsBarplotStyle] (CropType2)  [below=of EffCropOptions2]{
\nodepart{two}
\begin{tikzpicture}[use background]
\begin{axis}[AxisStyle,
                    symbolic y coords = {Sorghum,Maize,Teff,Rice}
                  ]

\addplot [AddPlotStyle]  coordinates { (0.300,Sorghum)(0.400,Maize)(0.100,Teff)(0.200,Rice) };

\end{axis}
\end{tikzpicture}
};
\tcbsetmacrotowidthofnode{\mywidth}{CropType2}
\node[BnsBarplotTitleStyle, minimum width=\mywidth](CropType1)[above=0pt of CropType2]{Crop type};
%%%%

%%%%

\node[BnsBarplotStyle] (FarmConstraints2) [right=of EffCropOptions2] {
\nodepart{two}
\begin{tikzpicture}[use background]
\begin{axis}[AxisStyle,
                    symbolic y coords = {High,Medium,Low}
                  ]

\addplot [AddPlotStyle]  coordinates { (0.194,High)(0.466,Medium)(0.340,Low)};

\end{axis}
\end{tikzpicture}
};
\tcbsetmacrotowidthofnode{\mywidth}{FarmConstraints2}
\node[BnsBarplotTitleStyle, minimum width=\mywidth](FarmConstraints1)[above=0pt of FarmConstraints2]{Farming constraints};
%%%%

%%%%

\node[BnsBarplotStyle] (AdeqWatSupl2) [below=of FarmConstraints2] {
\nodepart{two}
\begin{tikzpicture}[use background]
\begin{axis}[AxisStyle,
                    symbolic y coords = {Inadequate,Adequate}
                  ]

\addplot [AddPlotStyle]  coordinates { (0.481,Inadequate)(0.519,Adequate)};

\end{axis}
\end{tikzpicture}
};
\tcbsetmacrotowidthofnode{\mywidth}{AdeqWatSupl2}
\node[BnsBarplotTitleStyle, minimum width=\mywidth](AdeqWatSupl1)[above=0pt of AdeqWatSupl2]{Water supply adequacy};
%%%%


\draw[thickarrow] (WeedsImpactDev1) --  (WeedsImpact2);
\draw[thickarrow] (EffWeeding2) --  (WeedsImpact1);

\draw[thickarrow] (PestDiseaseImpactDev1) --  (PestDiseaseImpact2);
\draw[thickarrow] (EffPestDiseaseReduc2) --  (PestDiseaseImpact1);

%\draw[thickarrow] (CropType1.north west) --  (WeedsImpact2.south east);
\draw[thickes] (CropType2.south) --  ([xshift=5mm,yshift=-5mm]CropType2.south);
\draw[thickes] ([xshift=5mm,yshift=-5mm]CropType2.south) -- ([yshift=-5mm, xshift=20mm]CropType2.south-|WeedsImpact2.south east);
\draw[thickes] ([yshift=-5mm, xshift=20mm]CropType2.south-|WeedsImpact2.south east)-- ([xshift=20mm]WeedsImpact2.east);
\draw[thickarrow] ([xshift=20mm]WeedsImpact2.east) -- (WeedsImpact2.east);

\draw[thickarrow] (CropType1) --  (EffCropOptions2);
\draw[thickarrow] (CropType2) --  (AdeqWatSupl2);
\draw[thickes] (CropType2.south) --  ([xshift=-5mm,yshift=-5mm]CropType2.south);
\draw[thickes] ([xshift=-5mm,yshift=-5mm]CropType2.south) -- ([yshift=-5mm, xshift=-5mm]CropType2.south-|PestDiseaseImpact2.south west);

\draw[thickes] ([yshift=-5mm, xshift=-5mm]CropType2.south-|PestDiseaseImpact2.south west) -- ([xshift=-5mm]PestDiseaseImpact2.west);
\draw[thickarrow]([xshift=-5mm]PestDiseaseImpact2.west) -- (PestDiseaseImpact2.west);

%\draw[thickarrow, name path= EffCropOptions2 -- FarmConstraints2] (EffCropOptions2) --  (FarmConstraints2);
\draw[thickarrow] (AdeqWatSupl1) --  (FarmConstraints2);
\draw[thickarrow] (AgricManagEff2) --  (FarmConstraints1);


\draw[thickarrow] (AvailSoilNut2) --  (AgricManagEff1);
\draw[thickarrow] (WeedsImpact2) --  (AgricManagEff2);
\draw[thickarrow] (PestDiseaseImpact2) --  (AgricManagEff2);

\node[draw=none, fill=none](FakeNode1) at ($(EffCropOptions1.north east)!0.4!(FarmConstraints1.north west)$) {};

%%%%

\node[BnsBarplotStyle] (AvailSoilWater2) [right=of AdeqWatSupl2] {
\nodepart{two}
\begin{tikzpicture}[use background]
\begin{axis}[AxisStyle,
                    symbolic y coords = {Drought risk,Normal, Waterlogging risk}
                  ]

\addplot [AddPlotStyle]  coordinates { (0.077,Drought risk)(0.292,Normal)(0.631,Waterlogging risk)};

\end{axis}
\end{tikzpicture}
};
\tcbsetmacrotowidthofnode{\mywidth}{AvailSoilWater2}
\node[BnsBarplotTitleStyle, minimum width=\mywidth](AvailSoilWater1)[above=0pt of AvailSoilWater2]{Available soil water};
%%%%

% \node[draw=none, fill=none] (FakeNode2) at (AvailSoilWater2.south|-AdeqWatSupl1.west) {};
%\draw[thickes, name path=AvailSoilWater2.south -- FakeNode2] (AvailSoilWater2.south) --  (FakeNode2.center);
% \draw[thickarrow] (FakeNode2.center) -- (AdeqWatSupl1.west);


%\path [name intersections={of=AvailSoilWater2.south -- FakeNode2 and EffCropOptions2 -- FarmConstraints2, by={A}}];

% \node[rectangle, draw=white, fill=white] at (A) { };
\draw[thickarrow] (AvailSoilWater2) --  (AdeqWatSupl2);
\draw[thickarrow] (EffCropOptions2) --  (FarmConstraints2);

\node[draw=none, fill=none](Topcheckpoint)[above=0.5cm of EffWeeding1]{};
\node[draw=none, fill=none](Leftcheckpoint)[left=0.75cm of CropType2]{};
\node[draw=none, fill=none](Bottomcheckpoint)[below=0.5cm of CropType2]{};
\node[draw=none, fill=none](Rightcheckpoint)[right=0.5cm of AvailSoilWater2]{};

\draw [ultra thick, lightgray](current bounding box.north west) rectangle (current bounding box.south east);

%% The following are repeated for visibility only
%%\draw[thickes] (CropType2.south) --  ([yshift=-5mm]CropType2.south);
%%\draw[thickes] ([yshift=-5mm]CropType2.south) -- ([yshift=-5mm, xshift=-5mm]CropType2.south-|PestDiseaseImpact2.south west);

%%\draw[thickes] ([yshift=-5mm, xshift=-5mm]CropType2.south-|PestDiseaseImpact2.south west) -- ([xshift=-5mm]PestDiseaseImpact2.west);
%%\draw[thickarrow]([xshift=-5mm]PestDiseaseImpact2.west) -- (PestDiseaseImpact2.west);

%%\draw[thickes] (AgricManagEff1.north) -- ([yshift=5mm]EffWeeding1.north west-|AgricManagEff1.north);
%%\draw[thickes] ([yshift=5mm]EffWeeding1.north west-|AgricManagEff1.north) -- ([yshift=5mm]EffWeeding1.north west-|AgricManagEff1.north-|FarmConstraints1.north);
%%\draw[thickarrow] ([yshift=5mm]EffWeeding1.north west-|AgricManagEff1.north-|FarmConstraints1.north) -- (FarmConstraints1.north);

\end{tikzpicture}
%% End of Farming Constraints BNs %%%%

```

```{r fig9, echo=FALSE,out.width='100%',fig.cap="Overview of causal relationships defining the farming constraints in flood-based farming systems in the Tigray region of Ethiopia and Kisumu County in Kenya."}
knitr::include_graphics("Modelling_FBFS_files/figure-latex/fig9-plot-1.pdf")
```

The impacts of soil water and biotic stresses on grain yield suggest that crops subjected to strong farming constraints during early growth are likely to experience slow growth over the entire season. This cumulative effect of farming constraints seems to cause important biomass losses, which translate into low yields. Grain yield is very low when the late stage constraints are high, regardless of the states of pests & diseases or water at the previous stages. Under such conditions, grain yield in both crops rarely exceeds 1 ton/ha. Grain yield expectations are generally higher in sorghum and more sensitive to varying levels of farming constraints. These findings highlight the importance of the early and late stage regarding grain yield in FBFS of the study areas and suggest a need for adequate management and crop protection during these critical stages of crop development. Even with good conditions at these stages, grain yields rarely reach 5 tons/ha for rice and sorghum.

```{r case study 3 results rds 1, eval=TRUE, include = FALSE, echo = FALSE, cache = FALSE}
## constructing the evidence list ####
net <- readRDS("output_files/Modelling_FBFS_BNs_Case_study_3.rds")
evidence <- c("Pest_and_disease_impacts_at_mid_stage", "Weed_impacts_at_mid_stage", "Crop_type", "Available_soil_water_at_mid_stage")

evidence <- sapply(evidence, function (i){
  out <- dimnames(net[[i]][['prob']])[[1]]
  # Consider the extremes only 
  out[c(1, length(out))]
}, simplify = FALSE)

evidence <- expand.grid(evidence)
evidence <- sapply(evidence, as.character)

make_evidence <- function(evidence_matrix){
  tmp <- 1:nrow(evidence_matrix)
  names(tmp) <- paste0('Traitment_', tmp)
  sapply(tmp, function(i){
    out <- evidence_matrix[i, ]
    names(out) <- colnames(evidence_matrix)
    out
  }, simplify = FALSE)
}

evidence_list <- make_evidence(evidence)
evidence_list_rice <- sapply(evidence_list, function(i) {
  if (i[['Crop_type']] == "Rice"){
    return(TRUE)
  } else {
    return(FALSE)
  }
})
evidence_list_sorghum <- evidence_list[!evidence_list_rice]
evidence_list_rice <- evidence_list[evidence_list_rice]
```

```{r case study 3 results rds 2, eval=TRUE, include = FALSE, echo = FALSE, cache = FALSE}
## Running the MC similation ####
model_function <- function(x){
  # initial stage
  
  attainable_yield_at_initial_stage <- x[, 2] * x[, 6]
  
  exploitable_yield_gap_at_initial_stage <- attainable_yield_at_initial_stage - x[, 10] # This holds in normal situation
  exploitable_yield_gap_at_initial_stage <- ifelse(exploitable_yield_gap_at_initial_stage < 0, 0, exploitable_yield_gap_at_initial_stage) # because average yield cannot go beyond attainable.
  bio_exp <- x[, 21] - (x[, 21] * x[, 1]) # Farming Constraints alters the normal situation assuming that crop growth depends on farming constraints
  exploitable_yield_gap_at_initial_stage <-  exploitable_yield_gap_at_initial_stage + (exploitable_yield_gap_at_initial_stage * bio_exp) #
  
  exploitable_yield_gap_loss_due_to_constraints_at_initial_stage <- exploitable_yield_gap_at_initial_stage - (exploitable_yield_gap_at_initial_stage * x[, 1])
  exploitable_yield_gap_loss_due_to_constraints_at_initial_stage <- ifelse(exploitable_yield_gap_loss_due_to_constraints_at_initial_stage <= exploitable_yield_gap_at_initial_stage, exploitable_yield_gap_loss_due_to_constraints_at_initial_stage, exploitable_yield_gap_at_initial_stage) # because exploitable_yield_gap_loss_due_to_constraints_at_initial_stage cannot exceed the exploitable_yield_gap_at_initial_stage itself.
  
  actually_exploited_yield_gap_at_initial_stage <- exploitable_yield_gap_at_initial_stage - exploitable_yield_gap_loss_due_to_constraints_at_initial_stage
  # expected_actual_yield_at_initial_stage <- actually_exploited_yield_gap_at_initial_stage + x[, 4]
  expected_actual_yield_at_initial_stage <- actually_exploited_yield_gap_at_initial_stage + (attainable_yield_at_initial_stage-exploitable_yield_gap_at_initial_stage) # the second term is the new translation of average yield ([,4]) accounting for farming constraints
  
  expected_actual_yield_at_initial_stage <- ifelse(expected_actual_yield_at_initial_stage > attainable_yield_at_initial_stage, attainable_yield_at_initial_stage, expected_actual_yield_at_initial_stage) # becuase yield expectation cannot go beyond the attainable limit.
  
  initial_stage = list(
    exploitable_yield_gap_at_initial_stage = exploitable_yield_gap_at_initial_stage,
    exploitable_yield_gap_loss_due_to_constraints_at_initial_stage = exploitable_yield_gap_loss_due_to_constraints_at_initial_stage,
    actually_exploited_yield_gap_at_initial_stage = actually_exploited_yield_gap_at_initial_stage,
    expected_actual_yield_at_initial_stage=expected_actual_yield_at_initial_stage)
  
  # dev stage
  bio_exp <- x[,15] - (x[, 15] * x[, 14])
  
  exploitable_yield_gap_at_development_stage <- exploitable_yield_gap_at_initial_stage + (exploitable_yield_gap_at_initial_stage * bio_exp)
  
  exploitable_yield_gap_loss_due_to_constraints_at_development_stage <- exploitable_yield_gap_at_development_stage * x[, 14]
  exploitable_yield_gap_loss_due_to_constraints_at_development_stage <- ifelse(exploitable_yield_gap_loss_due_to_constraints_at_development_stage <= exploitable_yield_gap_at_development_stage, exploitable_yield_gap_loss_due_to_constraints_at_development_stage, exploitable_yield_gap_at_development_stage) # because exploitable_yield_gap_loss_due_to_constraints_at_development_stage cannot exceed the exploitable_yield_gap_at_development_stage itself.
  
  actually_exploited_yield_gap_at_development_stage <- exploitable_yield_gap_at_development_stage - exploitable_yield_gap_loss_due_to_constraints_at_development_stage
  
  # expected_actual_yield_at_development_stage <- actually_exploited_yield_gap_at_development_stage + (expected_actual_yield_at_initial_stage * x[, 6])
  expected_actual_yield_at_development_stage <- actually_exploited_yield_gap_at_development_stage + (expected_actual_yield_at_initial_stage * bio_exp)
  
  
  dev_stage = list(exploitable_yield_gap_at_development_stage = exploitable_yield_gap_at_development_stage,
                   exploitable_yield_gap_loss_due_to_constraints_at_development_stage = exploitable_yield_gap_loss_due_to_constraints_at_development_stage,
                   actually_exploited_yield_gap_at_development_stage = actually_exploited_yield_gap_at_development_stage,
                   expected_actual_yield_at_development_stage = expected_actual_yield_at_development_stage)
  
  # mid stage
  bio_exp <- x[,17] - (x[, 17] * x[, 16])
  
  exploitable_yield_gap_at_mid_stage <- exploitable_yield_gap_at_development_stage + (exploitable_yield_gap_at_development_stage * bio_exp)
  
  exploitable_yield_gap_loss_due_to_constraints_at_mid_stage <- exploitable_yield_gap_at_mid_stage * x[, 16]
  exploitable_yield_gap_loss_due_to_constraints_at_mid_stage <- ifelse(exploitable_yield_gap_loss_due_to_constraints_at_mid_stage <= exploitable_yield_gap_at_mid_stage, exploitable_yield_gap_loss_due_to_constraints_at_mid_stage, exploitable_yield_gap_at_mid_stage) # because exploitable_yield_gap_loss_due_to_constraints_at_mid_stage cannot exceed the exploitable_yield_gap_at_mid_stage itself.
  
  actually_exploited_yield_gap_at_mid_stage <- exploitable_yield_gap_at_mid_stage - exploitable_yield_gap_loss_due_to_constraints_at_mid_stage
  
  # expected_actual_yield_at_mid_stage <-  actually_exploited_yield_gap_at_mid_stage + (expected_actual_yield_at_development_stage * x[, 8])
  expected_actual_yield_at_mid_stage <-  actually_exploited_yield_gap_at_mid_stage + (expected_actual_yield_at_development_stage * bio_exp)
  
  mid_stage = list(exploitable_yield_gap_at_mid_stage = exploitable_yield_gap_at_mid_stage,
                   exploitable_yield_gap_loss_due_to_constraints_at_mid_stage = exploitable_yield_gap_loss_due_to_constraints_at_mid_stage,
                   actually_exploited_yield_gap_at_mid_stage = actually_exploited_yield_gap_at_mid_stage,
                   expected_actual_yield_at_mid_stage = expected_actual_yield_at_mid_stage)
  
  # late stage
  bio_exp <- x[,19] - (x[, 19] * x[, 18])
  
  exploitable_yield_gap_at_late_stage <- exploitable_yield_gap_at_mid_stage + (exploitable_yield_gap_at_mid_stage * bio_exp)
  
  exploitable_yield_gap_loss_due_to_constraints_at_late_stage <- exploitable_yield_gap_at_late_stage * x[, 18]
  exploitable_yield_gap_loss_due_to_constraints_at_late_stage <- ifelse(exploitable_yield_gap_loss_due_to_constraints_at_late_stage <= exploitable_yield_gap_at_late_stage, exploitable_yield_gap_loss_due_to_constraints_at_late_stage, exploitable_yield_gap_at_late_stage) # because exploitable_yield_gap_loss_due_to_constraints_at_late_stage cannot exceed the exploitable_yield_gap_at_late_stage itself.
  
  actually_exploited_yield_gap_at_late_stage <- exploitable_yield_gap_at_late_stage - exploitable_yield_gap_loss_due_to_constraints_at_late_stage
  
  expected_actual_yield_at_late_stage <-  actually_exploited_yield_gap_at_late_stage + (expected_actual_yield_at_mid_stage * bio_exp)
  
  late_stage = list(exploitable_yield_gap_at_late_stage = exploitable_yield_gap_at_late_stage,
                    exploitable_yield_gap_loss_due_to_constraints_at_late_stage = exploitable_yield_gap_loss_due_to_constraints_at_late_stage,
                    actually_exploited_yield_gap_at_late_stage = actually_exploited_yield_gap_at_late_stage,
                    expected_actual_yield_at_late_stage = expected_actual_yield_at_late_stage)
  
  # grain yield
  actually_exploited_yield_gap = actually_exploited_yield_gap_at_late_stage * x[, 20]
  exploitable_yield_gap = exploitable_yield_gap_at_late_stage * x[, 20]
  expected_actual_yield = expected_actual_yield_at_late_stage * x[, 20]
  exploitable_yield_gap_loss_due_to_constraints = exploitable_yield_gap_loss_due_to_constraints_at_late_stage * x[, 20]
  
  grain_yield = list(exploitable_yield_gap = exploitable_yield_gap,
                     exploitable_yield_gap_loss_due_to_constraints = exploitable_yield_gap_loss_due_to_constraints,
                     actually_exploited_yield_gap = actually_exploited_yield_gap,
                     expected_actual_yield = expected_actual_yield)
  
  
  ## Outputs
  out <- list(initial_stage = initial_stage, dev_stage = dev_stage, mid_stage = mid_stage,
              late_stage = late_stage, grain_yield = grain_yield)
  
  return(out)
} # Enf of Model Function


### Rice ####
## yield potential estimate #####


mc_nodes_biomass_exp_factor_init <- list(mc_nodes_lower_biomass_exp_factor_init=estimate(distribution = 'unif', lower = .Machine$double.eps, median = 0.19-0.1, upper = 0.20-0.1, variable= 'biomass_exp_factor_init', method = 'fit'),
                                         mc_nodes_mid_biomass_exp_factor_init=estimate(distribution = 'unif', lower = 0.18, median = 0.19, upper = 0.20, variable= 'biomass_exp_factor_init', method = 'fit'),
                                         mc_nodes_upper_biomass_exp_factor_init=estimate(distribution = 'unif', lower = 0.19, median = 0.19+0.1, upper = 0.20+0.1, variable= 'biomass_exp_factor_init', method = 'fit'))


mc_nodes_biomass_exp_factor_dev <- list(mc_nodes_lower_biomass_exp_factor_dev=estimate(distribution = 'unif', lower = .Machine$double.eps, median = 0.49-0.1, upper = 0.50-0.1, variable= 'biomass_exp_factor_dev', method = 'fit'),
                                        mc_nodes_mid_biomass_exp_factor_dev=estimate(distribution = 'unif', lower = 0.20, median = 0.49, upper = 0.50, variable= 'biomass_exp_factor_dev', method = 'fit'),
                                        mc_nodes_upper_biomass_exp_factor_dev=estimate(distribution = 'unif', lower = 0.40, median = 0.49+0.1, upper = 0.50+0.1, variable= 'biomass_exp_factor_dev', method = 'fit'))

mc_nodes_biomass_exp_factor_mid <- list(mc_nodes_lower_biomass_exp_factor_mid=estimate(distribution = 'unif', lower = .Machine$double.eps, median = 0.19-0.1, upper = 0.20-0.1, variable= 'biomass_exp_factor_mid', method = 'fit'),
                                        mc_nodes_mid_biomass_exp_factor_mid=estimate(distribution = 'unif', lower = 0.18, median = 0.19, upper = 0.20, variable= 'biomass_exp_factor_mid', method = 'fit'),
                                        mc_nodes_upper_biomass_exp_factor_mid=estimate(distribution = 'unif', lower = 0.19, median = 0.19+0.1, upper = 0.20+0.1, variable= 'biomass_exp_factor_mid', method = 'fit'))

mc_nodes_biomass_exp_factor_late <- list(mc_nodes_lower_biomass_exp_factor_late=estimate(distribution = 'unif', lower = .Machine$double.eps, median = 0.09-0.01, upper = 0.10-0.01, variable= 'biomass_exp_factor_late', method = 'fit'),
                                         mc_nodes_mid_biomass_exp_factor_late=estimate(distribution = 'unif', lower = 0.05, median = 0.09, upper = 0.10, variable= 'biomass_exp_factor_late', method = 'fit'),
                                         mc_nodes_upper_biomass_exp_factor_late=estimate(distribution = 'unif', lower = 0.08, median = 0.09+0.01, upper = 0.10+0.01, variable= 'biomass_exp_factor_late', method = 'fit'))

mc_nodes_harvest_index <- list(mc_nodes_lower_harvest_index=estimate(distribution = 'gamma', lower = .Machine$double.eps, median=0.1, upper = 0.3, variable= 'harvest_index', method = 'fit'),
                               mc_nodes_mid_harvest_index=estimate(distribution = 'gamma', lower = 0.2, median=0.4, upper = 0.5, variable= 'harvest_index', method = 'fit'),
                               mc_nodes_upper_harvest_index=estimate(distribution = 'gamma', lower = 0.3, median=0.6, upper = 0.7, variable= 'harvest_index', method = 'fit'))


source("data_files/rice.R")
stage_ratio = c(initial_stage = 0.27,  development_stage = 0.80, mid_stage = 0.95, late_stage = 1)

## A function for making an informed guess of biomass yield at each stage ####
## This can also be used as checklist for the final prediction
guess_biomass_yield <- function(grain_yield_pot, 
                                # harvest_index = c(0.1, 0.3),
                                stage_ratio = c(initial_stage = 0.10,  development_stage = 0.80, mid_stage = 0.95, late_stage = 1)){
  # harvest_index <- runif(1000, harvest_index[1], harvest_index[2]) #
  # total_biomass_pot <- sapply(harvest_index, function(i){
  #   grain_yield_pot/i
  # })
  
  total_biomass_pot <- sapply(stage_ratio, function (i){
    # total_biomass_pot*i
    grain_yield_pot*i
  }, simplify = TRUE, USE.NAMES = TRUE)
  as.data.frame(na.omit(total_biomass_pot))
}


## yield potential estimate #####
mc_nodes_estimates_biomass_yield_pot <- guess_decisionSupport_estimates (data = list(potential_grain_yield, 
                                                                                     # harvest_index = harvest_index, 
                                                                                     stage_ratio = stage_ratio), 
                                                                         fun = guess_biomass_yield,
                                                                         distr = rep('gamma', 4), 
                                                                         percentiles = c(0.025, 0.5, 0.975), 
                                                                         plot = FALSE, show.output = FALSE)
rownames(mc_nodes_estimates_biomass_yield_pot$marginal) <- paste0('biomass_Yield_Pot_', rownames(mc_nodes_estimates_biomass_yield_pot$marginal))

## Attainable yield estimates : Median, Lowest and Highest ####

mc_nodes_lower_exploitable_biomass_yield_pot <- data.frame(lower = c(initial_stage = 0.85-0.35, mid_stage = 0.80-0.35, development_stage = 0.75-0.35, late_stage = 0.70-0.35),
                                                           median = c(initial_stage = 0.89-0.35, mid_stage = 0.87-0.35, development_stage = 0.80-0.35, late_stage = 0.71-0.35),
                                                           upper = c(initial_stage = 0.90-0.35, mid_stage = 0.90-0.35, development_stage = 0.90-0.35, late_stage = 0.90-0.35),
                                                           distribution = c(initial_stage = 'unif', mid_stage = 'unif', development_stage = 'unif', late_stage = 'unif'),
                                                           method = c(initial_stage = 'fit', mid_stage = 'fit', development_stage = 'fit', late_stage = 'fit'),
                                                           stringsAsFactors = FALSE)

rownames(mc_nodes_lower_exploitable_biomass_yield_pot) <- paste0('lower_exploitable_biomass_yield_pot_', rownames(mc_nodes_lower_exploitable_biomass_yield_pot))
mc_nodes_lower_exploitable_biomass_yield_pot <- as.estimate(mc_nodes_lower_exploitable_biomass_yield_pot)

mc_nodes_mid_exploitable_biomass_yield_pot <-  data.frame(lower = c(initial_stage = 0.85-0.15, mid_stage = 0.80-0.15, development_stage = 0.75-0.15, late_stage = 0.70-0.15),
                                                          median = c(initial_stage = 0.89-0.15, mid_stage = 0.87-0.15, development_stage = 0.80-0.15, late_stage = 0.71-0.15),
                                                          upper = c(initial_stage = 0.90-0.15, mid_stage = 0.90-0.15, development_stage = 0.90-0.15, late_stage = 0.90-0.15),
                                                          distribution = c(initial_stage = 'unif', mid_stage = 'unif', development_stage = 'unif', late_stage = 'unif'),
                                                          method = c(initial_stage = 'fit', mid_stage = 'fit', development_stage = 'fit', late_stage = 'fit'),
                                                          stringsAsFactors = FALSE)

rownames(mc_nodes_mid_exploitable_biomass_yield_pot) <- paste0('mid_exploitable_biomass_yield_pot_', rownames(mc_nodes_mid_exploitable_biomass_yield_pot))
mc_nodes_mid_exploitable_biomass_yield_pot <- as.estimate(mc_nodes_mid_exploitable_biomass_yield_pot)


mc_nodes_upper_exploitable_biomass_yield_pot <- data.frame(lower = c(initial_stage = 0.85, mid_stage = 0.80, development_stage = 0.75, late_stage = 0.70),
                                                           median = c(initial_stage = 0.89, mid_stage = 0.87, development_stage = 0.80, late_stage = 0.71),
                                                           upper = c(initial_stage = 0.90, mid_stage = 0.90, development_stage = 0.90, late_stage = 0.90),
                                                           distribution = c(initial_stage = 'unif', mid_stage = 'unif', development_stage = 'unif', late_stage = 'unif'),
                                                           method = c(initial_stage = 'fit', mid_stage = 'fit', development_stage = 'fit', late_stage = 'fit'),
                                                           stringsAsFactors = FALSE)
rownames(mc_nodes_upper_exploitable_biomass_yield_pot) <- paste0('upper_exploitable_biomass_yield_pot_', rownames(mc_nodes_upper_exploitable_biomass_yield_pot))
mc_nodes_upper_exploitable_biomass_yield_pot <- as.estimate(mc_nodes_upper_exploitable_biomass_yield_pot)

mc_nodes_exploitable_biomass_yield_pot <- list(mc_nodes_lower_exploitable_biomass_yield_pot, mc_nodes_mid_exploitable_biomass_yield_pot, mc_nodes_upper_exploitable_biomass_yield_pot)

## Average yield estimates: Median, Lowest and Highest ####

cond <- get_boxplot_range_1d (observed_actual_grain_yield)
mc_nodes_lower_average_actu_biomass_yield <- observed_actual_grain_yield[observed_actual_grain_yield >= cond[1] & observed_actual_grain_yield < cond[3]]
mc_nodes_mid_average_actu_biomass_yield <- observed_actual_grain_yield[observed_actual_grain_yield >= cond[3] & observed_actual_grain_yield < cond[5]]
mc_nodes_upper_average_actu_biomass_yield <- observed_actual_grain_yield[observed_actual_grain_yield >= cond[5] & observed_actual_grain_yield < cond[7]]

mc_nodes_lower_average_actu_biomass_yield <- guess_decisionSupport_estimates (data = list(mc_nodes_lower_average_actu_biomass_yield, 
                                                                                          # harvest_index = harvest_index,
                                                                                          stage_ratio = stage_ratio), fun=guess_biomass_yield, distr = rep('gamma', 4),
                                                                              percentiles = c(0.025, 0.5, 0.975), plot = FALSE, show.output = FALSE)
rownames(mc_nodes_lower_average_actu_biomass_yield$marginal) <- paste0('lower_average_Actual_yield_', rownames(mc_nodes_lower_average_actu_biomass_yield$marginal))


mc_nodes_mid_average_actu_biomass_yield <- guess_decisionSupport_estimates (data = list(mc_nodes_mid_average_actu_biomass_yield, 
                                                                                        # harvest_index = harvest_index,
                                                                                        stage_ratio = stage_ratio), fun=guess_biomass_yield, distr = rep('gamma', 4),
                                                                            percentiles = c(0.025, 0.5, 0.975), plot = FALSE, show.output = FALSE)
rownames(mc_nodes_mid_average_actu_biomass_yield$marginal) <- paste0('mid_average_Actual_yield_', rownames(mc_nodes_mid_average_actu_biomass_yield$marginal))


mc_nodes_upper_average_actu_biomass_yield <- guess_decisionSupport_estimates (data = list(mc_nodes_upper_average_actu_biomass_yield, 
                                                                                          # harvest_index = harvest_index,
                                                                                          stage_ratio = stage_ratio), fun=guess_biomass_yield, distr = rep('gamma', 4),
                                                                              percentiles = c(0.025, 0.5, 0.975), plot = FALSE, show.output = FALSE)
rownames(mc_nodes_upper_average_actu_biomass_yield$marginal) <- paste0('upper_average_Actual_yield_', rownames(mc_nodes_upper_average_actu_biomass_yield$marginal))
mc_nodes_average_actu_biomass_yield <- list(mc_nodes_lower_average_actu_biomass_yield, mc_nodes_mid_average_actu_biomass_yield, mc_nodes_upper_average_actu_biomass_yield)

# ###############################################################################################################
# # bn nodes estimates ####
# 
# Local_constraints_at_initial_stage_estimates <- make_node_states_estimates(bn=network_bn_fit, node='Local_constraints_at_initial_stage', op = 'proba', distr = c('beta', 'unif', 'unif'), state_effects = c(0.9, 0.6, 0.1)) # , state_effects = c(0.9, 0.6, 0.1) # c(0.6, 0.3, 0.1)
# Local_constraints_at_development_stage_estimates <- make_node_states_estimates(bn=network_bn_fit, node='Local_constraints_at_development_stage', op = 'proba', distr = c('beta', 'unif', 'unif'), state_effects = c(0.9, 0.6, 0.1))
# 
# #############################################################################################################
distr_mid <- list(
  c('beta', 'unif', 'beta'),
  c('beta', 'unif', 'beta'),
  c('beta', 'unif', 'beta'),
  c('beta', 'unif', 'beta'),
  c('beta', 'unif', 'beta'),
  c('beta', 'unif', 'unif'),
  c('beta', 'unif', 'unif'),
  c('beta', 'unif', 'unif')
)

distr_late <- list(
  c('beta', 'unif', 'beta'),
  c('beta', 'unif', 'beta'),
  c('beta', 'unif', 'beta'),
  c('beta', 'unif', 'beta'),
  c('beta', 'unif', 'beta'),
  c('beta', 'norm', 'beta'),
  c('beta', 'norm', 'beta'),
  c('beta', 'norm', 'beta')
)             
tmp <- 1:length(evidence_list_rice); names(tmp) <- names(evidence_list_rice)

ssp <- sapply(tmp, function(evid){
  ## associate average yield and the exploitable yield potential to their corresponding BNs nodes ####
  tmp <- 1:length(Local_constraints_at_initial_stage_estimates)
  names(tmp) <- names(Local_constraints_at_initial_stage_estimates)
  est_int <- sapply(X=tmp, function(i){
    rbind (Local_constraints_at_initial_stage_estimates [[i]],
           mc_nodes_estimates_biomass_yield_pot, 
           mc_nodes_exploitable_biomass_yield_pot[[i]],
           mc_nodes_average_actu_biomass_yield[[i]]
    )
  }, simplify = FALSE, USE.NAMES = TRUE)
  
  ## Biomass yield at dev stage #####
  tmp <- 1:length(Local_constraints_at_development_stage_estimates)
  names(tmp) <- names(Local_constraints_at_development_stage_estimates)
  est_dev <- lapply(X=tmp, FUN = function(i){
    lapply(est_int, function(j){
      rbind(j,
            Local_constraints_at_development_stage_estimates[[i]],
            mc_nodes_biomass_exp_factor_dev[[i]])
    })
  })
  
  
  ## Biomass yield at mid stage #####
  # Local_constraints_at_mid_stage_estimates <- make_node_states_estimates(bn=net, node='Local_constraints_at_mid_stage', op = 'proba', distr = 'beta', state_effects = c(0.9, 0.6, 0.1), evidence = evid, include_relatives = FALSE)
  Local_constraints_at_mid_stage_estimates <- make_node_states_estimates(bn = net, node='Local_constraints_at_mid_stage', distr = distr_mid[[evid]], evidence = evidence_list_rice[[evid]], state_effects = c(0.9, 0.6, 0.1))
  
  tmp <- 1:length(Local_constraints_at_mid_stage_estimates)
  names(tmp) <- names(Local_constraints_at_mid_stage_estimates)
  est_mid <- lapply(X=tmp, FUN = function(i){
    lapply(est_dev, function(j) {
      lapply(j, function (k){
        rbind(k,
              Local_constraints_at_mid_stage_estimates[[i]],
              mc_nodes_biomass_exp_factor_mid[[i]])
      })
    })
  })
  
  ## Biomass yield at late stage #####
  # Local_constraints_at_late_stage_estimates <- make_node_states_estimates(bn=net, node='Local_constraints_at_late_stage', op = 'proba', distr = 'beta', state_effects = c(0.9, 0.6, 0.1), evidence = evid, include_relatives = FALSE)
  Local_constraints_at_late_stage_estimates <- make_node_states_estimates(bn = net, node = 'Local_constraints_at_late_stage', distr = distr_late[[evid]], evidence = evidence_list_rice[[evid]], state_effects = c(0.9, 0.6, 0.1))
  
  
  tmp <- 1:length(Local_constraints_at_late_stage_estimates)
  names(tmp) <- names(Local_constraints_at_late_stage_estimates)
  est_late <- lapply(X=tmp, FUN = function(i){
    lapply(est_mid, function(j) {
      lapply(j, function(k){
        lapply(k, function (l){
          rbind(l,
                Local_constraints_at_late_stage_estimates[[i]],
                mc_nodes_biomass_exp_factor_late[[i]], 
                mc_nodes_harvest_index[[i]],
                mc_nodes_biomass_exp_factor_init[[i]])
        })
      })
    })
  })
  
  state_ids = 1:length(est_late)
  names(state_ids) <- names(est_late)
  
  sapply(X=state_ids, function (i) {
    sapply(est_late[[i]], function (j){
      sapply(j, function(k){
        sapply(k, function(l){
          mcSimulation(estimate = l, model_function = model_function, numberOfModelRuns=1000, functionSyntax="matrixNames")
        }, simplify = FALSE, USE.NAMES = TRUE)
      }, simplify = FALSE, USE.NAMES = TRUE)
    }, simplify = FALSE, USE.NAMES = TRUE)
  }, simplify = FALSE, USE.NAMES = TRUE)
}, simplify = FALSE, USE.NAMES = TRUE)

saveRDS(ssp, paste0("output_files", "/", "Modelling_FBFS_model_RICE_RAW_predictions_Case_study_3.rds"))
rm(ssp); gc(verbose=FALSE)
#### Sorghum #####

## yield potential estimate #####

# mc_nodes_estimates_biomass_yield_pot <- data.frame(lower = 0.1066141, median = 0.91816159, upper = 4.0754789, distribution = 'gamma', method = 'fit',
#                                                    stringsAsFactors = FALSE, row.names = 'biomass_Yield_Pot_initial_stage')
# mc_nodes_estimates_biomass_yield_pot <- as.estimate(mc_nodes_estimates_biomass_yield_pot)
# 
# ## Average yield estimates ####
# 
# mc_nodes_average_actu_biomass_yield <- data.frame(lower = 0.1824260, median = 0.2543113+0.09, upper = 0.3650954, distribution = 'unif', method = 'fit',
#                                                   stringsAsFactors = FALSE, row.names = 'average_Actual_yield_initial_stage')
# mc_nodes_average_actu_biomass_yield <- as.estimate(mc_nodes_average_actu_biomass_yield)

source("data_files/sorghum.R")
## yield potential estimate #####
mc_nodes_estimates_biomass_yield_pot <- guess_decisionSupport_estimates (data = list(potential_grain_yield, 
                                                                                     # harvest_index = harvest_index, 
                                                                                     stage_ratio = stage_ratio), 
                                                                         fun = guess_biomass_yield,
                                                                         distr = rep('gamma', 4), 
                                                                         percentiles = c(0.025, 0.5, 0.975), 
                                                                         plot = FALSE, show.output = FALSE)
rownames(mc_nodes_estimates_biomass_yield_pot$marginal) <- paste0('biomass_Yield_Pot_', rownames(mc_nodes_estimates_biomass_yield_pot$marginal))

## Attainable yield estimates : Median, Lowest and Highest ####

mc_nodes_lower_exploitable_biomass_yield_pot <- data.frame(lower = c(initial_stage = 0.85-0.35, mid_stage = 0.80-0.35, development_stage = 0.75-0.35, late_stage = 0.70-0.35),
                                                           median = c(initial_stage = 0.89-0.35, mid_stage = 0.87-0.35, development_stage = 0.80-0.35, late_stage = 0.71-0.35),
                                                           upper = c(initial_stage = 0.90-0.35, mid_stage = 0.90-0.35, development_stage = 0.90-0.35, late_stage = 0.90-0.35),
                                                           distribution = c(initial_stage = 'unif', mid_stage = 'unif', development_stage = 'unif', late_stage = 'unif'),
                                                           method = c(initial_stage = 'fit', mid_stage = 'fit', development_stage = 'fit', late_stage = 'fit'),
                                                           stringsAsFactors = FALSE)

rownames(mc_nodes_lower_exploitable_biomass_yield_pot) <- paste0('lower_exploitable_biomass_yield_pot_', rownames(mc_nodes_lower_exploitable_biomass_yield_pot))
mc_nodes_lower_exploitable_biomass_yield_pot <- as.estimate(mc_nodes_lower_exploitable_biomass_yield_pot)

mc_nodes_mid_exploitable_biomass_yield_pot <-  data.frame(lower = c(initial_stage = 0.85-0.15, mid_stage = 0.80-0.15, development_stage = 0.75-0.15, late_stage = 0.70-0.15),
                                                          median = c(initial_stage = 0.89-0.15, mid_stage = 0.87-0.15, development_stage = 0.80-0.15, late_stage = 0.71-0.15),
                                                          upper = c(initial_stage = 0.90-0.15, mid_stage = 0.90-0.15, development_stage = 0.90-0.15, late_stage = 0.90-0.15),
                                                          distribution = c(initial_stage = 'unif', mid_stage = 'unif', development_stage = 'unif', late_stage = 'unif'),
                                                          method = c(initial_stage = 'fit', mid_stage = 'fit', development_stage = 'fit', late_stage = 'fit'),
                                                          stringsAsFactors = FALSE)

rownames(mc_nodes_mid_exploitable_biomass_yield_pot) <- paste0('mid_exploitable_biomass_yield_pot_', rownames(mc_nodes_mid_exploitable_biomass_yield_pot))
mc_nodes_mid_exploitable_biomass_yield_pot <- as.estimate(mc_nodes_mid_exploitable_biomass_yield_pot)


mc_nodes_upper_exploitable_biomass_yield_pot <- data.frame(lower = c(initial_stage = 0.85, mid_stage = 0.80, development_stage = 0.75, late_stage = 0.70),
                                                           median = c(initial_stage = 0.89, mid_stage = 0.87, development_stage = 0.80, late_stage = 0.71),
                                                           upper = c(initial_stage = 0.90, mid_stage = 0.90, development_stage = 0.90, late_stage = 0.90),
                                                           distribution = c(initial_stage = 'unif', mid_stage = 'unif', development_stage = 'unif', late_stage = 'unif'),
                                                           method = c(initial_stage = 'fit', mid_stage = 'fit', development_stage = 'fit', late_stage = 'fit'),
                                                           stringsAsFactors = FALSE)
rownames(mc_nodes_upper_exploitable_biomass_yield_pot) <- paste0('upper_exploitable_biomass_yield_pot_', rownames(mc_nodes_upper_exploitable_biomass_yield_pot))
mc_nodes_upper_exploitable_biomass_yield_pot <- as.estimate(mc_nodes_upper_exploitable_biomass_yield_pot)

mc_nodes_exploitable_biomass_yield_pot <- list(mc_nodes_lower_exploitable_biomass_yield_pot, mc_nodes_mid_exploitable_biomass_yield_pot, mc_nodes_upper_exploitable_biomass_yield_pot)

## Average yield estimates: Median, Lowest and Highest ####

cond <- get_boxplot_range_1d (observed_actual_grain_yield)
mc_nodes_lower_average_actu_biomass_yield <- observed_actual_grain_yield[observed_actual_grain_yield >= cond[1] & observed_actual_grain_yield < cond[3]]
mc_nodes_mid_average_actu_biomass_yield <- observed_actual_grain_yield[observed_actual_grain_yield >= cond[3] & observed_actual_grain_yield < cond[5]]
mc_nodes_upper_average_actu_biomass_yield <- observed_actual_grain_yield[observed_actual_grain_yield >= cond[5] & observed_actual_grain_yield < cond[7]]

mc_nodes_lower_average_actu_biomass_yield <- guess_decisionSupport_estimates (data = list(mc_nodes_lower_average_actu_biomass_yield, 
                                                                                          # harvest_index = harvest_index,
                                                                                          stage_ratio = stage_ratio), fun=guess_biomass_yield, distr = rep('gamma', 4),
                                                                              percentiles = c(0.025, 0.5, 0.975), plot = FALSE, show.output = FALSE)
rownames(mc_nodes_lower_average_actu_biomass_yield$marginal) <- paste0('lower_average_Actual_yield_', rownames(mc_nodes_lower_average_actu_biomass_yield$marginal))


mc_nodes_mid_average_actu_biomass_yield <- guess_decisionSupport_estimates (data = list(mc_nodes_mid_average_actu_biomass_yield, 
                                                                                        # harvest_index = harvest_index,
                                                                                        stage_ratio = stage_ratio), fun=guess_biomass_yield, distr = rep('gamma', 4),
                                                                            percentiles = c(0.025, 0.5, 0.975), plot = FALSE, show.output = FALSE)
rownames(mc_nodes_mid_average_actu_biomass_yield$marginal) <- paste0('mid_average_Actual_yield_', rownames(mc_nodes_mid_average_actu_biomass_yield$marginal))


mc_nodes_upper_average_actu_biomass_yield <- guess_decisionSupport_estimates (data = list(mc_nodes_upper_average_actu_biomass_yield, 
                                                                                          # harvest_index = harvest_index,
                                                                                          stage_ratio = stage_ratio), fun=guess_biomass_yield, distr = rep('gamma', 4),
                                                                              percentiles = c(0.025, 0.5, 0.975), plot = FALSE, show.output = FALSE)
rownames(mc_nodes_upper_average_actu_biomass_yield$marginal) <- paste0('upper_average_Actual_yield_', rownames(mc_nodes_upper_average_actu_biomass_yield$marginal))
mc_nodes_average_actu_biomass_yield <- list(mc_nodes_lower_average_actu_biomass_yield, mc_nodes_mid_average_actu_biomass_yield, mc_nodes_upper_average_actu_biomass_yield)

distr_mid <- list(
  c('beta', 'unif', 'beta'),
  c('beta', 'unif', 'beta'),
  c('beta', 'unif', 'beta'),
  c('beta', 'unif', 'beta'),
  c('beta', 'unif', 'beta'),
  c('beta', 'unif', 'unif'),
  c('beta', 'norm', 'beta'),
  c('beta', 'norm', 'beta')
)

distr_late <- list(
  c('beta', 'unif', 'beta'),
  c('beta', 'norm', 'beta'),
  c('beta', 'unif', 'beta'),
  c('beta', 'unif', 'beta'),
  c('beta', 'norm', 'beta'),
  c('unif', 'norm', 'unif'),
  c('beta', 'norm', 'beta'),
  c('beta', 'logis', 'unif')
)   

tmp <- 1:length(evidence_list_sorghum); names(tmp) <- names(evidence_list_sorghum)

ssp <- sapply(tmp, function(evid){
  ## associate average yield and the exploitable yield potential to their corresponding BNs nodes ####
  tmp <- 1:length(Local_constraints_at_initial_stage_estimates)
  names(tmp) <- names(Local_constraints_at_initial_stage_estimates)
  est_int <- sapply(X=tmp, function(i){
    rbind (Local_constraints_at_initial_stage_estimates [[i]],
           mc_nodes_estimates_biomass_yield_pot, 
           mc_nodes_exploitable_biomass_yield_pot[[i]],
           mc_nodes_average_actu_biomass_yield[[i]]
    )
  }, simplify = FALSE, USE.NAMES = TRUE)
  
  ## Biomass yield at dev stage #####
  tmp <- 1:length(Local_constraints_at_development_stage_estimates)
  names(tmp) <- names(Local_constraints_at_development_stage_estimates)
  est_dev <- lapply(X=tmp, FUN = function(i){
    lapply(est_int, function(j){
      rbind(j,
            Local_constraints_at_development_stage_estimates[[i]],
            mc_nodes_biomass_exp_factor_dev[[i]])
    })
  })
  
  
  ## Biomass yield at mid stage #####
  # Local_constraints_at_mid_stage_estimates <- make_node_states_estimates(bn=net, node='Local_constraints_at_mid_stage', op = 'proba', distr = 'beta', state_effects = c(0.9, 0.6, 0.1), evidence = evid, include_relatives = FALSE)
  # Local_constraints_at_mid_stage_estimates <- make_grain_node_states_estimates(network = net, node='Local_constraints_at_mid_stage', evidence = evid, state_effects = c(0.9, 0.6, 0.1))
  Local_constraints_at_mid_stage_estimates <- make_node_states_estimates(bn = net, node='Local_constraints_at_mid_stage', distr = distr_mid[[evid]], evidence = evidence_list_sorghum[[evid]], state_effects = c(0.9, 0.6, 0.1))
  
  tmp <- 1:length(Local_constraints_at_mid_stage_estimates)
  names(tmp) <- names(Local_constraints_at_mid_stage_estimates)
  est_mid <- lapply(X=tmp, FUN = function(i){
    lapply(est_dev, function(j) {
      lapply(j, function (k){
        rbind(k,
              Local_constraints_at_mid_stage_estimates[[i]],
              mc_nodes_biomass_exp_factor_mid[[i]])
      })
    })
  })
  
  ## Biomass yield at late stage #####
  # Local_constraints_at_late_stage_estimates <- make_node_states_estimates(bn=net, node='Local_constraints_at_late_stage', op = 'proba', distr = 'beta', state_effects = c(0.9, 0.6, 0.1), evidence = evid, include_relatives = FALSE)
  # Local_constraints_at_late_stage_estimates <- make_grain_node_states_estimates(network = net, node = 'Local_constraints_at_late_stage', evidence = evid, state_effects = c(0.9, 0.6, 0.1))
  Local_constraints_at_late_stage_estimates <- make_node_states_estimates(bn = net, node = 'Local_constraints_at_late_stage', distr = distr_late[[evid]], evidence = evidence_list_sorghum[[evid]], state_effects = c(0.9, 0.6, 0.1))
  
  
  tmp <- 1:length(Local_constraints_at_late_stage_estimates)
  names(tmp) <- names(Local_constraints_at_late_stage_estimates)
  est_late <- lapply(X=tmp, FUN = function(i){
    lapply(est_mid, function(j) {
      lapply(j, function(k){
        lapply(k, function (l){
          rbind(l,
                Local_constraints_at_late_stage_estimates[[i]],
                mc_nodes_biomass_exp_factor_late[[i]], 
                mc_nodes_harvest_index[[i]],
                mc_nodes_biomass_exp_factor_init[[i]])
        })
      })
    })
  })
  
  state_ids = 1:length(est_late)
  names(state_ids) <- names(est_late)
  
  sapply(X=state_ids, function (i) {
    sapply(est_late[[i]], function (j){
      sapply(j, function(k){
        sapply(k, function(l){
          mcSimulation(estimate = l, model_function = model_function, numberOfModelRuns=1000, functionSyntax="matrixNames")
        }, simplify = FALSE, USE.NAMES = TRUE)
      }, simplify = FALSE, USE.NAMES = TRUE)
    }, simplify = FALSE, USE.NAMES = TRUE)
  }, simplify = FALSE, USE.NAMES = TRUE)
}, simplify = FALSE, USE.NAMES = TRUE)

saveRDS(ssp, paste0("output_files", "/", "Modelling_FBFS_model_SORGHUM_RAW_predictions_Case_study_3.rds"))
rm(ssp); gc(verbose=FALSE)
```

```{r case study 3 results rds 3, eval=TRUE,include = FALSE, echo = FALSE, cache = FALSE}
## removing objects that are no longer needed ####
rm(list=setdiff(ls(), c("evidence", "my_theme", "plot_font_size"))); gc ()

## some common plots specifications
legend_bg <- adjustcolor( "yellow", alpha.f = 0.15)
plots_lwd <- 0.5
min_plots_width_in <- 2.63
max_plots_width_in <- 7.5
max_plots_height_in <- 8.75
min_plots_res <- 300
plots_compression <- "lzw"
plots_font_family <- 'serif' # 'sans'
plots_font <- 1 # 2
plot_font_size <- 10

ssp1 <- readRDS("output_files/Modelling_FBFS_model_RICE_RAW_predictions_Case_study_3.rds")
ssp2 <- readRDS("output_files/Modelling_FBFS_model_SORGHUM_RAW_predictions_Case_study_3.rds")

f <- function(x){
  if(inherits(x, 'mcSimulation')){
    out <- x$y
  } else {
    out <- sapply(x, f, simplify = FALSE)
  }
  
}

ssp1 <- f(ssp1)

ssp1 <- reshape2::melt(ssp1)
ssp1 <- ssp1[ssp1$variable=="grain_yield.expected_actual_yield", ]

ssp1$Crop_type <- rep('Rice', nrow(ssp1))

ssp2 <- f(ssp2)

ssp2 <- reshape2::melt(ssp2)
ssp2 <- ssp2[ssp2$variable=="grain_yield.expected_actual_yield", ]

ssp2$Crop_type <- rep('Sorghum', nrow(ssp2))

ssp <- rbind(ssp1, ssp2)

evidence <- data.frame(evidence, L1=paste0('Traitment_', 1:nrow(evidence)))
ssp <- merge(ssp, evidence, by = c("L1", 'Crop_type'), all.x=TRUE, all.y=TRUE)

ssp$Crop_type <- as.character(ssp$Crop_type)

ssp <- ssp[
  (ssp$L5 != "Local_constraints_at_initial_stage=Medium")&
    (ssp$L4 != "Local_constraints_at_development_stage=Medium")&
    (ssp$L3 != "Local_constraints_at_mid_stage=Medium")&
    (ssp$L2 != "Local_constraints_at_late_stage=Medium"), ]

ssp$L5 <- gsub("Local_constraints_at_initial_stage=High", "{bold('FC'[italic(i)]==High)}", ssp$L5)
ssp$L5 <- gsub("Local_constraints_at_initial_stage=Low", "{bold('FC'[italic(i)]==Low)}", ssp$L5)

ssp$L5 <- gsub(pattern = 'Low', replacement = "L", ssp$L5)
ssp$L5 <- gsub(pattern = 'Medium', replacement = "M", ssp$L5)
ssp$L5 <- gsub(pattern = 'High', replacement = "H", ssp$L5)

ssp$L4 <- gsub("Local_constraints_at_development_stage=High", "{bold('FC'[italic(ii)]==High)}", ssp$L4)
ssp$L4 <- gsub("Local_constraints_at_development_stage=Low", "{bold('FC'[italic(ii)]==Low)}", ssp$L4)

ssp$L4 <- gsub(pattern = 'Low', replacement = "L", ssp$L4)
ssp$L4 <- gsub(pattern = 'Medium', replacement = "M", ssp$L4)
ssp$L4 <- gsub(pattern = 'High', replacement = "H", ssp$L4)

ssp$L3 <- gsub("Local_constraints_at_mid_stage=High", "{bold('FC'[italic(iii)]==High)}", ssp$L3)
ssp$L3 <- gsub("Local_constraints_at_mid_stage=Low", "{bold('FC'[italic(iii)]==Low)}", ssp$L3)

ssp$L3 <- gsub(pattern = 'Low', replacement = "L", ssp$L3)
ssp$L3 <- gsub(pattern = 'Medium', replacement = "M", ssp$L3)
ssp$L3 <- gsub(pattern = 'High', replacement = "H", ssp$L3)

ssp$L2 <- gsub("Local_constraints_at_late_stage=High", "{bold('FC'[italic(iiii)]==High)}", ssp$L2)
ssp$L2 <- gsub("Local_constraints_at_late_stage=Low", "{bold('FC'[italic(iiii)]==Low)}", ssp$L2)

ssp$L2 <- gsub(pattern = 'Low', replacement = "L", ssp$L2)
ssp$L2 <- gsub(pattern = 'Medium', replacement = "M", ssp$L2)
ssp$L2 <- gsub(pattern = 'High', replacement = "H", ssp$L2)

ssp$Pest_and_disease_impacts_at_mid_stage <- factor(ssp$Pest_and_disease_impacts_at_mid_stage, levels = unique(ssp$Pest_and_disease_impacts_at_mid_stage))
ssp$Weed_impacts_at_mid_stage <- factor(ssp$Weed_impacts_at_mid_stage, levels = unique(ssp$Weed_impacts_at_mid_stage))
ssp$Available_soil_water_at_mid_stage <- factor(ssp$Available_soil_water_at_mid_stage, levels = unique(ssp$Available_soil_water_at_mid_stage))

ssp$L2 <- factor(ssp$L2, levels = unique(ssp$L2))
ssp$L3 <- factor(ssp$L3, levels = unique(ssp$L3))
ssp$L4 <- factor(ssp$L4, levels = unique(ssp$L4))
ssp$L5 <- factor(ssp$L5, levels = unique(ssp$L5))

labellers <- labeller(
  Pest_and_disease_impacts_at_mid_stage = c(Minor = "Pest and disease impact = Minor",
                                           Severe = "Pest and disease impact = Severe"),
  Weed_impacts_at_mid_stage = c(Negligible = "Weeds impact = Negligible",
                                Significant = "Weeds impact = Significant"),
  Available_soil_water_at_mid_stage = c(`Drought risk` = "Drought\nrisk",
                                        `Waterlogging risk` = "Waterlogging\nrisk"),
  L5 = label_parsed,
  L4 = label_parsed,
  L3 = label_parsed,
  L2 = label_parsed
)
```

```{r case study 3-1 results plot, eval=TRUE,include = FALSE, echo = FALSE, cache = FALSE}
p1 <- ggplot (data = ssp[ssp$L3 == "{bold('FC'[italic(iii)]==L)}", ], aes(x=Crop_type, y=value, fill=Crop_type, colour=Crop_type))+
  # geom_density_ridges(scale=1, size=0.05)+
  # geom_violin(draw_quantiles = c(0.05, 0.5, 0.95), size = 0.1)+
  geom_violin(size = 0.1, alpha=0.5)+
  geom_boxplot(width=0.1, position = 'dodge', outlier.colour=NA, size = 0.2, colour='black') +
  # geom_boxplot(width=0.1)+
  # stat_summary(fun.y=mean, geom="point", shape=23, size=1)+
  # stat_summary(fun.y=median, geom="point", size=1, color="red")+
  ggnomics::facet_nested(L2+L4+L5 ~ Pest_and_disease_impacts_at_mid_stage+Weed_impacts_at_mid_stage+Available_soil_water_at_mid_stage, 
                         space = 'free_x', scales = 'free_x', labeller = labellers)+
  scale_y_continuous(
    expand = c(0, 0),
    limits = function(x) c(min(x, na.rm = TRUE), 10),
    breaks = seq(2, 8, by = 2)
  )+
  
  my_theme+
  theme(
    panel.grid.major = element_line(size = 0.2),
    panel.grid.minor = element_line(size = 0.1),
    axis.title.x = element_blank(),
    axis.text.x=element_blank(),
    legend.position=c(1,1),
    legend.justification = c("right", "top"),
    legend.text = element_text(size = plot_font_size+2, margin = margin(0,0,0,-4)),
    legend.margin=margin(0,0,0,0),
    legend.box = "vertical",
    legend.box.margin=margin(-40,-53,0, 0),
    legend.key.width = unit(0.25/1.5, "cm"),
    legend.key.height = unit(0.05, "cm"),
    strip.text = element_text(size = plot_font_size-0.5, face = 'bold'),
    strip.text.x = element_text(margin = margin(t=3, b = 3)),
    axis.text = element_text(size = plot_font_size+2),
    # axis.text.x = element_text(hjust = 0.5),
    axis.text.y = element_text(hjust = 0.5),
    axis.ticks.length = unit(0.25, "mm"),
    plot.margin=unit(c(4, 1, 1, 1), "pt")
  )+
  labs(y = 'Grain yield (tons/ha)')
# rm(ssp); gc(verbose=FALSE)
```

```{r fig10-export,echo=FALSE,include=FALSE}
gb = grid.rect(.5,.5,width=unit(1,"npc"), height=unit(1,"npc"), 
               gp=gpar(lwd=1, fill=NA, col="lightgray"))
p1 <- gTree(children = gList(ggplotGrob(p1), gb))

p1 <- list(p1)
p1$ncol=1
# p1$top = grid::textGrob(
# "FC = farming constraint, H = High, M = Medium, L = Low. The indices i, ii, iiii, respectively, indicate crop at initial, developement and late stages.",
#                         x=0.04, hjust=0, vjust = 0.5,
#                         gp = gpar(fontfamily=plots_font_family,fontsize=plot_font_size-2,fontface="italic", col="black"))
grid.newpage()
ga = do.call("grid.arrange", p1)

g <- gTree(children = gList(ga, gb))
grid.draw(g)

ggsave(plot=g, device='png', filename = "figures/Modelling_FBFS_grain_yield_violin_LOW.png", width = max_plots_width_in, 
       height=max_plots_height_in/1.25, units="in", dpi=min_plots_res
)
ggsave(plot=g, device='pdf', filename = "figures/Modelling_FBFS_grain_yield_violin_LOW.pdf", width = max_plots_width_in, 
       height=max_plots_height_in/1.25, units="in", dpi=min_plots_res
)
```

```{r fig10, echo=FALSE,out.width='100%',fig.cap="Effect of pests and diseases, weeds, and soil water on grain yield of rice and sorghum grown in flood-based farming systems in the Tigray region of Ethiopia and Kisumu County in Kenya. FC = farming constraint, H = High, M = Medium, L = Low. The indices i, ii, iiii, respectively, indicate crop at initial, development and late stages. Scenario for water, weed, pest and disease are taken at the mid stage of crop development. "}
knitr::include_graphics("figures/Modelling_FBFS_grain_yield_violin_LOW.pdf")
```

<!-- ```{r case study 3-2 results plot, eval=TRUE,include = FALSE, echo = FALSE, cache = FALSE} -->
<!-- p1 <- ggplot (data = ssp[ssp$L3 == "{bold('FC'[italic(iii)]==H)}", ], aes(x=Crop_type, y=value, fill=Crop_type))+ -->
<!--   # geom_density_ridges(scale=1, size=0.05)+ -->
<!--   # geom_violin(draw_quantiles = c(0.05, 0.5, 0.95), size = 0.1)+ -->
<!--   geom_violin(size = 0.1)+ -->
<!--   geom_boxplot(width=0.1, position = 'dodge', outlier.colour=NA, size = 0.1) + -->
<!--   # geom_boxplot(width=0.1)+ -->
<!--   # stat_summary(fun.y=mean, geom="point", shape=23, size=1)+ -->
<!--   # stat_summary(fun.y=median, geom="point", size=1, color="red")+ -->
<!--   ggnomics::facet_nested(L2+L4+L5 ~ Pest_and_disease_impacts_at_mid_stage+Weed_impacts_at_mid_stage+Available_soil_water_at_mid_stage,  -->
<!--                          space = 'free_x', scales = 'free_x', labeller = labellers)+ -->
<!--   scale_y_continuous( -->
<!--     expand = c(0, 0), -->
<!--     limits = function(x) c(min(x, na.rm = TRUE), 10), -->
<!--     breaks = seq(2, 8, by = 2) -->
<!--   )+ -->

<!--   my_theme+ -->
<!--   theme( -->
<!--     axis.title.x = element_blank(), -->
<!--     axis.text.x=element_blank(), -->
<!--     legend.position=c(1,1), -->
<!--     legend.justification = c("right", "top"), -->
<!--     legend.text = element_text(size = plot_font_size+2, margin = margin(0,0,0,-4)), -->
<!--     legend.margin=margin(0,0,0,0), -->
<!--     legend.box = "vertical", -->
<!--     legend.box.margin=margin(-40,-53,0, 0), -->
<!--     legend.key.width = unit(0.25/1.5, "cm"), -->
<!--     legend.key.height = unit(0.05, "cm"), -->
<!--     strip.text = element_text(size = plot_font_size-0.5, face = 'bold'), -->
<!--     strip.text.x = element_text(margin = margin(t=3, b = 3)), -->
<!--     axis.text = element_text(size = plot_font_size+2), -->
<!--     # axis.text.x = element_text(hjust = 0.5), -->
<!--     axis.text.y = element_text(hjust = 0.5), -->
<!--     axis.ticks.length = unit(0.25, "mm"), -->
<!--     plot.margin=unit(c(4, 1, 1, 1), "pt") -->
<!--   )+ -->
<!--   labs(y = 'Grain yield (tons/ha)') -->
<!-- rm(ssp); gc(verbose=FALSE) -->
<!-- ``` -->

<!-- ```{r fig12,echo=FALSE, cache.lazy = FALSE, warning=FALSE,message=FALSE,fig.width=max_plots_width_in,fig.height=max_plots_height_in/1.5,dpi=min_plots_res,fig.cap="Effect of Pest and diseases, weeds, and soil water on grain yield of rice and sorghum under FBFS in Kisumu (Kenya) and Tigray (Ethiopia)."} -->


<!-- p1 <- list(p1) -->
<!-- p1$ncol=1 -->
<!-- p1$top = grid::textGrob( -->
<!-- "FC = farming constraint, H = High, M = Medium, L = Low, D = Drought risk, W = Waterlogging risk. The indices i, ii, iiii,  -->
<!-- respectively, indicate crop at initial, developement and late stages.", -->
<!--                         x=0, hjust=0, vjust = 0.5, -->
<!--                         gp = gpar(fontfamily=plots_font_family,fontsize=plot_font_size,fontface="italic", col="black")) -->
<!-- grid.newpage() -->
<!-- ga = do.call("grid.arrange", p1) -->
<!-- gb = grid.rect(.5,.5,width=unit(1,"npc"), height=unit(1,"npc"),  -->
<!--                gp=gpar(lwd=1, fill=NA, col="lightgray")) -->
<!-- g <- gTree(children = gList(ga, gb)) -->
<!-- grid.draw(g) -->

<!-- ggsave(plot=g, device='png', filename = "figures/Modelling_FBFS_grain_yield_violin_HIGH.png", width = max_plots_width_in,  -->
<!--        height=max_plots_height_in/1.5, units="in", dpi=min_plots_res -->
<!-- ) -->
<!-- ``` -->

Rice subjected to a high level of farming constraints during the initial and development stages seems insensitive to both water variation and changes in weed pressure. This may suggest that certain growth traits are affected by other forms of farming constraints than water and weeds, supporting the hypothesis of farming constraints during earlier growth being a major limitation to crop yield. However, controlling the level of pests & diseases, supported by good water supply, is likely to be conducive to better yield regardless of weed levels. This suggests that efforts to control pests and diseases would be more effective than weed removal, when conditions are harsh during the earlier stages of rice development. Under limited water conditions and increasing levels of pests & diseases, however, weed removal seems effective for improving grain yield in rice. This slight yield improvement seems to level off with better farm conditions at the development stage. These findings suggest possible rice-weed competition for water, which becomes irrelevant with better farm conditions. While weed removal generally improves rice grain yield, weeds are likely to have less of an effect when water is available, and pests and diseases are controlled. The effects of both weeds and pests & diseases seem to increase with increasing soil moisture.

In contrast to rice, sorghum grown under high farming constraints at the initial and development stages seems to respond to varying levels of water and weeds. While the crop is likely to have higher yields with non-limiting water supply, it seems more suitable for drier conditions when severe pest & disease effects are expected. However, in a situation of non-limited water supply, weed reduction only improves sorghum grain yield when the crop is exposed to strong pest & disease impact. These results suggest that healthy sorghum is likely to be tolerant to a certain level of weeds, but weed removal may improve water productivity, particularly when weed-sorghum competition for space is limited. Regardless of water conditions, improved farm management at the early stage seems to improve the effect of weed removal in sorghum, particularly when the level of pest & disease impact is minimal. With increased severity of pests & diseases, sorghum seems to no longer respond to weed reduction. This implies the possibility of some sort of synergistic effect between these biotic stresses. When farm conditions are better at the development stage, both non-limiting water supply and weed reduction improve the yield of sorghum. This suggests that sorghum is more likely than other crops to escape from the farming constraint trap with improved management at later stages. When farm conditions are better at both initial and development stages, wetter conditions seem better under minimal pest & disease pressure, whereas drier conditions are better in situations of severe pest and disease pressure. This supports the notion that moisture exacerbates the effect of pests & diseases. In situations of limited pest & disease impact, sorghum seems to respond to weed reduction only when water is limited. Under severe pest & disease pressure, however, the crop seems to improve with weed removal regardless of the water conditions. This supports the findings on the cumulative effect of farming constraints and suggests possible weed-sorghum competition for water.

# Discussion {#ref5}

The models presented in this paper navigate system complexity by breaking down a complex agricultural system into meaningful components, describing these components and bringing them together to provide a reasonable representation of the system. The participation of stakeholders and the inclusion of other relevant sources of information indicates that the model captured the necessary knowledge and can be used to support management decision in FBFS [@Krueger_et_al_2012; @Refsgaard_et_al_2007]. This is important for crop models aiming to support agricultural development interventions, which requires realistic models. Because such models are often used as guidance for decision making, they must include hard-to-measure aspects, which often require non-trivial measurement and analysis methods. In doing so, a crop model for FBFS cannot ignore the various social aspects, which are crucial for crop production. While such aspects can be easily overlooked during model development or impossible to include without an adequate approach, crop models for agricultural decision support need to consider the whole system and represent at least its most important factors. This requires the inclusion of knowledge from different disciplines which, in turn, requires participatory approaches. In general, the traditional scientific method consisting of formulating and testing hypotheses is not suitable in this context due to at least 3 main reasons:

1.	**System simplification:** To study a specific aspect, traditional scientific methods must simplify the systems via the use of some sort of sampling method where functions and processes can be easily tested. While this approach has the merit of providing detail and generating knowledge, it is limited in producing a sufficiently comprehensive representation of the system of interest.

2. **The need for studying isolated aspects:** Isolated processes and functions must be connected to provide a holistic system representation, in which case further uncertainty due to interactions between these aspects must not be omitted.

3. **Resource constraints:** Time and resources are almost always limited, restricting the options to study individual aspects of the systems in detail.

In attempting to guide decisions, crop models must recognize these aspects to make realistic recommendations based on the available information and resources. This means that such models must be framed in a way that allows the use of imperfect knowledge by the model. New knowledge and high-quality data constitute a means of reducing initial uncertainties, but they should not be a prerequisite to running a model in the first place. 

These points should neither imply that hard data are not necessary, nor obscure the importance of detailed studies on individual system functions and processes, but highlight the need for recognizing the unknowns and acknowledging the intrinsic uncertainties in estimating them. The present study arises in a context where hard data are mostly unavailable, whereas practitioners and a small community of advisers and researchers are knowledgeable about the system of interest. Knowledge on 11 key aspects was required to achieve a reasonable representation of the system that seemed sufficient for making reliable predictions of crop performance and production risks. While few of the hundreds of variables included in the model were directly targeted by the study, each variable is crucial in defining system behaviour, hence should not be ignored when attempting to provide an artificial representation of the system. Removing a single variable may change the behaviour of the whole system and the overall prediction outcome, because the productivity of FBFS results from the interaction of many factors, such as soil fertility, water, and agricultural management. 

Since the soil type is crucial for water supply (Figure \@ref(fig:fig6)), soil properties can be important for the stability of water supply under specific settings. Clay soils can retain large amounts of water. Coarse sediments (i.e. gravel or sand) have poor water holding capacity but benefit from finer components (i.e. silt and clay). Because coarse sediments tend to be deposited first, upstream soils are more likely to have low water retention than downstream soils.

A major concern for FBFS farmers is the uncertainty surrounding the magnitude and intensity of flooding [@Van_den_Ham_2008; @VanSteenbergen_et_al_2010]. Water supply in FBFS is not determined by soil type or rainfall alone but also by availability and management of agronomic flooding and soil fertility, along with the social organisation involved at various scales. Harmful consequences of water supply (e.g. drought, waterlogging) in a particular year can only be attenuated through adequate management. On soils with low water holding capacity (e.g. sandy soils), the use of groundwater, which is relatively shallow due to the recurrent floods, can be considered for drought management. Groundwater from shallow wells can also constitute an additional source of drinking water. While soil fertility management can improve soil water conditions, the erosive effect of floodwater should not be underestimated. Rich soils are often transported between farmers’ fields in the flood distribution network. The high risk of waterlogging on clayey and loamy soils can be addressed through limited tillage and enhanced soil organic matter content [@VanSteenbergen_et_al_2010]. 

The biomass produced in FBFS could be used to improve soil organic matter [@VanSteenbergen_et_al_2010], with two important challenges: restricted availability of crop residues due their use as fuel, and the lack of optimal interaction between crop and livestock. In many areas, crop residues are used as fuelwood for cooking with little returns of organic matter to the soil. This often results in reduced soil fertility, particularly in areas with limited fertilizer use. Livestock droppings constitute an important source of organic matter for FBFS, which serve as convenient post-harvest grazing areas. Where livestock pressure during such periods is high, treading can cause soil compaction. A possible management option could be the adoption of zero-grazing practices, where livestock are kept off-site and fed with crop residues, with manure subsequently transported back to the fields. This could be supplemented with composting to facilitate the decomposition of organic matter. Such innovations can have various effects on primary production at any crop development stage. Despite the high potential for biomass production, the net grain yield is strongly determined by farming constraints at the late stage of crop development (mainly pests and diseases; Figure \@ref(fig:fig10)), which are crucial in the FBFS of the study areas. The cumulative effect and variability of farming constraints across farmlands (Figure \@ref(fig:fig6); Figure \@ref(fig:fig8); Figure \@ref(fig:fig10)) stresses the importance of recognizing the complex web of processes that needs further investigation. Future research hypotheses can be centred on the nexus between four important aspects:

1.	Synergetic effects of different biotic stresses.

2.	Sensitivity of different crops to the joint effect of these stresses.

3.	Effect of water supply on different crops subjected to these stresses.

4.	Options for managing these stresses for particular crops. 

When such aspects are well understood, experiments can be conducted to assess the attainable yield under reduced farming constraints and set realistic targets for closing the yield gap. According to @Meng_et_al_2013, three important factors are generally responsible for yield gaps. The first factor is a mismatch between the local climatic conditions and the crop cultivar, which does not allow exploitation of the entire available growing period. Inadequate sowing dates and thus relatively short-duration crops, can lead to earlier harvests than would be ideal, often not leaving enough time for crops to complete grain filling. In China, 7-15% of yield losses have been attributed to harvest before physiological maturity [@Meng_et_al_2013]. Yield losses in FBFS are exacerbated by harvest and post-harvest losses due to a range of pests and diseases (Figure \@ref(fig:fig10)). In Kisumu for instance, rice farmers experience important losses due to bird attacks beside other limitations of high agricultural importance. Other less perceptible losses, such as those incurred due to harvesting technologies, or market opportunity losses due to the lack of storage facilities, contribute to low returns on agricultural investments [@VandenBerg_and_Singels_2013]. The second factor is related to the inadequacy of input allocation (e.g. inadequate water and nutrient supply). In Tigray, and to some extent also in Kisumu, few farmers are using recommended amounts of fertilizers, and many schemes are exposed to water shortage. The third major reason for yield shortfalls is poor management resulting in inadequate crop protection.

# Conclusion and policy recommendations

This paper presents a mixed modelling approach for forecasting yields in complex farming systems. Using the example of Flood-Based Farming Systems we build a model using simple building blocks and imperfect information. We demonstrate how simple probabilistic tools can be combined to make predictions based on different scenarios that account for variability across farmlands within a farming system. We show how intangible factors can be assessed for inclusion into the model and how such seemingly less important factors can have cumulative effects on model predictions. We argue that crop models aiming to support development interventions should not underestimate the complexity of the farming systems and find ways to account for all factors deemed important for the functioning of the whole farming system. The study highlights the importance of systems analysis and offers suggestions for integrating different types of data and modelling approaches into farming system models.

The findings suggest that addressing farming constraints to reduce yield gaps can double the current crop production in FBFS of the study areas. These constraints include aspects such as uncertainty in water supply, or the production risk due to biotic stresses.

Risk management related to uncertainty in floodwater availability is perhaps the most important concern in FBFS settings. While most studies are currently focusing on the water delivery at various topographic scales, development interventions should concentrate on optimizing the little available floodwater via the use of adequate soil and water conservation techniques. These techniques should consider the soil type, the floodwater delivery and its uncertainty in space and time (e.g. water source, water distribution networks, water acquisition structures), and more importantly, adequate management practices (e.g. improving soil organic matter) for keeping the desired amount of this water within the root zone. This highlights the importance of pre-season management.

The importance of floodwater often masks that of other aspects that can be as important as water supply. While we found little hard data on the biotic stresses in FBFS settings, we found that these stressors can severely affect biomass accumulation and jeopardize grain yield. The prevailing moisture conditions of FBFS aggravate the impacts of these biotic stresses, and synergistic effects between these stressors cause further damage. Crop protection in FBFS should be a continuous effort, with early control promising the greatest success.

In general, the effect of farming constraints accumulates over time to the extent that crops can get trapped in a situation of slow growth affecting biomass accumulation and ultimately grain yield. We suspect the existence of a certain threshold beyond which biomass accumulation is slowed down, and another threshold beyond which crop growth becomes negligible. Net grain yield was found to depend strongly on late-stage constraints, which are mostly related to biotic stresses.

In a nutshell, development policies should focus on sustainable water supply and crop protection. Research and development should concentrate on closing the current FBFS yield gap through the study of farming constraints that compromise primary production. More studies, preferably in the form of quantitative estimates, are needed on biotic stresses and the factors that aggravate their impact on crop production.

# Acknowledgements{-}

This study was funded by the Deutscher Akademischer Austauschdienst (DAAD) and the World Agroforestry Centre (ICRAF). We thank the farmers and experts who contributed in various ways during the development of the model. We thank the department of Dryland Agriculture of Mekelle University for guidance on the sampling frame in the Tigray region and for facilitating logistics during field work. Thanks to the participants of the leadership course in flood-based farming and water harvesting in Kenya and the participants of the International Training on Integrated Watershed Management and FBFS in Ethiopia, who drafted the models.

# References{-}

